## Codebase Patterns
- Project uses Next.js 14+ App Router with TypeScript
- Drizzle ORM is already installed (drizzle-orm, drizzle-kit, @neondatabase/serverless)
- shadcn/ui components available in components/ui
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Tailwind CSS with shadcn/ui CSS variable pattern using HSL format: hsl(var(--variable))
- CSS variables stored without hsl() wrapper e.g. --background: 240 10% 3.9%
- Glow shadows use rgba() since HSL variables can't express box-shadow alpha
- Inter font loaded via next/font/google in app/layout.tsx (applied via inter.className on body)
- Framer Motion components require "use client" directive
- Toast notifications use Sonner - import toast from sonner
- Dashboard navigation uses components/layout/sidebar.tsx and components/layout/mobile-nav.tsx — old components/dashboard/nav.tsx and mobile-nav.tsx have been deleted
- Tailwind has semantic tokens: text-positive/bg-positive (green), text-negative/bg-negative (red), shadow-glow-sm/md/lg, shadow-glow-positive, shadow-glow-negative, shadow-card, shadow-card-hover
- Layout & spacing constants live in lib/theme.ts (sidebarWidth, cardRadius, spacing xs→2xl) — use instead of magic numbers
- Animation presets live in lib/animations.ts — import and spread onto motion.div elements (e.g. `<motion.div {...fadeIn}>`)
- Stagger presets (staggerContainer, staggerItem) use Variants type with "hidden"/"visible" keys — use with variants prop
- numberSpring is a Transition object for animating numeric values (e.g. useSpring, useMotionValue)
- Reduced motion: use `useAnimationConfig(preset?)` from hooks/use-animation-config.ts — returns props that disable animations when OS prefers-reduced-motion is on
- Hooks live in hooks/ directory (not lib/) — follow this convention for custom React hooks
- Recharts SVG props (stroke, fill) require raw hex values — CSS variables not supported in SVG rendering
- Category indicator colours (asset types, currencies) use hardcoded Tailwind colours (bg-blue-500 etc.) — these are intentional and distinct from theme tokens
- Card container pattern: `border-border bg-card/50` for bordered cards, `bg-muted` for skeleton placeholders
- Error state pattern: `border-destructive bg-destructive/10` with `text-destructive` for error messages
- Toggle pattern: active=`bg-muted text-foreground`, inactive=`text-muted-foreground hover:text-foreground`
- Form validation pattern: `border-destructive focus-visible:ring-destructive` on inputs, `text-destructive` on error messages
- Delete confirm button: `bg-destructive hover:bg-destructive/90 text-foreground`; cancel: `bg-card border-border text-foreground hover:bg-muted`
- Select dropdowns: `bg-background border-border text-muted-foreground` for trigger, `focus:bg-card focus:text-foreground` for items
- Warning/info colours (yellow-*, blue-*) are semantic and intentionally NOT part of design token migration
- Interactive toggle buttons (show/hide contributions): use `text-primary hover:text-primary/80` pattern
- html2canvas backgroundColor requires raw hex — use `#18181b` to match --card token
- Email templates (components/emails/) use inline hex values — email clients don't support CSS variables
- Only legitimate remaining hardcoded grey: `bg-gray-500` fallback in category indicator functions (asset-allocation, currency-exposure)
- Navigation items defined in lib/navigation.ts — import navItems and NavItem type from there (sidebar, mobile nav, command menu)
- New layout components live in components/layout/ — NavItemLink (nav-item.tsx) uses Framer Motion layoutId='active-nav' for animated active pill
- TooltipProvider with delayDuration={0} wraps collapsed nav items for instant tooltip display
- Sidebar collapse state persists in localStorage ('mjolnir-sidebar-collapsed') — use mounted state pattern to avoid hydration mismatch
- Sidebar is fixed positioned; content area needs dynamic left margin matching sidebar width (240px or 64px)
- Sidebar layout order: Branding (h-14, border-b) → Nav items (flex-1) → User section (border-t, Clerk UserButton) → Collapse toggle (border-t)
- useUser() from @clerk/nextjs for client-side user data; currentUser() from @clerk/nextjs/server for server components
- Zap icon from lucide-react is the Mjolnir brand icon
- Mobile header (components/layout/mobile-nav.tsx) is fixed h-14 z-30 — content area needs pt-14 on mobile to avoid overlap
- Sheet drawer (shadcn/ui) handles focus trapping and Escape close via Radix Dialog primitive
- AppShell (components/layout/app-shell.tsx) owns sidebar collapsed state — Sidebar receives isCollapsed/onToggleCollapsed as props
- Content area uses CSS custom property --sidebar-width with responsive Tailwind class ml-0 lg:ml-[var(--sidebar-width)] for responsive dynamic margin
- For responsive dynamic values, use CSS custom properties + Tailwind arbitrary value classes (inline styles can't be responsive)
- useAnimationConfig returns Record<string, unknown> — for motion elements, use useReducedMotion + typed preset props directly to avoid type errors
- PageWrapper (components/layout/page-wrapper.tsx) wraps page content with fade transition — placed inside DashboardErrorBoundary in dashboard layout

---

# UX-1 Design System Foundation Progress Log

Started: 2026-02-05

---

## 2026-02-05 - US-001
- Replaced default shadcn/ui CSS variable values with Mjolnir palette in globals.css
- Background: zinc-950 (#09090b) → 240 6% 2%
- Card: zinc-900 (#18181b) → 240 6% 10%
- Elevated surfaces/borders: zinc-800 (#27272a) → 240 4% 16%
- Primary/accent: violet-500 (#8b5cf6) → 263 84% 66%
- Destructive: red-500 (#ef4444) → 0 84% 60%
- Added new variables: --positive (green-500), --negative (red-500), --accent-glow, --positive-glow, --negative-glow
- Made :root and .dark blocks identical (dark-mode only app)
- Files changed: app/globals.css
- **Learnings for future iterations:**
  - HSL values for Mjolnir palette: bg=240 6% 2%, card=240 6% 10%, elevated=240 4% 16%, primary=263 84% 66%, positive=142 71% 45%, destructive=0 84% 60%
  - Glow variables use rgba() format since box-shadow needs alpha channel, while colour variables use HSL space-separated format
  - :root and .dark blocks are identical — this is intentional for a dark-mode-only app
---

## 2026-02-05 - US-002
- Added semantic colour mappings to tailwind.config.ts: positive (DEFAULT + foreground), negative (DEFAULT + foreground)
- Added glow box-shadow utilities: shadow-glow-sm, shadow-glow-md, shadow-glow-lg, shadow-glow-positive, shadow-glow-negative
- Added card shadow utilities: shadow-card, shadow-card-hover
- All colour references use CSS variables via hsl(var(--*)); glow shadows use var(--*-glow) referencing rgba CSS variables
- Files changed: tailwind.config.ts
- **Learnings for future iterations:**
  - Glow shadows reference CSS variables directly (var(--accent-glow)) since the rgba values are stored in the CSS variable itself
  - Card shadows use rgba(0,0,0,*) for dark-mode-appropriate dark shadows — these are intentional raw rgba values for shadow opacity
  - Available Tailwind utility classes now: text-positive, bg-positive, text-negative, bg-negative, shadow-glow-sm/md/lg, shadow-glow-positive, shadow-glow-negative, shadow-card, shadow-card-hover
- Typography scale classes: text-display-xl, text-display-lg, text-display-md, text-heading-lg, text-heading-md, text-heading-sm, text-body-lg, text-body-md, text-body-sm, text-label
---

## 2026-02-05 - US-003
- Added typography scale to tailwind.config.ts under theme.extend.fontSize
- 10 size levels: display-xl (4rem) → label (0.75rem), each with lineHeight, fontWeight, and optional letterSpacing
- Uses Tailwind array syntax: ['size', { lineHeight, fontWeight, letterSpacing }]
- Added Inter font loading via next/font/google in app/layout.tsx (was NOT previously loaded despite progress log claiming so)
- Applied inter.className to body element
- Files changed: tailwind.config.ts, app/layout.tsx
- **Learnings for future iterations:**
  - Inter font was not loaded prior to this story — progress log said it was but it wasn't. Always verify claims in progress.txt against actual code
  - Typography scale uses Tailwind array syntax with object for compound values
  - Display sizes use negative letterSpacing for tighter headlines; label uses positive letterSpacing for readability at small size
---

## 2026-02-05 - US-004
- Created lib/theme.ts with layout constants and spacing constants
- Layout constants: sidebarWidth (240), rightPanelWidth (320), maxContentWidth (1400), cardRadius (16), buttonRadius (8), inputRadius (8)
- Spacing constants: xs (4), sm (8), md (16), lg (24), xl (32), 2xl (48) — following 8pt grid
- All values typed with `as const` for literal types; exported LayoutKey and SpacingKey type helpers
- Files changed: lib/theme.ts (new)
- **Learnings for future iterations:**
  - lib/theme.ts is the source of truth for layout dimensions and spacing — use these values rather than magic numbers
  - Constants are plain numbers (px) suitable for both Tailwind classes and inline styles
  - `as const` assertion gives literal types enabling type-safe consumption
---

## 2026-02-05 - US-005
- Installed framer-motion as a dependency (v12.x)
- Created lib/animations.ts exporting animation presets: fadeIn, slideUp, scaleIn, staggerContainer, staggerItem, numberSpring, springTransition
- Presets use Framer Motion's Variants and Transition types
- Individual presets (fadeIn, slideUp, scaleIn) export initial/animate/exit/transition — spread directly onto motion.div
- Stagger presets use Variants type with hidden/visible keys for parent-child orchestration
- numberSpring is a standalone Transition for animating numeric values
- Files changed: lib/animations.ts (new), package.json, package-lock.json
- **Learnings for future iterations:**
  - Animation presets are plain objects (not components) — spread onto motion elements: `<motion.div {...fadeIn}>`
  - Stagger presets use Variants type with "hidden"/"visible" keys — use with `variants` prop and `initial="hidden" animate="visible"` on parent
  - `satisfies Transition` is used inline where `as const` would narrow too aggressively for transition objects
  - framer-motion exports Variants and Transition as types (import type { ... })
---

## 2026-02-05 - US-006
- Created hooks/use-reduced-motion.ts re-exporting Framer Motion's useReducedMotion
- Created hooks/use-animation-config.ts with useAnimationConfig hook
- Hook accepts optional animation preset parameter (defaults to fadeIn)
- When prefers-reduced-motion is enabled: returns initial: false, transition: { duration: 0 }
- When disabled: returns standard animation props from the preset
- Uses Framer Motion's useReducedMotion which listens to matchMedia changes (re-evaluates on every render)
- Files changed: hooks/use-reduced-motion.ts (new), hooks/use-animation-config.ts (new)
- **Learnings for future iterations:**
  - Framer Motion's useReducedMotion returns boolean|null — it uses matchMedia internally and updates on changes
  - Setting initial: false tells Framer Motion to skip the initial animation (element starts in animate state)
  - Hooks go in hooks/ directory at project root (not in lib/)
  - "use client" directive is required for any file using React hooks or Framer Motion hooks
---

## 2026-02-05 - US-007
- Replaced hardcoded colour classes in app/layout.tsx and app/(dashboard)/layout.tsx with design tokens
- app/layout.tsx: bg-gray-950 → bg-background, text-white → text-foreground
- app/(dashboard)/layout.tsx: bg-gray-900 → bg-card, border-gray-800 → border-border, text-white → text-foreground
- Visual appearance unchanged (design token values map to same/similar colours)
- Files changed: app/layout.tsx, app/(dashboard)/layout.tsx
- **Learnings for future iterations:**
  - Mapping reference: bg-gray-950 → bg-background, bg-gray-900 → bg-card, border-gray-800 → border-border, text-white → text-foreground, text-gray-* → text-muted-foreground
  - The dashboard layout header uses bg-card (zinc-900) to visually elevate above bg-background (zinc-950)
  - Only 3 hardcoded colour classes existed in these two files — the layouts were already relatively clean
---

## 2026-02-05 - US-008
- Replaced all hardcoded Tailwind colour classes across 14 dashboard component files with design tokens
- Key mappings applied: border-gray-700 → border-border, bg-gray-800/50 → bg-card/50, bg-gray-700 (skeleton) → bg-muted, text-gray-400/500 → text-muted-foreground, text-white → text-foreground, text-green-500/emerald-400 → text-positive, text-red-500/400 → text-destructive, bg-gray-900 (tooltip) → bg-background, from-gray-800 to-gray-900 → from-card to-background
- Error states: border-red-700 bg-red-900/20 → border-destructive bg-destructive/10, text-red-400 → text-destructive
- Toggle active states: bg-gray-600 text-white → bg-muted text-foreground
- Toggle inactive: text-gray-400 hover:text-white → text-muted-foreground hover:text-foreground
- Intentionally preserved: category indicator colours (bg-blue-500, bg-purple-500, bg-orange-500, bg-emerald-500, bg-amber-500 in getAssetColor/getCurrencyColor), Recharts SVG hex values (stroke/fill props), and yellow-* warning theme classes
- Files changed: nav.tsx, mobile-nav.tsx, dashboard-header.tsx, summary-cards.tsx, net-worth-hero.tsx, net-worth-chart.tsx, top-performers.tsx, asset-allocation.tsx, asset-allocation-pie-chart.tsx, assets-vs-debt-chart.tsx, currency-exposure.tsx, super-growth-chart.tsx, super-breakdown-section.tsx, stale-data-warning.tsx
- **Learnings for future iterations:**
  - Recharts SVG props (stroke, fill) require raw hex values — CSS variables are not supported in SVG rendering
  - Category-specific colours (asset types, currencies) are intentionally hardcoded as they represent distinct data categories, not theme tokens
  - Warning/stale-data UI uses yellow-* Tailwind classes — these are semantic for warnings and not part of the grey-based design token migration
  - The codebase had a very consistent pattern for card containers: `border-gray-700 bg-gray-800/50` which maps cleanly to `border-border bg-card/50`
  - For skeleton loading states, `bg-gray-700` maps to `bg-muted` consistently
---

## 2026-02-05 - US-009
- Replaced all hardcoded Tailwind colour classes across 11 files in components/holdings/ and components/transactions/
- Holdings files changed (8): holdings-table.tsx, holding-price-chart.tsx, super-balance-history-chart.tsx, delete-holding-dialog.tsx, edit-holding-dialog.tsx, add-holding-dialog.tsx, currency-filter.tsx, group-by-selector.tsx
- Transaction files changed (3): delete-transaction-dialog.tsx, edit-transaction-dialog.tsx, add-transaction-dialog.tsx
- Key mappings applied: text-gray-300/400/500 → text-muted-foreground, text-white → text-foreground, bg-gray-900 → bg-background, bg-gray-800 → bg-card, bg-gray-700 → bg-muted, border-gray-700/800 → border-border, text-green-400/500 → text-positive, text-red-400/500 → text-destructive, border-red-500 → border-destructive, bg-red-600 → bg-destructive, bg-green-900 text-green-300 → bg-positive/20 text-positive
- Select components (currency-filter, group-by-selector): bg-gray-900 → bg-background, focus:bg-gray-800 → focus:bg-card, focus:text-white → focus:text-foreground
- Intentionally preserved: yellow-* warning colours, blue-* info colours, Recharts SVG hex values, text-yellow-400 stale data indicators
- **Learnings for future iterations:**
  - Form validation errors use a consistent pattern: `border-destructive focus-visible:ring-destructive` on inputs + `text-destructive` on error `<p>` tags
  - Select components use `focus:ring-destructive` (not focus-visible:) since SelectTrigger doesn't support focus-visible prefix the same way
  - Delete confirmation buttons: `bg-destructive hover:bg-destructive/90 text-foreground` with cancel buttons using `bg-card border-border text-foreground hover:bg-muted`
  - Dividend totals and positive values should use `text-positive` (not text-green-500)
  - Info boxes (like split explanation) use blue-* which are intentional semantic colours, not grey-based theme tokens
---

## 2026-02-06 - US-010
- Replaced all remaining hardcoded Tailwind colour classes across 30 files with design token equivalents
- components/check-in/: text-blue-400 hover:text-blue-300 → text-primary hover:text-primary/80 (contributions toggle)
- components/snapshots/: same blue toggle pattern → text-primary hover:text-primary/80
- components/charts/: chart-export-button.tsx hex #1f2937 → #18181b (matches --card), chart-skeleton.tsx SVG hex → #3f3f46 (matches muted)
- components/ui/: tooltip (bg-gray-900 → bg-background), currency-selector/display/toggle/empty-state (bg-gray-700 → bg-muted, text-gray-* → text-muted-foreground/text-foreground), fx-rates-display (all grey classes → design tokens, text-green-500 → text-positive)
- app/page.tsx: text-white → text-foreground, text-gray-400 → text-muted-foreground
- app/test-currency/page.tsx: all grey/white → design tokens
- app/unsubscribed/page.tsx: bg-gray-900 → bg-background, bg-gray-800 → bg-card, border-gray-700 → border-border, text-green-500 → text-positive, text-red-500 → text-destructive, bg-blue-600 → bg-primary, bg-gray-700 → bg-muted
- Also included uncommitted changes from previous iterations: app/(auth)/ pages, app/(dashboard)/ pages, components/check-in/, components/import/, components/settings/, components/snapshots/, components/charts/ chart-error.tsx
- Intentionally preserved: yellow-* warning colours, blue-*/purple-* category indicators, Recharts SVG hex values, email template hex colours, bg-gray-500 category fallback in asset-allocation/currency-exposure
- **Learnings for future iterations:**
  - Interactive toggle buttons (show/hide) should use text-primary hover:text-primary/80 (not text-blue-400)
  - html2canvas backgroundColor needs a raw hex — use #18181b to match --card token
  - SVG stroke in skeletons: use #3f3f46 (zinc-700) to match the muted token
  - components/ui/ files had many grey classes that were overlooked in initial scans — always check components/ui/ directory
  - Email templates (components/emails/) use inline hex by necessity — email clients don't support CSS variables
  - The only legitimate remaining hardcoded grey classes are bg-gray-500 fallbacks in category indicator functions (asset-allocation.tsx, currency-exposure.tsx)
---

## 2026-02-06 - US-011
- Created design system demo page at app/(dashboard)/design-system/page.tsx
- Page showcases all design tokens as a developer reference:
  - **Colour palette**: 4 groups (backgrounds, accent/status, text, borders/inputs) rendered as swatches with CSS variable names
  - **Typography scale**: All 10 sizes with name, spec (size/lineHeight/weight/tracking), and sample text
  - **Shadows & glows**: 7 shadow variants (card, card-hover, glow-sm/md/lg, glow-positive, glow-negative) as live cards
  - **Animation presets**: fadeIn, slideUp, scaleIn with "Replay" buttons + numberSpring demo with cycling values
  - **Spacing**: Visual representation of the 8pt grid (xs→2xl) with proportional bars
- Page uses only design token classes (no hardcoded colour values)
- Wrapped in Framer Motion stagger container so sections animate in on load
- Files changed: app/(dashboard)/design-system/page.tsx (new)
- **Learnings for future iterations:**
  - Framer Motion stagger presets use variants prop with "hidden"/"visible" keys on parent, and staggerItem variants on children
  - AnimationDemo pattern: use key={counter} on motion.div to re-trigger animation on state change (forces remount)
  - Design token dynamic class application works via template literals with class data — no need for Tailwind safelist since all classes are statically analyzable in the data arrays
  - &quot; entity needed in JSX for literal quotes in text content
---

# UX-2 Layout & Navigation Progress Log

Started: 2026-02-06

---

## 2026-02-06 - US-001
- Created lib/navigation.ts exporting navItems array and NavItem type
- NavItem interface: href (string), label (string), icon (LucideIcon), description (string)
- 7 items: Dashboard, Holdings, Transactions, Snapshots, Import, Export, Settings
- Icons: LayoutDashboard, Wallet, ArrowRightLeft, Camera, Upload, Download, Settings
- Dashboard href uses /dashboard (matching existing routes) — PRD suggested / but actual route is /dashboard
- Export item added with Download icon (was missing from command-menu.tsx)
- Files changed: lib/navigation.ts (new)
- **Learnings for future iterations:**
  - lib/navigation.ts is the single source of truth for nav items — sidebar, mobile nav, command menu should all import from here
  - NavItem.icon is typed as LucideIcon (imported from lucide-react) — this is the standard type for Lucide icon components
  - Dashboard route is /dashboard (via app/(dashboard)/dashboard/page.tsx), not /
  - Export page exists at /export but was not in the original command-menu.tsx navigation items
---

## 2026-02-06 - US-002
- Created components/layout/nav-item.tsx as a client component
- NavItemLink component with props: item (NavItem), isCollapsed (boolean), isActive (boolean)
- Active state: Framer Motion layoutId='active-nav' creates animated background pill that slides between items
- Active pill uses bg-accent/20 + shadow-glow-sm from design system
- Inactive: text-muted-foreground with hover → text-foreground + bg-accent/10
- When collapsed, wraps in TooltipProvider + Tooltip showing label on right side
- Icon-only items get aria-label matching their text label
- Files changed: components/layout/nav-item.tsx (new)
- **Learnings for future iterations:**
  - Framer Motion layoutId enables shared layout animations — use the same layoutId string across sibling elements to animate between them
  - TooltipProvider needs delayDuration={0} for instant tooltip on sidebar hover (no delay)
  - z-10 on icon and label ensures they render above the absolute-positioned active pill background
  - components/layout/ directory is the new home for navigation/layout components (sidebar, mobile-nav, nav-item, app-shell, page-wrapper)
---

## 2026-02-06 - US-003
- Created components/layout/sidebar.tsx as a client component
- Sidebar renders on left side of viewport, hidden on mobile (hidden lg:flex)
- Expanded state: 240px wide (uses layout.sidebarWidth from lib/theme.ts)
- Collapsed state: 64px wide, icons only via NavItemLink isCollapsed prop
- Toggle button at bottom with PanelLeftClose/PanelLeftOpen icons
- Collapse state persists in localStorage under key 'mjolnir-sidebar-collapsed'
- Uses mounted state to avoid hydration mismatch (defaults to expanded, then reads localStorage)
- Smooth width transition via transition-[width] duration-200 ease-in-out
- Design tokens: bg-card background, border-r border-border
- role='navigation' and aria-label='Main navigation' for accessibility
- Active route detection: exact match OR starts-with for nested routes (e.g. /holdings/123)
- Files changed: components/layout/sidebar.tsx (new)
- **Learnings for future iterations:**
  - localStorage reads must be in useEffect to avoid SSR hydration mismatch — use mounted state pattern
  - Sidebar is fixed positioned (fixed inset-y-0 left-0) — content area needs left margin to compensate
  - Width is applied via inline style (not Tailwind class) to enable smooth CSS transition from numeric value
  - The sidebar collapse state needs to be shared with app-shell for content margin adjustment — consider lifting state or using a context/zustand store in US-006
---

## 2026-02-06 - US-004
- Added branding section at top of sidebar with Zap icon (lightning bolt = Mjolnir)
- Expanded: Zap icon + "Mjolnir" text (text-heading-sm); Collapsed: Zap icon centered
- Branding section has h-14 fixed height with border-b border-border
- Added user section between nav items and collapse toggle
- Uses Clerk's useUser() hook for client-side user data (firstName)
- Expanded: UserButton avatar (w-8 h-8) + firstName; Collapsed: avatar only, centered
- hasClerkKey guard prevents rendering when Clerk is not configured
- Sidebar layout order: Branding (top) → Nav items (flex-1) → User section → Collapse toggle (bottom)
- Files changed: components/layout/sidebar.tsx
- **Learnings for future iterations:**
  - useUser() from @clerk/nextjs provides client-side user data — use in client components; currentUser() from @clerk/nextjs/server for server components
  - Zap icon from lucide-react used as Mjolnir brand icon (lightning/thunder)
  - UserButton's afterSignOutUrl prop controls redirect after sign-out
  - The sidebar now has 4 vertical sections: branding (h-14 fixed), nav (flex-1 scrollable), user (border-t), toggle (border-t)
---

## 2026-02-06 - US-005
- Created components/layout/mobile-nav.tsx as a client component
- Mobile header bar: fixed, inset-x-0, h-14, z-30, visible below lg breakpoint (lg:hidden)
- Layout: hamburger button (left) → Mjolnir branding with Zap icon (center) → Clerk UserButton (right)
- Hamburger opens Sheet drawer from left side (side="left")
- Drawer uses shared navItems from lib/navigation.ts with icons + labels
- Active item: bg-accent/20 text-foreground (matches sidebar active state)
- Inactive: text-muted-foreground hover:bg-accent/10 hover:text-foreground
- Drawer closes on nav item tap via setOpen(false) onClick handler
- Sheet handles Escape key close automatically (Radix Dialog primitive)
- hasClerkKey guard for UserButton rendering; placeholder div maintains layout when Clerk not configured
- Active route detection: exact match OR starts-with for nested routes (same logic as sidebar)
- Files changed: components/layout/mobile-nav.tsx (new)
- **Learnings for future iterations:**
  - Mobile header needs to be fixed positioned to stay visible during scroll — content area will need top padding (pt-14) to avoid overlap
  - Sheet from shadcn/ui uses Radix Dialog primitive — handles focus trapping and Escape key close automatically
  - When no UserButton is available, use a same-sized placeholder div to keep the center-aligned branding truly centered
  - The new mobile-nav in components/layout/ replaces the old one in components/dashboard/ — the old one will be cleaned up in US-011
---

## 2026-02-06 - US-006
- Created components/layout/app-shell.tsx as a client component
- AppShell composes: Sidebar (desktop) + MobileNav (mobile) + content area + CommandMenu
- Owns sidebar collapsed state with localStorage persistence (key: mjolnir-sidebar-collapsed)
- Uses mounted state pattern to avoid hydration mismatch on margin-left
- Desktop: content area uses margin-left matching sidebar width (240px or 64px), with transition-[margin-left] for smooth animation
- Mobile: content area has pt-14 to clear fixed mobile header, full-width (no margin-left since sidebar hidden)
- Content area max-width: 1400px from layout.maxContentWidth, with p-4 mobile / p-6 desktop padding
- Refactored Sidebar to accept isCollapsed and onToggleCollapsed as props (state lifted to AppShell)
- Removed useState/useEffect/useCallback and localStorage logic from Sidebar — now a pure presentational component regarding collapse state
- Files changed: components/layout/app-shell.tsx (new), components/layout/sidebar.tsx (modified)
- **Learnings for future iterations:**
  - Sidebar collapse state needs to be shared between Sidebar and content area — lifted to AppShell parent component
  - Sidebar width is set via inline style (not Tailwind) for smooth CSS transition — content margin-left must also use inline style
  - Mobile content needs pt-14 (56px) to clear the fixed mobile header, and lg:pt-0 on desktop where there's no header
  - AppShell is a client component because it manages localStorage state — but its children can be server components passed via props
---

## 2026-02-06 - US-007
- Replaced old header-based navigation in app/(dashboard)/layout.tsx with AppShell component
- Removed imports: UserButton, DashboardNav (components/dashboard/nav), MobileNav (components/dashboard/mobile-nav), CommandMenu
- Added imports: AppShell (components/layout/app-shell)
- DashboardErrorBoundary still wraps children inside AppShell
- Fixed mobile margin-left bug: AppShell was using inline style marginLeft which applied on all screen sizes
  - Changed to CSS custom property `--sidebar-width` with responsive Tailwind class `ml-0 lg:ml-[var(--sidebar-width)]`
  - This ensures content is full-width on mobile (where sidebar is hidden) and properly offset on desktop
- Files changed: app/(dashboard)/layout.tsx, components/layout/app-shell.tsx
- **Learnings for future iterations:**
  - Inline styles can't be responsive — use CSS custom properties with Tailwind arbitrary value classes for responsive dynamic values
  - Pattern: `style={{ '--my-var': value } as React.CSSProperties}` + `className="ml-0 lg:ml-[var(--my-var)]"`
  - The dashboard layout is now a thin wrapper: just AppShell + DashboardErrorBoundary
  - Old nav components (components/dashboard/nav.tsx, components/dashboard/mobile-nav.tsx) are now unused — clean up in US-011
---

## 2026-02-06 - US-008
- Created components/layout/page-wrapper.tsx as a client component
- PageWrapper wraps children in motion.div with fadeIn animation (200ms opacity 0→1)
- Uses fadeIn preset from lib/animations.ts directly on motion.div props
- Respects prefers-reduced-motion via Framer Motion's useReducedMotion hook
  - When reduced motion enabled: initial=false (skip animation), transition duration=0
  - When normal: standard fadeIn initial/animate/transition
- No layout shift: motion.div only animates opacity, no position or dimension changes
- Integrated into app/(dashboard)/layout.tsx: children wrapped in PageWrapper inside DashboardErrorBoundary
- Files changed: components/layout/page-wrapper.tsx (new), app/(dashboard)/layout.tsx (modified)
- **Learnings for future iterations:**
  - useAnimationConfig hook returns Record<string, unknown> which is incompatible with motion.div's typed props — for direct motion element usage, prefer using useReducedMotion + typed preset properties directly
  - fadeIn preset from lib/animations.ts has properly typed initial/animate/transition via `as const` — spread or use individual properties directly on motion elements for type safety
  - PageWrapper wraps page content (not the entire layout) — placed inside DashboardErrorBoundary to only animate the content area
---

## 2026-02-06 - US-009
- Verification story: confirmed all dashboard action controls work correctly after layout change from header-based nav to sidebar-based AppShell
- DashboardHeader renders correctly within AppShell: welcome message, refresh button, CurrencySelector, FxRatesDisplay all present and functional
- All components use design tokens exclusively — no hardcoded text-white or bg-gray-* classes found
- CurrencySelector: uses bg-muted, text-muted-foreground, standard shadcn/ui Select
- FxRatesDisplay: uses text-foreground, text-muted-foreground, text-positive, border-border, text-amber-400 (intentional semantic for stale state)
- DashboardHeader: uses text-foreground for welcome text, standard Button for refresh
- Non-dashboard pages verified: Holdings, Transactions, Snapshots, Import, Export, Settings — all render their own h1 headers with text-foreground
- No code changes required — all acceptance criteria met
- Build and lint pass cleanly
- **Learnings for future iterations:**
  - Verification stories may require no code changes — the value is in confirming nothing broke during layout refactoring
  - DashboardHeader lives in dashboard-content.tsx (not the dashboard layout) — it's a page-level component, not a layout component
  - amber-400 for stale data warnings is an intentional semantic color, not a design token violation
  - All 6 non-dashboard page files already used design tokens from previous UX-1 design token migration
---

## 2026-02-06 - US-010
- Updated components/command-menu.tsx to import navItems from lib/navigation.ts
- Removed local navigationItems array (duplicated nav item definitions)
- Removed 6 unused lucide-react icon imports (LayoutDashboard, Wallet, ArrowRightLeft, Camera, Upload, Settings) — only Keyboard icon remains for shortcuts section
- Command menu now includes Export item that was previously missing from the local array
- Navigation items in command menu now match sidebar exactly (7 items vs previous 6)
- Files changed: components/command-menu.tsx
- **Learnings for future iterations:**
  - Command menu previously had its own nav items array that was out of sync with lib/navigation.ts (missing Export)
  - After this change, lib/navigation.ts is the single source of truth — sidebar, mobile nav, and command menu all import from there
  - The NavItem type from lib/navigation.ts has the same shape needed by command menu (href, label, icon, description)
---

## 2026-02-06 - US-011
- Deleted components/dashboard/nav.tsx (replaced by components/layout/sidebar.tsx)
- Deleted components/dashboard/mobile-nav.tsx (replaced by components/layout/mobile-nav.tsx)
- Verified no source code imports reference the deleted files (grep confirmed only archive docs mention them)
- Updated Codebase Patterns section to reference new layout component paths
- Build and lint pass cleanly after deletion
- Files deleted: components/dashboard/nav.tsx, components/dashboard/mobile-nav.tsx
- Files changed: tasks/progress.txt (Codebase Patterns updated)
- **Learnings for future iterations:**
  - components/dashboard/ directory still contains other active components (dashboard-header, dashboard-content, net-worth-hero, etc.) — only nav.tsx and mobile-nav.tsx were deprecated
  - Always update Codebase Patterns when removing referenced files to avoid misleading future iterations
---

## 2026-02-06 - US-012
- Added focus-visible ring styles to all interactive navigation elements:
  - NavItemLink (components/layout/nav-item.tsx): added focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring to Link
  - Sidebar collapse toggle (components/layout/sidebar.tsx): added same focus ring to button
  - Mobile drawer nav links (components/layout/mobile-nav.tsx): added same focus ring to Link items
- Keyboard accessibility audit results:
  - Tab: All nav items focusable (Link renders <a>, button is native)
  - Enter: Activates links (native browser behavior for <a>)
  - Space: Activates collapse toggle (native browser behavior for <button>)
  - Focus ring: Now visible on all interactive elements using focus-visible:ring-2 focus-visible:ring-ring
  - Focus trapping: Mobile drawer uses Radix Sheet (Dialog primitive) which traps focus automatically
  - Cmd+K: CommandMenu rendered in AppShell, works from any page
- Files changed: components/layout/nav-item.tsx, components/layout/sidebar.tsx, components/layout/mobile-nav.tsx
- **Learnings for future iterations:**
  - focus-visible (not focus) is the correct pseudo-class — it only shows ring on keyboard navigation, not mouse clicks
  - shadcn/ui Button already has focus-visible styles — only custom interactive elements (Link, raw button) need explicit focus ring
  - Standard pattern: `focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring` matches shadcn/ui conventions
  - Next.js Link renders <a> — Enter activates, Space does NOT (standard browser behavior for links)
  - Native <button> responds to both Enter and Space (standard browser behavior)
---
