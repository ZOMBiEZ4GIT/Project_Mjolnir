# Ralph Progress Log — B6: Budget Polish & Mobile
# This file is reset at the start of each epic.

## Codebase Patterns
- PeriodSelector touch targets: p-2.5 gives ~40px which meets iOS minimum (was p-1 = ~28px)
- AIRecommendationButton uses `hidden sm:inline` / `sm:hidden` pattern for responsive button text
- Budget dashboard uses responsive gaps: `gap-3 sm:gap-4` pattern
- Category cards grid: `grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4`
- Container padding: `px-3 sm:px-4 py-6 sm:py-8` for mobile-friendly spacing
- MobileBudgetChart already has `active:bg-card/50` for touch feedback — use same on CategoryCard
- Mobile transaction list: use card layout (sm:hidden) + table (hidden sm:block) dual rendering pattern
- Mobile filter panel: SlidersHorizontal icon button with badge count, expandable panel with full-width inputs
- Select items on mobile need py-2.5 for touch-friendly tap targets
- CategoryBadge touch: h-8 sm:h-7 for mobile/desktop, active:bg-accent/20 for press feedback
- Refresh button pattern: refetch() from useQuery + isFetching for spin animation
- TransactionSearch: debounced search component with local state + useEffect sync for external value resets
- CategoryManager: ICON_REGISTRY maps Lucide icon names → components for dynamic rendering in category CRUD
- Category slug auto-generation: lowercase name → replace non-alphanumeric with hyphens → trim hyphens
- Reorder via sort_order swap: fetch both categories, swap sortOrder values, call PUT for each
- SpendingTrends: ComposedChart with dynamic category keys spread as data fields, Bar components mapped from allCategories array
- Mixed bar/line legend: w-4 h-0.5 line indicator for Line series, w-2.5 h-2.5 rounded-sm square for Bar series
- Design token mapping: emerald→text-positive/bg-positive, red→text-destructive/bg-destructive, amber→text-warning/bg-warning, purple→bg-primary
- Chart hex colours and colour picker palettes are exempt from token migration — they need literal hex for SVG/canvas
- Nested nav: NavItem.children[] for sub-sections; sidebar uses collapsible group with ChevronDown, mobile uses same pattern
- Command menu: flatten children with `parent → child` label format so all pages are searchable
- Active state for nested nav: exact match for parent route (/budget), startsWith for sub-routes (/budget/transactions)

---

## 2026-02-08 - B6-001
- What was implemented: Mobile-optimised budget dashboard for 320px-768px viewports
- Files changed:
  - app/(dashboard)/budget/page.tsx — responsive header, gaps, grids, container padding
  - components/budget/PeriodSelector.tsx — enlarged touch targets (p-1 → p-2.5), removed fixed min-w-[180px]
  - components/budget/AIRecommendationButton.tsx — responsive text (shorter on mobile)
  - components/budget/CategoryCard.tsx — added active:bg-card/50 touch feedback
- **Learnings for future iterations:**
  - The dashboard already has good responsive foundations (dual chart approach, md: breakpoints)
  - PeriodSelector was the biggest mobile issue — p-1 padding on nav buttons was too small
  - AIRecommendationButton text like "Get AI Recommendation" is too long for small screens — use hidden/shown span pairs
  - Category cards were grid-cols-2 on all small screens — single column works better below sm:
  - PaydayCountdown and SavingsIndicator already stack via grid-cols-1 md:grid-cols-2 — no changes needed
---

## 2026-02-08 - B6-002
- What was implemented: Mobile-optimised transaction list with card layout, collapsible filters, and refresh button
- Files changed:
  - app/(dashboard)/budget/transactions/page.tsx — complete mobile overhaul
- **Key changes:**
  - Mobile card layout (TransactionCard component) replaces table below sm: breakpoint — shows description, amount, short date, HELD badge, and category selector
  - Desktop table retained for sm+ with status column now hidden below md: (was sm:)
  - Filter bar collapses to SlidersHorizontal icon button on mobile — expands a bordered panel with full-width inputs
  - Active filter count badge on the filter button when collapsed
  - Search input is full-width on mobile (flex-1)
  - Visible RefreshCw button in header with spinning animation during fetch
  - Container padding and heading sizes responsive: px-3 sm:px-4, text-xl sm:text-2xl
  - CategoryBadge touch-optimised: h-8 on mobile (h-7 desktop), active:bg-accent/20 for press feedback
  - Select dropdown items padded to py-2.5 for touch targets
  - Pagination text shortened: "Prev" on mobile, "Previous" on desktop
  - formatDateShort() added for mobile cards (no year)
- **Learnings for future iterations:**
  - Tables are unsuitable for 320px viewports — always use card/list pattern for mobile with hidden sm:block for the table
  - Defining DesktopFilterBar + MobileFilterPanel as separate components avoids deeply nested conditionals
  - isFetching (not isLoading) is needed for refresh spinner — isLoading is only true on first load
  - Filter count badge (activeFilterCount) provides visual affordance that filters are active when panel is collapsed
---

## 2026-02-08 - B6-003
- What was implemented: Debounced transaction search component with 300ms delay
- Files changed:
  - components/budget/TransactionSearch.tsx — new component with debounced input, clear button, search icon
  - app/(dashboard)/budget/transactions/page.tsx — replaced form-based search with TransactionSearch, updated result count text
- **Key changes:**
  - TransactionSearch manages its own local state with useEffect sync from external value (for "clear all filters")
  - 300ms debounce via setTimeout/clearTimeout in useRef — fires onChange to parent after delay
  - Clear (X) button immediately fires onChange("") without waiting for debounce
  - Removed handleSearchSubmit form handler — search is now automatic on type
  - Result count now shows "Showing X transactions" format
  - "Clear filters" → "Clear all filters" for consistency across desktop and mobile
- **Learnings for future iterations:**
  - Debounced inputs need dual state: local for responsiveness, external for URL sync — useEffect to reset local when external changes (e.g. clear all)
  - Removing form submit in favour of debounce simplifies the UI — no search button needed, just type and wait
  - The existing API already handles `search` param with ILIKE on description + rawText — no backend changes needed
---

## 2026-02-08 - B6-004
- What was implemented: Custom category management UI with full CRUD, reorder, icon selector, and colour picker
- Files changed:
  - components/budget/CategoryManager.tsx — new component: category list with reorder, edit, delete, create form
  - app/(dashboard)/budget/setup/page.tsx — added "Manage Categories" button that toggles CategoryManager panel
- **Key changes:**
  - CategoryManager shows all categories sorted by sortOrder with icon/colour preview
  - System categories (uncategorised) show Lock icon — no edit/delete/reorder buttons
  - Non-system categories have ArrowUp/ArrowDown for reorder, Pencil for edit, Trash2 for delete
  - Delete has inline confirmation (Delete/Cancel buttons replace the trash icon)
  - Create/edit form shares state: name input, searchable icon grid (31 Lucide icons), 16-colour preset palette
  - Icon selector supports search filtering and highlights selected icon with primary colour
  - Colour picker shows preset hex swatches with ring indicator for selected
  - Category ID auto-generated from name as lowercase slug (e.g. "My Stuff" → "my-stuff")
  - Reorder swaps sortOrder values via two PUT calls
  - Integrated into setup page header via Settings2 icon button — responsive text ("Categories" on mobile, "Manage Categories" on desktop)
- **Learnings for future iterations:**
  - ICON_REGISTRY pattern: map icon name strings from DB to Lucide React components — reuse in CategoryCard, setup page, etc.
  - For inline delete confirmation, replacing the trash button with Delete/Cancel buttons avoids a modal — simpler UX
  - Category API POST requires `id` field as a slug — auto-generate from name rather than requiring user input
  - Sort order reordering needs two sequential PUT calls — can't batch in current API
---

## 2026-02-08 - B6-005
- What was implemented: Spending trends API endpoint returning historical spending data across multiple budget periods
- Files changed:
  - app/api/budget/trends/route.ts — new GET endpoint with Clerk auth via withAuth
- **Key changes:**
  - Accepts `periods` query param (default 6, max 24) for number of historical periods
  - Fetches N most recent budget periods ordered by start_date desc
  - Reuses `calculateBudgetSummary()` for each period — runs all concurrently via Promise.all
  - Determines current period by checking if today falls within start/end dates → sets isProjected: true
  - Returns array ordered oldest to newest with: periodId, startDate, endDate, totalSpentCents, totalIncomeCents, savingsRate, isProjected, categories array
  - Categories include: categoryId, name, colour, spentCents
- **Learnings for future iterations:**
  - `calculateBudgetSummary` is safe to call concurrently — no shared mutable state
  - withAuth pattern handles both auth and error wrapping — just pass handler and error context string
  - Budget periods use desc(startDate) for fetching recent periods, then .reverse() for oldest-first output
---

## 2026-02-08 - B6-006
- What was implemented: Spending trends chart component with month-over-month bar chart and savings rate line overlay
- Files changed:
  - components/budget/SpendingTrends.tsx — new ComposedChart component with total/breakdown toggle
  - lib/query-keys.ts — added budget.trends query key
  - app/(dashboard)/budget/page.tsx — imported and integrated SpendingTrends below category cards
- **Key changes:**
  - ComposedChart with stacked Bar components per category and Line overlay for savings rate
  - Toggle between "Total" (single bar) and "By Category" (stacked bars with category colours from API)
  - Dual Y-axis: left for spending ($), right for savings rate (%)
  - Custom tooltip shows category breakdown + total + savings rate with "Projected" badge for current period
  - Custom legend with line indicator for savings rate and colour swatches for categories
  - Responsive: h-64 sm:h-72, compact axis tick formatting ($1.2k style)
  - ChartExportButton for PNG export
  - Empty state message when no trend data available
  - Uses existing chart-palette constants (CHART_GRID, CHART_TEXT, CHART_AXIS, POSITIVE, CATEGORY_FALLBACK)
- **Learnings for future iterations:**
  - ComposedChart with dynamic category keys: spread category IDs as data keys, then map allCategories to Bar components
  - Legend for mixed bar/line charts: use line-style indicator (w-4 h-0.5) for Line series vs square (w-2.5 h-2.5) for Bar series
  - Budget trends query key doesn't need periodId — trends span across periods
---

## 2026-02-08 - B6-007
- What was implemented: Budget data export API endpoint for CSV downloads of transactions and summaries
- Files changed:
  - app/api/budget/export/route.ts — new GET endpoint with type=transactions|summary, from/to date filtering
  - lib/export/budget-exporter.ts — CSV formatting utilities for budget transactions and summaries
- **Key changes:**
  - Two export types: 'transactions' (raw UP transactions with category names) and 'summary' (category breakdowns per period)
  - Transactions export joins upTransactions with budgetCategories via leftJoin to resolve category names
  - Summary export uses calculateBudgetSummary for each matching period, flattens category breakdowns into rows
  - Amount values converted from cents to dollars (formatCents: cents/100 with 2 decimal places) in CSV output
  - RFC 4180 CSV escaping: quotes, commas, newlines handled via escapeCSVValue helper
  - Filename includes date range when from/to params provided (e.g. budget-transactions-2026-01-01-to-2026-01-31-2026-02-08.csv)
  - Content-Disposition: attachment triggers browser download
- **Learnings for future iterations:**
  - Existing export patterns in lib/export/ use CSV_COLUMNS config + escapeCSVValue — reused same pattern for consistency
  - leftJoin (not innerJoin) with budgetCategories needed so uncategorised transactions still appear in export
  - calculateBudgetSummary is safe to call concurrently with Promise.all (confirmed in B6-005)
  - For summary export, filtering periods by date uses startDate/endDate on budgetPeriods table, not transaction dates
---

## 2026-02-08 - B6-008
- What was implemented: Export buttons for CSV downloads on transactions page and budget dashboard
- Files changed:
  - app/(dashboard)/budget/transactions/page.tsx — added Export CSV button next to Refresh button, with loading state
  - app/(dashboard)/budget/page.tsx — added Export CSV button in header next to AI Recommendation and PeriodSelector
- **Key changes:**
  - Transactions page: Export button triggers download via anchor element pointing to /api/budget/export?type=transactions with current from/to date filters
  - Dashboard page: Export button uses summary.startDate/endDate to scope the summary export to the current period
  - Both buttons show Loader2 spinner during export and Download icon normally
  - Responsive text: "Export CSV" label hidden on mobile (icon only), shown on sm+
  - Download triggered via programmatic anchor element click (same pattern as ChartExportButton)
- **Learnings for future iterations:**
  - For CSV exports from API endpoints with Content-Disposition: attachment, the simplest client approach is creating a temporary anchor element with href=url and triggering click — no need for fetch + blob
  - Export buttons pair well with existing action buttons (Refresh, AI Recommend) using gap-2 flex layout
  - Date filters from URL search params can be passed through to export API for filtered exports
---

## 2026-02-08 - B6-009
- What was implemented: Design token consistency pass — replaced all hardcoded Tailwind colours with CSS custom property tokens across budget components
- Files changed:
  - components/budget/MobileBudgetChart.tsx — text-emerald/amber/red → text-positive/warning/destructive, bg-red/amber/emerald → bg-destructive/warning/positive, bg-purple-500 → bg-primary
  - components/budget/CategoryCard.tsx — bar colours and remaining text colours → design tokens
  - components/budget/SavingsIndicator.tsx — savings rate colour indicator → text-positive/warning/destructive
  - components/budget/RecommendationModal.tsx — diff colours, projection colours, tip icon → design tokens
  - components/budget/AIRecommendationButton.tsx — error state button → text-destructive border-destructive/30
  - app/(dashboard)/budget/page.tsx — StatCard savings accent → text-positive/text-destructive
  - app/(dashboard)/budget/setup/page.tsx — unallocated savings text → text-positive
- **What was NOT changed (intentionally):**
  - SankeyChart.tsx hex colours (INCOME_COLOUR, SAVINGS_POSITIVE_COLOUR, etc.) — required for SVG rendering
  - SpendingTrends.tsx chart-palette constants (CHART_GRID, POSITIVE, etc.) — already using centralized hex constants
  - CategoryManager.tsx COLOUR_PALETTE hex values — these are user-facing colour picker swatches, not status indicators
- **Learnings for future iterations:**
  - Design token mapping: emerald→positive, red→destructive, amber→warning, purple→primary
  - The transactions page already used proper tokens (text-positive, text-destructive, text-warning, bg-warning/10) — set the pattern others should follow
  - Chart hex colours and colour picker palettes are exempt from token migration — they need literal hex for SVG/canvas
  - Typography, spacing (rounded-lg, p-4), and shadows were already consistent across components — no changes needed
---

## 2026-02-08 - B6-010
- What was implemented: Budget navigation integration with collapsible sub-links in sidebar and mobile drawer
- Files changed:
  - lib/navigation.ts — added `children` field to NavItem interface; Budget item now contains Dashboard, Transactions, Setup sub-links
  - components/layout/sidebar.tsx — collapsible Budget section with ChevronDown toggle, border-l sub-link indentation, auto-expand when on budget pages
  - components/layout/mobile-nav.tsx — same collapsible pattern for mobile drawer with 44px min-h touch targets on sub-links
  - components/command-menu.tsx — flattened nested nav items with "Budget → Dashboard" label format for search
- **Key changes:**
  - Removed flat `/budget/transactions` "Budget Txns" nav item — now nested under Budget group
  - Budget section auto-expands when pathname starts with /budget
  - Collapsed sidebar shows single Budget icon via NavItemLink; expanded shows collapsible group
  - Active state: exact match for /budget (Dashboard child), startsWith for sub-routes
  - UncategorisedBadge moved from flat nav item to Budget → Transactions sub-link
  - Sub-links indented with ml-4 + border-l border-border + pl-2 for visual hierarchy
- **Learnings for future iterations:**
  - Adding children to NavItem is non-breaking — sidebar/mobile handle the `item.children` check, and command-menu flattens
  - For collapsible groups in sidebar: use button (not Link) for the group header so it toggles expand/collapse
  - ChevronDown rotation: `rotate-180` on expanded state with `transition-transform duration-200`
  - Command menu needs children flattened into flat list with prefixed labels so all routes remain keyboard-accessible
---
