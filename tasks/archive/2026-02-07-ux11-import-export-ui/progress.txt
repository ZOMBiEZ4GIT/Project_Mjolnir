## Codebase Patterns
- Project uses Next.js 14+ App Router with TypeScript
- Drizzle ORM is already installed (drizzle-orm, drizzle-kit, @neondatabase/serverless)
- shadcn/ui components available in components/ui
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Tailwind CSS with shadcn/ui CSS variable pattern using HSL format: hsl(var(--variable))
- CSS variables stored without hsl() wrapper e.g. --background: 240 10% 3.9%
- Glow shadows use rgba() since HSL variables can't express box-shadow alpha
- Inter font loaded via next/font/google in app/layout.tsx (applied via inter.className on body)
- Framer Motion components require "use client" directive
- Toast notifications use Sonner - import toast from sonner
- Dashboard navigation uses components/layout/sidebar.tsx and components/layout/mobile-nav.tsx
- Tailwind has semantic tokens: text-positive/bg-positive (green), text-negative/bg-negative (red), shadow-glow-sm/md/lg, shadow-glow-positive, shadow-glow-negative, shadow-card, shadow-card-hover
- Layout & spacing constants live in lib/theme.ts (sidebarWidth, cardRadius, spacing xs→2xl) — use instead of magic numbers
- Animation presets live in lib/animations.ts — import and spread onto motion.div elements (e.g. `<motion.div {...fadeIn}>`)
- Stagger presets (staggerContainer, staggerItem) use Variants type with "hidden"/"visible" keys — use with variants prop
- numberSpring is a Transition object for animating numeric values (e.g. useSpring, useMotionValue)
- Reduced motion: use `useReducedMotion()` from framer-motion directly — returns boolean for OS prefers-reduced-motion
- Hooks live in hooks/ directory (not lib/) — follow this convention for custom React hooks
- Recharts SVG props (stroke, fill) require raw hex values — CSS variables not supported in SVG rendering
- Category indicator colours (asset types, currencies) use hardcoded Tailwind colours (bg-blue-500 etc.) — these are intentional and distinct from theme tokens
- Card container pattern: `border-border bg-card/50` for bordered cards, `bg-muted` for skeleton placeholders
- Error state pattern: `border-destructive bg-destructive/10` with `text-destructive` for error messages
- Toggle pattern: active=`bg-muted text-foreground`, inactive=`text-muted-foreground hover:text-foreground`
- Form validation pattern: `border-destructive focus-visible:ring-destructive` on inputs, `text-destructive` on error messages
- Delete confirm button: `bg-destructive hover:bg-destructive/90 text-foreground`; cancel: `bg-card border-border text-foreground hover:bg-muted`
- Select dropdowns: `bg-background border-border text-muted-foreground` for trigger, `focus:bg-card focus:text-foreground` for items
- Warning colours use text-warning/bg-warning design tokens (--warning: 38 92% 50% ≈ amber-500) — added in UX-9 US-010
- Info colours (blue-*) are semantic and intentionally NOT part of design token migration
- Interactive toggle buttons (show/hide contributions): use `text-primary hover:text-primary/80` pattern
- html2canvas backgroundColor requires raw hex — use `#18181b` to match --card token
- Email templates (components/emails/) use inline hex values — email clients don't support CSS variables
- Only legitimate remaining hardcoded grey: `bg-gray-500` fallback in category indicator functions (asset-allocation, currency-exposure)
- TimeRangeSelector (components/charts/time-range-selector.tsx) exports TimeRange type and TIME_RANGE_OPTIONS — import from @/components/charts
- lightweight-charts v5 API: `chart.addSeries(AreaSeries, options)` — not `chart.addAreaSeries(options)` (deprecated)
- TradingView charts require `next/dynamic` with `ssr: false` — use TVChart from components/charts/tv-chart.tsx
- TVChartWrapper supports `onCrosshairMove` callback for custom tooltips — returns TVCrosshairData { time, value, x, y } or null
- TradingView custom tooltip: use absolute positioned div with pointer-events-none overlaying the chart container
- TradingView Time type accepts YYYY-MM-DD date strings cast as `Time` — works for monthly data points
- Navigation items defined in lib/navigation.ts — import navItems and NavItem type from there (sidebar, mobile nav, command menu)
- New layout components live in components/layout/ — NavItemLink (nav-item.tsx) uses Framer Motion layoutId='active-nav' for animated active pill
- TooltipProvider with delayDuration={0} wraps collapsed nav items for instant tooltip display
- Sidebar collapse state persists in localStorage ('mjolnir-sidebar-collapsed') — use mounted state pattern to avoid hydration mismatch
- Sidebar is fixed positioned; content area needs dynamic left margin matching sidebar width (240px or 64px)
- AppShell (components/layout/app-shell.tsx) owns sidebar collapsed state — Sidebar receives isCollapsed/onToggleCollapsed as props
- Content area uses CSS custom property --sidebar-width with responsive Tailwind class ml-0 lg:ml-[var(--sidebar-width)] for responsive dynamic margin
- For responsive dynamic values, use CSS custom properties + Tailwind arbitrary value classes (inline styles can't be responsive)
- PageWrapper (components/layout/page-wrapper.tsx) wraps page content with fade transition — placed inside DashboardErrorBoundary in dashboard layout
- Mobile header (components/layout/mobile-nav.tsx) is fixed h-14 z-30 — content area needs pt-14 on mobile
- Sheet drawer (shadcn/ui) handles focus trapping and Escape close via Radix Dialog primitive
- Focus ring pattern: `focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring` matches shadcn/ui conventions
- Shared UI components (e.g. SpeedDial) live in `components/shared/` directory
- To open AddHoldingDialog/AddTransactionDialog programmatically: pass a hidden `<button ref={ref} />` as children, then call `ref.current?.click()`
- CheckInModal uses controlled `open`/`onOpenChange` props — can be opened from any external trigger
- HoldingsTable hybrid grouping: `typeFilter="all"` shows collapsible grouped sections, specific type shows flat list via `HoldingsFlatSection`
- Shared table rendering: `HoldingsTableContent` component handles row rendering for both grouped and flat views
- GroupHeader (components/holdings/group-header.tsx) shows label, count, total value, portfolio % badge — receives calculated values as props
- `calculateGroupTotal()` in holdings-table.tsx converts holdings to display currency — use for any group-level value aggregation
- `motion.create(TableRow)` creates a motion-enhanced `MotionTableRow` for stagger animations on table rows
- Stagger rows use `motion.tbody` as container with `variants` + `initial="hidden" animate="visible"` pattern
- Capped stagger: `Math.min(0.05, 0.5 / count)` ensures total stagger completes within 500ms regardless of row count
- `useReducedMotion()` from framer-motion checks OS prefers-reduced-motion — skip animations entirely when true
- Dormant holdings sorted to bottom of each group via `useMemo` sort in `HoldingsTableContent` and `HoldingsCurrencySection`
- EmptyState component (`components/ui/empty-state.tsx`) is shared across holdings, snapshots, transactions — keep prop API stable
- `AnimatePresence mode="popLayout"` on HoldingsTable wraps content keyed by typeFilter — handles enter/exit on tab change
- Holdings table rows are clickable (navigate to `/holdings/[id]`) — action buttons use `stopPropagation` to prevent row click
- Row hover: `hover:bg-accent/5 hover:scale-[1.005] active:bg-accent/10` with `transition-[background-color,transform] duration-150`
- Filter tabs (components/holdings/filter-tabs.tsx) use Framer Motion layoutId for animated sliding indicator
- scrollbar-hide utility class added to globals.css for hidden scrollbar on overflow-x-auto elements
- TypeSelector (components/transactions/type-selector.tsx) uses layoutId="active-transaction-type" for animated tab indicator
- react-hook-form + zod installed; shadcn/ui form.tsx component available in components/ui/form.tsx
- z.coerce.number() with useForm requires casting resolver: `zodResolver(schema) as unknown as Resolver<FormValues>`
- Zod v4 API difference: use `{ error: "..." }` for custom error messages on z.coerce.number(), not `{ required_error, invalid_type_error }` (Zod v3 API)
- Zod v4 superRefine: use `code: "custom"` string literal instead of `z.ZodIssueCode.custom` enum
- For numeric inputs with z.coerce: pass `field.value ?? ""` to prevent "undefined" showing
- TransactionSummary cards use stagger animation with motion.div and variants pattern
- Transaction table uses monthly grouping with sticky headers (sticky top-0 z-20 bg-background)
- MotionTableRow with stagger variants + AnimatePresence mode="wait" keyed by filterKey for table animations
- Transaction action colour mapping: BUY=positive/green, SELL=destructive/red, DIVIDEND=accent/purple, SPLIT=blue-400/blue-500
- onTransactionSaved/onDeleted callbacks enable row highlight and fade-out animations from parent component
- Check-in form uses react-hook-form + zod with useFieldArray for dynamic holdings list; showContributions is UI-only state (not in form schema)
- useFieldArray `replace()` syncs form fields with API data; use a ref-based sync key to prevent re-replacing on every render
- form.trigger(`holdings.${idx}.balance`) validates individual field array items for per-step validation in wizard flows
- form.setValue with `{ shouldValidate: form.formState.isSubmitted }` re-validates on change only after first validation attempt
- Check-in status API returns `previousBalances` keyed by holdingId — most recent snapshot balance before target month
- CheckInModal is a 3-step wizard (Select Month → Update Holdings → Review & Save) with currentStep state (0-2)
- animate-shake keyframes defined in tailwind.config.ts — use `animate-shake` class with useState toggle + setTimeout auto-clear
- Type icon mapping: super=Landmark, cash=Wallet, debt=CreditCard (from lucide-react)
- CheckinPrompt (components/dashboard/checkin-prompt.tsx) replaces CheckInPromptCard — moved to dashboard/ directory
- sessionStorage dismissal pattern: use `mounted` state + useEffect to avoid hydration mismatch when reading sessionStorage
- Accent glow prompt card: `border-accent/30 bg-card/50 shadow-glow-sm` for attention-grabbing cards
- Directional step transitions: use variants with `custom` prop on AnimatePresence to pass direction to exiting components — enter slides from `100*d%`, exit slides to `-100*d%` (d=1 forward, d=-1 backward)
- Step container needs `overflow-hidden` to clip sliding content during transitions
- Accordion expand animation: `motion.div` with `height: 0` → `height: "auto"`, `overflow-hidden`, wrapped in `AnimatePresence initial={false}`
- Check-in status API returns `latestContributions` for pre-populating super contribution fields
- Success summary pattern: store mutation result in state + `showSuccess` boolean, render different content in same step (no extra wizard step)
- CheckinStepper accepts currentStep=3 (beyond max) to mark all steps completed — no code change needed in stepper
- NumberTicker component (components/dashboard/number-ticker.tsx) animates currency values using useSpring + useMotionValue; tabular-nums prevents layout shift
- ChangeBadge component (components/dashboard/change-badge.tsx) shows positive/negative/zero with TrendingUp/TrendingDown/Minus icons; size="sm"|"md"
- StaleIndicator component (components/dashboard/stale-indicator.tsx) shows amber warning with tooltip (icon variant) or inline text (badge variant)
- framer-motion v12 `useSpring` subscribes via `.on("change", cb)` — use this to update textContent directly for performance
- Dashboard sections stagger in via motion.div container (80ms delay) with fadeIn+slideUp (opacity 0→1, y 16→0, 300ms easeOut)
- Progress bar animation: use useState(0) → useEffect setTimeout → setState(target) with CSS transition
- Donut centre overlay: absolute positioned div with pointer-events-none, marginBottom to offset legend
- Chart hex colours (#374151, #9CA3AF etc.) are required for SVG rendering — don't convert to CSS variables
- Grid gap-6 for section spacing, gap-4 only for small internal layouts
- All card-level elements use rounded-2xl; inner elements (tooltips, icons, row items) keep rounded-lg
- Yahoo Finance `chart()` method: `yahooFinance.chart(symbol, { period1, period2, interval: "1d" })` returns `{ quotes: [{ close }] }`
- CoinGecko market_chart: `/coins/{id}/market_chart?vs_currency=usd&days=30&interval=daily` returns `{ prices: [[timestamp, price]] }`
- Sparkline data API: `GET /api/prices/sparkline` returns `{ holdingId, symbol, prices: number[] }[]` — staleTime 30min
- SVG elements (non-Recharts) can use `stroke="currentColor"` with Tailwind `text-*` classes — avoids hardcoded hex
- ChartSkeleton uses ChartCard wrapper when `withContainer=true` — consistent with all chart sections
- All chart tooltips use `bg-card` (not `bg-background`) for consistent elevated surface styling
- Chart hex colours centralised in `lib/chart-palette.ts` — import CHART_GRID, CHART_TEXT, CHART_AXIS, POSITIVE, NEGATIVE, etc. instead of hardcoding hex
- Category asset type colours (STOCK, ETF, CRYPTO, SUPER, CASH) also in chart-palette.ts — use in getAssetHexColor() and similar functions
- PriceFlash (components/holdings/price-flash.tsx) wraps children with green/red flash on value change — use `<PriceFlash value={num}>{children}</PriceFlash>`
- PriceNumberTicker (components/holdings/price-number-ticker.tsx) animates price digits with spring animation — prefix prop stays static, only digits animate
- PriceTimestamp (components/holdings/price-timestamp.tsx) shows relative time + tooltip with exact time — three states: fresh/stale/error
- PriceSkeleton (components/holdings/price-skeleton.tsx) loading skeleton for price cells — variant="price" (3-bar) or variant="value" (single-bar)
- TanStack Query: `isFetching && !isLoading` detects background refetches without triggering initial skeleton
- Currency bar colours: AUD=`bg-positive` (green), NZD=`bg-blue-400` (blue), USD=`bg-amber-500` (amber) — use in progress bars and charts
- AnimatedPercentage pattern: requestAnimationFrame loop with ease-out cubic for lightweight percentage transitions (no framer-motion dependency)
- CurrencyToggle (components/ui/currency-toggle.tsx) is a horizontal pill toggle with Framer Motion layoutId='currency-indicator' — replaces CurrencySelector dropdown on dashboard
- CURRENCY_SYMBOLS exported from lib/utils/currency.ts — use for displaying currency symbol separately from formatted number
- CurrencyDisplay uses useSpring for animated number transitions; motionValue.jump() for instant, motionValue.set() for animated
- Flash highlight pattern: bg-accent/15 with transitionDuration 0ms→400ms trick for instant-on, fade-off effect
- CurrencyDisplay shows rich tooltip (conversion info + rate) only when showNative=true and currencies differ — no tooltip otherwise
- Effective exchange rate: compute from amount/nativeAmount rather than passing rates as prop
- NativeCurrencyToggle accepts `showDescription` prop for optional descriptive text; Switch override: `data-[state=checked]:bg-accent data-[state=unchecked]:bg-muted`
- CurrencyDisplay flash also triggers on showNative change for components with different native currency
- Radix + Framer Motion: use `asChild` + `motion.div` pattern (not `motion.create(Primitive)`) to avoid `onDrag` type conflict
- AnimatedDialog/AnimatedAlertDialog: drop-in replacements for Dialog/AlertDialog — import from `@/components/ui/animated-dialog` or `animated-alert-dialog`
- Framer Motion centering: use `style={{ x: "-50%", y: "-50%" }}` not CSS translate classes (FM overwrites transform)
- FormField/FormTextareaField/FormSelectField: convenience wrappers in components/ui/ — use Controller + useFormContext, require FormProvider parent
- FormField uses motion.input with focusGlow for purple glow on focus; FormSelectField uses Radix Select (no motion wrapper)
- useFormShake hook (hooks/use-form-shake.ts): returns { formRef, triggerShake } — attach ref to form container, call triggerShake() in handleSubmit onInvalid callback; cast formRef to `React.RefObject<HTMLDivElement | null>` when attaching to a `<div>`
- animate-shake CSS class defined in tailwind.config.ts — use for CSS-based shake animations (500ms ease-in-out)
- Toast helpers: import { showSuccess, showError, showInfo } from "@/lib/toast-helpers" — success auto-dismiss 3s, error persists until dismissed, info 4s
- showError accepts optional { onRetry } to render a Retry action button; use for retryable operations
- check-in-modal.tsx: use aliased imports (toastSuccess/toastError) because local `showSuccess` state variable shadows the import
- shadcn/ui Accordion requires `accordion-down`/`accordion-up` keyframes in tailwind.config.ts — add manually after `shadcn add accordion`
- SettingsSection (components/settings/settings-section.tsx) wraps AccordionItem with icon+title+description trigger — use for settings-style pages
- Global `prefers-reduced-motion: reduce` in globals.css disables all CSS animations/transitions (0.01ms duration)
- ConfirmDialog (components/ui/confirm-dialog.tsx) is a ready-to-use confirmation dialog — wraps AnimatedAlertDialog with simple props API (title, description, variant, onConfirm, loading)

---

# UX-11 Import/Export UI Progress Log

Started: 2026-02-07

---

## 2026-02-07 - US-001
- Polished file-upload.tsx with Framer Motion animations and design token states
- Files changed: components/import/file-upload.tsx
- **Learnings for future iterations:**
  - Component already used mostly design tokens; main changes were animation additions
  - AnimatePresence mode="wait" works well for toggling between dropzone and file-selected states
  - Upload icon pulse uses `animate` with keyframe array `[1, 1.1, 1]` and `repeat: Infinity`
  - File icon scale-in uses `initial: { scale: 0.8, opacity: 0 }` with 200ms easeOut
  - `useReducedMotion()` returns boolean — pass `false` as initial to skip animations
  - Drag-over state: border-accent + bg-accent/5 (not border-primary which was previous)
  - File selected state: bg-card (not bg-muted/50 which was previous)
---

## 2026-02-07 - US-002
- Rebuilt import-progress.tsx with custom progress bar (not shadcn Progress)
- Added shimmer keyframe animation to tailwind.config.ts
- Files changed: components/import/import-progress.tsx, tailwind.config.ts
- **Learnings for future iterations:**
  - Added `animate-shimmer` keyframe (200%→-200% backgroundPosition, 2s linear infinite)
  - Custom progress bar uses CSS transition (not Framer Motion) for width changes — simpler and more performant
  - `shadow-glow-sm` on progress fill creates subtle accent glow effect
  - ImportProgress now accepts optional `currentRow` for "row X of Y" text (backward-compatible)
  - Indeterminate mode still uses the asymptotic approach to 90% for perceived progress
---

## 2026-02-07 - US-003
- Created ImportPreview component and integrated preview step into import page
- Files changed: components/import/import-preview.tsx (new), app/(dashboard)/import/page.tsx
- **Learnings for future iterations:**
  - CSV parsing is simple split-by-comma — no quoted field handling needed for this app's use case
  - Preview replaces the old direct "Import [Type]" button — file select now always shows preview first
  - Validation functions accept `_rows` param (unused for now) — extensible for row-level validation later
  - Warning banner uses border-warning/30 + bg-warning/10 pattern (consistent with design system)
  - Preview slide uses x:30→0 (right-to-left) for forward navigation feel
  - `motion.tbody` with `variants` pattern works well for table row stagger animations
---

## 2026-02-07 - US-004
- Polished export page with stagger animations and custom card layout
- Files changed: app/(dashboard)/export/page.tsx
- **Learnings for future iterations:**
  - Replaced Card/CardContent/CardHeader with plain motion.div + custom rounded-2xl styling for more control
  - Custom staggerContainerCustom with 80ms delay (different from default staggerContainer 50ms)
  - Export card data-driven: array of card config objects mapped to JSX — cleaner than duplicated markup
  - Count badges as pills: `rounded-full bg-muted px-2.5 py-0.5 text-xs font-medium text-muted-foreground`
  - Full backup card distinguished with border-accent/30 and text-accent icon
---

## 2026-02-07 - US-005
- Added per-button download state tracking with success/error animations to export page
- Files changed: app/(dashboard)/export/page.tsx
- **Learnings for future iterations:**
  - Map<ExportKey, ButtonState> tracks per-button states (idle/downloading/success/error)
  - TypeScript narrowing gotcha: `state === "downloading" || ... state !== "downloading"` fails type check
    because after first false comparison, TS narrows type to exclude "downloading" — restructure as separate boolean
  - Success state auto-resets after 1.5s, error after 2s via setTimeout
  - Scale pulse: `animate={{ scale: [1, 1.05, 1] }}` with duration 0.3 for subtle bounce
  - `cn()` for conditional className merging: `state === "success" && "text-positive border-positive/30"`
---

## 2026-02-07 - US-006
- Enhanced import-results.tsx with animated counts and stagger animations
- Files changed: components/import/import-results.tsx
- **Learnings for future iterations:**
  - AnimatedCount: useSpring + useMotionValue + .on("change") for performant integer animation
  - motionValue.jump() for instant (reduced motion), motionValue.set() for animated
  - Three-card grid (grid-cols-3 gap-3) for Imported/Skipped/Errors — always show all three
  - Added `suggestion` field to ImportError interface in preparation for US-007
  - Success banner: border-positive/30 bg-positive/10 with CheckCircle2 icon
  - Error row badge changed from bg-destructive/10 to bg-muted rounded-full pill
---

## 2026-02-07 - US-007
- Enhanced error section with animated expand/collapse and fix suggestions
- Files changed: components/import/import-results.tsx
- **Learnings for future iterations:**
  - Rotating chevron: `motion.div animate={{ rotate: isExpanded ? 180 : 0 }}` — cleaner than ChevronUp/Down toggle
  - AnimatePresence initial={false} skips enter animation on mount — use for collapsed sections
  - `generateSuggestion()` exported for reuse (US-008 error report will need it)
  - Fix suggestion patterns: check lowercase message against known keywords, return template strings
  - Auto-expand if <= 5 errors via useState initializer function
  - Error row stagger: 30ms delay per row (errorStaggerContainer), slides in from left (x: -8 → 0)
---

## 2026-02-07 - US-008
- Added downloadable error report CSV to import results
- Files changed: components/import/import-results.tsx
- **Learnings for future iterations:**
  - Client-side CSV generation: Blob + createObjectURL + click trick
  - CSV escaping: wrap in double quotes, replace inner " with ""
  - Reused success animation pattern from export page (scale pulse + text-positive + auto-reset)
  - downloadState kept simple ("idle" | "success") — no "downloading" state needed for client-side CSV
  - Filename pattern: import-errors-YYYY-MM-DD.csv using ISO date split
---

## 2026-02-07 - US-009
- Polished recent-imports.tsx with stagger animations and design tokens
- Files changed: components/import/recent-imports.tsx, app/(dashboard)/import/page.tsx
- **Learnings for future iterations:**
  - Type badge colours: Transactions=accent (purple), Snapshots=positive (green)
  - Row hover: `transition-colors duration-150 hover:bg-accent/5` for subtle hover
  - Expanded details show first 3 errors max, with "...and X more" truncation
  - `format(date, "PPpp")` gives full locale-aware date+time string
  - Section title uses `text-label uppercase text-muted-foreground` for label typography
  - Skeleton loading now uses bg-muted (design token) not bg-card
  - Empty state icon uses text-muted-foreground/50 for extra subtle appearance
---

### US-010: Replace hardcoded colours across all import/export components ✅
- **Status:** PASS (build ✅, lint ✅)
- **Approach:** Audited all 7 target files for hardcoded colour classes (text-gray-*, bg-gray-*, border-gray-*, text-green-*, etc.)
- **Finding:** All import/export files already use design tokens — US-001 through US-009 systematically replaced hardcoded colours during implementation
- **Changes:** Updated import page header from `text-2xl font-bold` to `text-heading-lg` and description to `text-body-sm`
- **chart-export-button.tsx:** `#18181b` hex retained — html2canvas requires raw hex values, not CSS variables
- **Learnings:**
  - When each story properly applies design tokens during implementation, the final audit story becomes trivial
  - Typography tokens (text-heading-lg, text-body-sm, text-label) are easy to miss — page headers and descriptions should be checked alongside colour tokens
---

