{
  "id": "w5-snapshot-tracking",
  "title": "W-5 Snapshot Tracking & Monthly Check-in Modal",
  "branchName": "feature/w5-snapshot-tracking",
  "description": "Snapshot tracking for non-tradeable assets (super, cash, debt). Point-in-time balance recording with monthly check-in modal and optional super contribution tracking.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create snapshots database schema",
      "description": "As a developer, I need a snapshots table to store point-in-time balances.",
      "acceptanceCriteria": [
        "Create `snapshots` table with Drizzle schema in `lib/db/schema.ts`",
        "Fields: id (uuid), holding_id (uuid FK), date (date), balance (decimal 18,2), currency (enum: AUD, NZD, USD), notes (text nullable), created_at, updated_at, deleted_at (nullable)",
        "Add unique constraint on (holding_id, date) to prevent duplicates",
        "Date stored as first of month (YYYY-MM-01)",
        "Add foreign key constraint to holdings table",
        "Generate migration with `npm run db:generate`",
        "Typecheck passes (`npm run build`)",
        "Lint passes (`npm run lint`)"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Create contributions database schema",
      "description": "As a developer, I need a contributions table to track super contributions separately.",
      "acceptanceCriteria": [
        "Create `contributions` table with Drizzle schema in `lib/db/schema.ts`",
        "Fields: id (uuid), holding_id (uuid FK), date (date), employer_contribution (decimal 18,2), employee_contribution (decimal 18,2), notes (text nullable), created_at, updated_at, deleted_at (nullable)",
        "Add unique constraint on (holding_id, date)",
        "Date stored as first of month",
        "Add foreign key constraint to holdings table",
        "Generate migration with `npm run db:generate`",
        "Typecheck passes",
        "Lint passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Create snapshots API - GET endpoints",
      "description": "As a developer, I need API endpoints to retrieve snapshots.",
      "acceptanceCriteria": [
        "Create `app/api/snapshots/route.ts` with GET handler",
        "GET /api/snapshots returns all non-deleted snapshots",
        "Supports `?holding_id=` filter",
        "Create `app/api/snapshots/[id]/route.ts` with GET handler",
        "GET /api/snapshots/[id] returns single snapshot or 404",
        "Results include holding name via join",
        "Results sorted by date descending",
        "Requires Clerk authentication (401 if not authenticated)",
        "Typecheck passes",
        "Lint passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Create snapshots API - POST endpoint",
      "description": "As a developer, I need an API endpoint to create snapshots with duplicate prevention.",
      "acceptanceCriteria": [
        "Add POST handler to `app/api/snapshots/route.ts`",
        "Validates required fields: holding_id, date, balance, currency",
        "Validates holding_id exists and is snapshot type (super, cash, debt)",
        "Normalizes date to first of month (YYYY-MM-01)",
        "Validates date is current or previous month only",
        "Returns 409 Conflict if snapshot exists for same holding/month",
        "Returns 201 with created snapshot on success",
        "Returns 400 with validation errors on invalid input",
        "Requires Clerk authentication",
        "Typecheck passes",
        "Lint passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Create snapshots API - PATCH and DELETE endpoints",
      "description": "As a developer, I need API endpoints to update and delete snapshots.",
      "acceptanceCriteria": [
        "Add PATCH handler to `app/api/snapshots/[id]/route.ts`",
        "PATCH updates balance, notes only (date is immutable)",
        "Returns 200 with updated snapshot",
        "Add DELETE handler - performs soft delete (sets deleted_at)",
        "Both return 404 if snapshot not found",
        "Requires Clerk authentication",
        "Typecheck passes",
        "Lint passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Create contributions API - GET and POST endpoints",
      "description": "As a developer, I need API endpoints to retrieve and create contributions.",
      "acceptanceCriteria": [
        "Create `app/api/contributions/route.ts` with GET and POST handlers",
        "GET supports `?holding_id=` filter, returns with holding name",
        "GET sorted by date descending",
        "POST validates holding is super type",
        "POST normalizes date to first of month",
        "POST returns 409 if contribution exists for same holding/month",
        "Requires Clerk authentication",
        "Typecheck passes",
        "Lint passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Create contributions API - PATCH and DELETE endpoints",
      "description": "As a developer, I need API endpoints to update and delete contributions.",
      "acceptanceCriteria": [
        "Create `app/api/contributions/[id]/route.ts` with GET, PATCH, DELETE handlers",
        "GET returns single contribution or 404",
        "PATCH updates employer_contribution, employee_contribution, notes",
        "DELETE performs soft delete",
        "All routes require Clerk authentication",
        "Typecheck passes",
        "Lint passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Create latest snapshot helper",
      "description": "As a developer, I need functions to get the latest snapshot for holdings.",
      "acceptanceCriteria": [
        "Create `lib/queries/snapshots.ts`",
        "Function `getLatestSnapshots(): Promise<Map<string, Snapshot>>`",
        "Function `getLatestSnapshotForHolding(holdingId): Promise<Snapshot | null>`",
        "Returns most recent non-deleted snapshot per holding",
        "Typecheck passes",
        "Lint passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Create investment returns calculation",
      "description": "As a developer, I need to calculate investment returns for super funds.",
      "acceptanceCriteria": [
        "Create `lib/calculations/super-returns.ts`",
        "Function `calculateInvestmentReturns(holdingId, fromDate, toDate): Promise<number | null>`",
        "Returns = (new_balance - old_balance) - employer_contrib - employee_contrib",
        "Handles missing contributions (treats as 0)",
        "Returns null if missing previous snapshot",
        "Typecheck passes",
        "Lint passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Snapshots navigation",
      "description": "As Roland, I want to access the snapshots page from navigation.",
      "acceptanceCriteria": [
        "Add 'Snapshots' link to dashboard navigation in `components/dashboard/nav.tsx`",
        "Link navigates to `/snapshots` route",
        "Current page highlighted in navigation (active state)",
        "Typecheck passes",
        "Lint passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Create snapshots list page",
      "description": "As Roland, I want to see all my snapshots in a dedicated history page.",
      "acceptanceCriteria": [
        "Create page at `app/(dashboard)/snapshots/page.tsx`",
        "Table columns: Date (Month Year), Holding, Type, Balance, Currency",
        "Filter by holding (dropdown)",
        "Filter by type (super/cash/debt tabs or dropdown)",
        "Sorted by date descending",
        "Loading and empty states",
        "Page protected with Clerk auth",
        "Typecheck passes",
        "Lint passes",
        "Verify in browser using Playwright"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Dashboard check-in prompt card",
      "description": "As Roland, I want to see a prompt on the dashboard when it's time for monthly check-in.",
      "acceptanceCriteria": [
        "Add 'Monthly Check-in' card to dashboard page",
        "Card shows if current month has missing snapshots for any active snapshot holdings",
        "Displays: 'You have X holdings to update for [Month Year]'",
        "'Start Check-in' button (modal trigger, to be connected in later story)",
        "Card hidden if all holdings have current month snapshots",
        "Typecheck passes",
        "Lint passes",
        "Verify in browser using Playwright"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Monthly check-in modal - base structure",
      "description": "As Roland, I want a modal that guides me through updating all snapshot holdings.",
      "acceptanceCriteria": [
        "Create `components/check-in/check-in-modal.tsx`",
        "Modal opens from dashboard prompt card 'Start Check-in' button",
        "Month selector: current month (default) or previous month only",
        "Shows list of all snapshot holdings needing updates for selected month",
        "Holdings grouped by type: Super, Cash, Debt",
        "Skip button to close without saving",
        "Shows progress: '2 of 5 holdings updated'",
        "Typecheck passes",
        "Lint passes",
        "Verify in browser using Playwright"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Check-in modal - super holdings entry",
      "description": "As Roland, I want to enter super balances with optional contribution breakdown.",
      "acceptanceCriteria": [
        "For each super holding: Name label, Balance input (required)",
        "Expandable 'Add Contributions' section (collapsed by default)",
        "When expanded: Employer Contribution, Employee Contribution inputs",
        "For dormant super (is_dormant=true): no contributions section shown",
        "Currency displayed from holding (read-only)",
        "Typecheck passes",
        "Lint passes",
        "Verify in browser using Playwright"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Check-in modal - cash and debt entry",
      "description": "As Roland, I want to enter cash and debt balances.",
      "acceptanceCriteria": [
        "For each cash holding: Name label, Balance input",
        "For each debt holding: Name label, Balance input (displayed as positive, stored as positive)",
        "Debt section header explains: 'Enter as positive number (e.g., 5000 for $5,000 owed)'",
        "Currency displayed from holding (read-only)",
        "Typecheck passes",
        "Lint passes",
        "Verify in browser using Playwright"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Check-in modal - save and complete",
      "description": "As Roland, I want to save all check-in entries at once.",
      "acceptanceCriteria": [
        "'Save All' button at bottom of modal",
        "Creates snapshot for each holding with entered balance",
        "Creates contribution record for super holdings where provided",
        "Shows validation errors inline if any balance missing",
        "On success: closes modal, shows success toast with count",
        "Invalidates relevant queries (holdings, snapshots)",
        "Typecheck passes",
        "Lint passes",
        "Verify in browser using Playwright"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Edit snapshot modal",
      "description": "As Roland, I want to edit snapshots to correct mistakes.",
      "acceptanceCriteria": [
        "Add edit button to each row on snapshots list page",
        "Edit button opens modal pre-populated with snapshot data",
        "Shows holding name and date (read-only)",
        "Editable: balance, notes",
        "For super: show contributions if exists, or 'Add Contributions' option",
        "Save calls PATCH /api/snapshots/[id]",
        "Success: closes modal, invalidates queries, shows toast",
        "Typecheck passes",
        "Lint passes",
        "Verify in browser using Playwright"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Delete snapshot with confirmation",
      "description": "As Roland, I want to delete incorrect snapshots.",
      "acceptanceCriteria": [
        "Add delete button to each row on snapshots list page",
        "Confirmation dialog shows snapshot details (holding, date, balance)",
        "Confirm soft-deletes the snapshot via DELETE /api/snapshots/[id]",
        "Also deletes associated contribution if exists",
        "Success: closes dialog, invalidates queries, shows toast",
        "Typecheck passes",
        "Lint passes",
        "Verify in browser using Playwright"
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-019",
      "title": "Display holdings with latest balance",
      "description": "As Roland, I want to see the latest balance on the holdings list for snapshot holdings.",
      "acceptanceCriteria": [
        "Holdings list shows 'Balance' column for super, cash, debt types",
        "Displays latest snapshot balance",
        "Shows 'as of [Month Year]' indicator",
        "Shows 'No data' if no snapshots exist",
        "Stale indicator (yellow/orange badge) if latest snapshot older than 2 months",
        "Typecheck passes",
        "Lint passes",
        "Verify in browser using Playwright"
      ],
      "priority": 19,
      "passes": false,
      "notes": ""
    }
  ]
}
