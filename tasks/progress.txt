## Codebase Patterns
- Project uses Next.js 14+ App Router with TypeScript
- Drizzle ORM is already installed (drizzle-orm, drizzle-kit, @neondatabase/serverless)
- shadcn/ui components available in components/ui
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Tailwind CSS with shadcn/ui CSS variable pattern using HSL format: hsl(var(--variable))
- CSS variables stored without hsl() wrapper e.g. --background: 240 10% 3.9%
- Glow shadows use rgba() since HSL variables can't express box-shadow alpha
- Inter font loaded via next/font/google in app/layout.tsx (applied via inter.className on body)
- Framer Motion components require "use client" directive
- Toast notifications use Sonner - import toast from sonner
- Dashboard navigation uses components/layout/sidebar.tsx and components/layout/mobile-nav.tsx
- Tailwind has semantic tokens: text-positive/bg-positive (green), text-negative/bg-negative (red), shadow-glow-sm/md/lg, shadow-glow-positive, shadow-glow-negative, shadow-card, shadow-card-hover
- Layout & spacing constants live in lib/theme.ts (sidebarWidth, cardRadius, spacing xs→2xl) — use instead of magic numbers
- Animation presets live in lib/animations.ts — import and spread onto motion.div elements (e.g. `<motion.div {...fadeIn}>`)
- Stagger presets (staggerContainer, staggerItem) use Variants type with "hidden"/"visible" keys — use with variants prop
- numberSpring is a Transition object for animating numeric values (e.g. useSpring, useMotionValue)
- Reduced motion: use `useAnimationConfig(preset?)` from hooks/use-animation-config.ts — returns props that disable animations when OS prefers-reduced-motion is on
- Hooks live in hooks/ directory (not lib/) — follow this convention for custom React hooks
- Recharts SVG props (stroke, fill) require raw hex values — CSS variables not supported in SVG rendering
- Category indicator colours (asset types, currencies) use hardcoded Tailwind colours (bg-blue-500 etc.) — these are intentional and distinct from theme tokens
- Card container pattern: `border-border bg-card/50` for bordered cards, `bg-muted` for skeleton placeholders
- Error state pattern: `border-destructive bg-destructive/10` with `text-destructive` for error messages
- Toggle pattern: active=`bg-muted text-foreground`, inactive=`text-muted-foreground hover:text-foreground`
- Form validation pattern: `border-destructive focus-visible:ring-destructive` on inputs, `text-destructive` on error messages
- Delete confirm button: `bg-destructive hover:bg-destructive/90 text-foreground`; cancel: `bg-card border-border text-foreground hover:bg-muted`
- Select dropdowns: `bg-background border-border text-muted-foreground` for trigger, `focus:bg-card focus:text-foreground` for items
- Warning/info colours (yellow-*, blue-*) are semantic and intentionally NOT part of design token migration
- Interactive toggle buttons (show/hide contributions): use `text-primary hover:text-primary/80` pattern
- html2canvas backgroundColor requires raw hex — use `#18181b` to match --card token
- Email templates (components/emails/) use inline hex values — email clients don't support CSS variables
- Only legitimate remaining hardcoded grey: `bg-gray-500` fallback in category indicator functions (asset-allocation, currency-exposure)
- Navigation items defined in lib/navigation.ts — import navItems and NavItem type from there (sidebar, mobile nav, command menu)
- New layout components live in components/layout/ — NavItemLink (nav-item.tsx) uses Framer Motion layoutId='active-nav' for animated active pill
- TooltipProvider with delayDuration={0} wraps collapsed nav items for instant tooltip display
- Sidebar collapse state persists in localStorage ('mjolnir-sidebar-collapsed') — use mounted state pattern to avoid hydration mismatch
- Sidebar is fixed positioned; content area needs dynamic left margin matching sidebar width (240px or 64px)
- AppShell (components/layout/app-shell.tsx) owns sidebar collapsed state — Sidebar receives isCollapsed/onToggleCollapsed as props
- Content area uses CSS custom property --sidebar-width with responsive Tailwind class ml-0 lg:ml-[var(--sidebar-width)] for responsive dynamic margin
- For responsive dynamic values, use CSS custom properties + Tailwind arbitrary value classes (inline styles can't be responsive)
- PageWrapper (components/layout/page-wrapper.tsx) wraps page content with fade transition — placed inside DashboardErrorBoundary in dashboard layout
- Mobile header (components/layout/mobile-nav.tsx) is fixed h-14 z-30 — content area needs pt-14 on mobile
- Sheet drawer (shadcn/ui) handles focus trapping and Escape close via Radix Dialog primitive
- Focus ring pattern: `focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring` matches shadcn/ui conventions
- Shared UI components (e.g. SpeedDial) live in `components/shared/` directory
- To open AddHoldingDialog/AddTransactionDialog programmatically: pass a hidden `<button ref={ref} />` as children, then call `ref.current?.click()`
- CheckInModal uses controlled `open`/`onOpenChange` props — can be opened from any external trigger
- HoldingsTable hybrid grouping: `typeFilter="all"` shows collapsible grouped sections, specific type shows flat list via `HoldingsFlatSection`
- Shared table rendering: `HoldingsTableContent` component handles row rendering for both grouped and flat views
- GroupHeader (components/holdings/group-header.tsx) shows label, count, total value, portfolio % badge — receives calculated values as props
- `calculateGroupTotal()` in holdings-table.tsx converts holdings to display currency — use for any group-level value aggregation
- `motion.create(TableRow)` creates a motion-enhanced `MotionTableRow` for stagger animations on table rows
- Stagger rows use `motion.tbody` as container with `variants` + `initial="hidden" animate="visible"` pattern
- Capped stagger: `Math.min(0.05, 0.5 / count)` ensures total stagger completes within 500ms regardless of row count
- `useReducedMotion()` from framer-motion checks OS prefers-reduced-motion — skip animations entirely when true
- `AnimatePresence mode="popLayout"` on HoldingsTable wraps content keyed by typeFilter — handles enter/exit on tab change
- Holdings table rows are clickable (navigate to `/holdings/[id]`) — action buttons use `stopPropagation` to prevent row click
- Row hover: `hover:bg-accent/5 hover:scale-[1.005] active:bg-accent/10` with `transition-[background-color,transform] duration-150`

---

# UX-3 Holdings UI Enhancement Progress Log

Started: 2026-02-06

---

## 2026-02-06 - US-001: Create animated type filter tabs
- Created `components/holdings/filter-tabs.tsx` with All, Crypto, Stocks, ETFs, Super, Cash, Debt tabs
- Active tab uses Framer Motion `layoutId="active-holding-filter"` for smooth sliding bg-accent/20 pill
- Tab state stored in URL `?type=` search param via `router.replace()`
- Updated holdings page to filter by type + currency (combined filtering)
- Removed `GroupBySelector` import and usage from holdings page
- Added `scrollbar-hide` utility class to globals.css for hidden-scrollbar mobile tabs
- Currency filter + dormant toggle + native currency toggle positioned to the right with `ml-auto`
- `HoldingsTable` now always receives `groupBy="type"` (currency grouping removed from page)
- Files changed: `components/holdings/filter-tabs.tsx` (new), `app/(dashboard)/holdings/page.tsx`, `app/globals.css`
- **Learnings for future iterations:**
  - Zsh shell requires quoting paths with parentheses: `"app/(dashboard)/..."` for git commands
  - The `scrollbar-hide` class is not built into Tailwind — must be added as a custom utility
  - `router.replace()` is preferred over `router.push()` for filter changes to avoid polluting browser history
---

## 2026-02-06 - US-002: Implement hybrid grouping — groups on All, flat list on specific type
- Refactored `HoldingsTable` to support two display modes: grouped (collapsible) and flat
- Extracted table row rendering into shared `HoldingsTableContent` component to avoid duplication
- Created `HoldingsFlatSection` for flat list view (no group header) when specific type filter is active
- Added Framer Motion `AnimatePresence` + `motion.div` for collapse/expand animation (height: 0 → auto, 200ms ease-out)
- Added `ChevronRight` icon that rotates 90° → 0° via `motion.span` on collapse
- Group sections expanded by default (`useState(true)`)
- Empty groups already hidden by existing null return logic
- `HoldingsTable` accepts new `typeFilter` prop; page passes it through
- Files changed: `components/holdings/holdings-table.tsx`, `app/(dashboard)/holdings/page.tsx`
- **Learnings for future iterations:**
  - Framer Motion `AnimatePresence` with `initial={false}` prevents animation on first render — useful for sections that start expanded
  - Use `style={{ overflow: "hidden" }}` on motion container to prevent content from showing during height animation
  - Extracting shared table content into a sub-component keeps grouped vs flat views DRY
  - The `collapsible` prop pattern allows reuse of existing section components with optional collapse behavior
---

## 2026-02-06 - US-003: Add group summary stats
- Created `components/holdings/group-header.tsx` with group name, count, total value (in display currency), and portfolio percentage badge
- Added `calculateGroupTotal()` helper to `holdings-table.tsx` — converts each holding's value from native currency to display currency
- `HoldingsTable` now computes `portfolioTotal` via `useMemo` across all type groups (absolute sum for percentage denominator)
- Each `HoldingsTypeSection` computes its group total and derives `portfolioPercent` from the portfolio total
- Debt groups show total with `text-destructive` colour via `isDebt` prop
- Stats are right-aligned in the group header button via `justify-between`
- Uses design tokens throughout: `text-muted-foreground`, `bg-muted`, `text-destructive`, `text-foreground`
- `CurrencyDisplay` component handles loading states and currency formatting
- Files changed: `components/holdings/group-header.tsx` (new), `components/holdings/holdings-table.tsx`
- **Learnings for future iterations:**
  - Portfolio percentage uses absolute values for both numerator and denominator to handle debt groups correctly
  - The `calculateGroupTotal` function converts each holding individually to display currency before summing (handles mixed-currency groups)
  - `useMemo` with `convert` in dependency array recalculates when display currency changes
  - `GroupHeader` is a separate component to keep `HoldingsTypeSection` focused on table rendering
---

## 2026-02-06 - US-004: Add stagger animation on holdings list
- Added stagger animation to `HoldingsTableContent` rows using Framer Motion variants
- Created `MotionTableRow` via `motion.create(TableRow)` for motion-enhanced table rows
- Replaced `TableBody` with `motion.tbody` as stagger container using `variants` prop with `initial="hidden" animate="visible"`
- Each row uses `rowVariants` with fade-in + slide-up (opacity 0→1, y 10→0) over 200ms ease-out
- Wrapped `HoldingsTable` content in `AnimatePresence mode="popLayout"` keyed by `typeFilter` — handles filter tab changes with 100ms fade out/in
- Implemented capped stagger delay: `Math.min(0.05, 0.5 / count)` ensures total stagger completes within 500ms
- Added `useReducedMotion()` — when OS prefers-reduced-motion is on, all animations are disabled (duration: 0, no transforms)
- Files changed: `components/holdings/holdings-table.tsx`
- **Learnings for future iterations:**
  - `motion.create(ComponentName)` is the v12 API for creating motion-enhanced custom components (replaces deprecated `motion(Component)`)
  - TypeScript narrows ternary types too broadly for Variants — use explicit `Variants` type annotation with `as const` on ease strings to avoid type errors
  - `motion.tbody` can be used directly as a stagger container for table row animations (avoids wrapping divs that break table semantics)
  - `AnimatePresence mode="popLayout"` handles mount/unmount transitions cleanly when keyed by filter state
---

## 2026-02-06 - US-005: Polish table row hover effects
- Updated `MotionTableRow` in `HoldingsTableContent` with hover styles: `hover:bg-accent/5`, `hover:scale-[1.005]`, `active:bg-accent/10`, 150ms transition
- Added `cursor-pointer` and `onClick` handler navigating to `/holdings/[id]` via `router.push()`
- Set `transformOrigin: "center"` via inline style so scale transform doesn't shift rows
- Added `stopPropagation` to Edit and Delete action buttons so they don't trigger row navigation
- Added `stopPropagation` to retry price button in `PriceCell` for the same reason
- Imported `useRouter` from `next/navigation` for programmatic navigation
- `twMerge` in `cn()` correctly overrides `TableRow`'s base `hover:bg-muted/50` with `hover:bg-accent/5`
- Uses CSS `transition-[background-color,transform]` instead of Framer Motion for hover — keeps hover effects lightweight and CSS-only
- Files changed: `components/holdings/holdings-table.tsx`
- **Learnings for future iterations:**
  - `twMerge` handles Tailwind class deduplication — `hover:bg-accent/5` in className prop overrides `hover:bg-muted/50` from `TableRow` base
  - Use CSS transform `scale()` for hover effects instead of padding/margin to avoid layout shift
  - `transition-[background-color,transform]` is more performant than `transition-all` — only animate what changes
  - `stopPropagation` on interactive children (buttons, links) prevents parent row click from firing
  - `transformOrigin: "center"` keeps scale effect visually balanced on table rows
---

## 2026-02-06 - US-006: Create speed-dial floating action button
- Created `components/shared/speed-dial.tsx` — FAB component with expand/collapse animation
- FAB positioned fixed bottom-right (`bottom-6 right-6`), hidden below sm breakpoint (`hidden sm:block`)
- Default state: round `bg-accent` button with Plus icon, `shadow-lg`, `hover:shadow-glow-sm`
- Expands upward with 3 action buttons: Add Holding, Add Transaction, Monthly Check-in
- Each action button has text label + icon in a pill shape (`bg-card border-border`)
- Expand animation: actions stagger in with 50ms delay, main button rotates 45° (+ becomes ×)
- Backdrop overlay (`bg-black/20`) appears when expanded, clicking it collapses
- Respects `useReducedMotion()` — disables all animations when OS prefers-reduced-motion
- Integrated into holdings page via hidden dialog trigger refs for AddHoldingDialog and AddTransactionDialog
- CheckInModal uses controlled `open`/`onOpenChange` state from the page
- `speedDialActions` defined with `useMemo` to avoid unnecessary re-renders
- Files changed: `components/shared/speed-dial.tsx` (new), `app/(dashboard)/holdings/page.tsx`
- **Learnings for future iterations:**
  - `AddHoldingDialog` and `AddTransactionDialog` use uncontrolled `DialogTrigger` pattern — to open programmatically, use a hidden button ref inside the trigger children
  - `CheckInModal` uses controlled `open`/`onOpenChange` props — easier to integrate with external triggers
  - Framer Motion `AnimatePresence` with staggered `transition.delay` per index is cleaner than parent stagger variants for FAB actions (allows per-item control)
  - `hidden sm:block` on the FAB container hides it on mobile (below 640px sm breakpoint)
  - Shared components live in `components/shared/` directory
---

