## Codebase Patterns
- Project uses Next.js 14+ App Router with TypeScript
- Drizzle ORM is already installed (drizzle-orm, drizzle-kit, @neondatabase/serverless)
- shadcn/ui components available in components/ui
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Tailwind CSS with shadcn/ui CSS variable pattern using HSL format: hsl(var(--variable))
- CSS variables stored without hsl() wrapper e.g. --background: 240 10% 3.9%
- Glow shadows use rgba() since HSL variables can't express box-shadow alpha
- Inter font loaded via next/font/google in app/layout.tsx (applied via inter.className on body)
- Framer Motion components require "use client" directive
- Toast notifications use Sonner - import toast from sonner
- Dashboard navigation uses components/layout/sidebar.tsx and components/layout/mobile-nav.tsx
- Tailwind has semantic tokens: text-positive/bg-positive (green), text-negative/bg-negative (red), shadow-glow-sm/md/lg, shadow-glow-positive, shadow-glow-negative, shadow-card, shadow-card-hover
- Layout & spacing constants live in lib/theme.ts (sidebarWidth, cardRadius, spacing xs→2xl) — use instead of magic numbers
- Animation presets live in lib/animations.ts — import and spread onto motion.div elements (e.g. `<motion.div {...fadeIn}>`)
- Stagger presets (staggerContainer, staggerItem) use Variants type with "hidden"/"visible" keys — use with variants prop
- numberSpring is a Transition object for animating numeric values (e.g. useSpring, useMotionValue)
- Reduced motion: use `useReducedMotion()` from framer-motion directly — returns boolean for OS prefers-reduced-motion
- Hooks live in hooks/ directory (not lib/) — follow this convention for custom React hooks
- Recharts SVG props (stroke, fill) require raw hex values — CSS variables not supported in SVG rendering
- Category indicator colours (asset types, currencies) use hardcoded Tailwind colours (bg-blue-500 etc.) — these are intentional and distinct from theme tokens
- Card container pattern: `border-border bg-card/50` for bordered cards, `bg-muted` for skeleton placeholders
- Error state pattern: `border-destructive bg-destructive/10` with `text-destructive` for error messages
- Toggle pattern: active=`bg-muted text-foreground`, inactive=`text-muted-foreground hover:text-foreground`
- Form validation pattern: `border-destructive focus-visible:ring-destructive` on inputs, `text-destructive` on error messages
- Delete confirm button: `bg-destructive hover:bg-destructive/90 text-foreground`; cancel: `bg-card border-border text-foreground hover:bg-muted`
- Select dropdowns: `bg-background border-border text-muted-foreground` for trigger, `focus:bg-card focus:text-foreground` for items
- Warning colours now use text-warning/bg-warning/border-warning design tokens (migrated from amber-* in UX-8)
- Info colours (blue-*) are semantic and intentionally NOT part of design token migration
- Interactive toggle buttons (show/hide contributions): use `text-primary hover:text-primary/80` pattern
- html2canvas backgroundColor requires raw hex — use `#18181b` to match --card token
- Email templates (components/emails/) use inline hex values — email clients don't support CSS variables
- Only legitimate remaining hardcoded grey: `bg-gray-500` fallback in category indicator functions (asset-allocation, currency-exposure)
- TimeRangeSelector (components/charts/time-range-selector.tsx) exports TimeRange type and TIME_RANGE_OPTIONS — import from @/components/charts
- lightweight-charts v5 API: `chart.addSeries(AreaSeries, options)` — not `chart.addAreaSeries(options)` (deprecated)
- TradingView charts require `next/dynamic` with `ssr: false` — use TVChart from components/charts/tv-chart.tsx
- TVChartWrapper supports `onCrosshairMove` callback for custom tooltips — returns TVCrosshairData { time, value, x, y } or null
- TradingView custom tooltip: use absolute positioned div with pointer-events-none overlaying the chart container
- TradingView Time type accepts YYYY-MM-DD date strings cast as `Time` — works for monthly data points
- Navigation items defined in lib/navigation.ts — import navItems and NavItem type from there (sidebar, mobile nav, command menu)
- New layout components live in components/layout/ — NavItemLink (nav-item.tsx) uses Framer Motion layoutId='active-nav' for animated active pill
- TooltipProvider with delayDuration={0} wraps collapsed nav items for instant tooltip display
- Sidebar collapse state persists in localStorage ('mjolnir-sidebar-collapsed') — use mounted state pattern to avoid hydration mismatch
- Sidebar is fixed positioned; content area needs dynamic left margin matching sidebar width (240px or 64px)
- AppShell (components/layout/app-shell.tsx) owns sidebar collapsed state — Sidebar receives isCollapsed/onToggleCollapsed as props
- Content area uses CSS custom property --sidebar-width with responsive Tailwind class ml-0 lg:ml-[var(--sidebar-width)] for responsive dynamic margin
- For responsive dynamic values, use CSS custom properties + Tailwind arbitrary value classes (inline styles can't be responsive)
- PageWrapper (components/layout/page-wrapper.tsx) wraps page content with fade transition — placed inside DashboardErrorBoundary in dashboard layout
- Mobile header (components/layout/mobile-nav.tsx) is fixed h-14 z-30 — content area needs pt-14 on mobile
- Sheet drawer (shadcn/ui) handles focus trapping and Escape close via Radix Dialog primitive
- Focus ring pattern: `focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring` matches shadcn/ui conventions
- Shared UI components (e.g. SpeedDial) live in `components/shared/` directory
- To open AddHoldingDialog/AddTransactionDialog programmatically: pass a hidden `<button ref={ref} />` as children, then call `ref.current?.click()`
- CheckInModal uses controlled `open`/`onOpenChange` props — can be opened from any external trigger
- HoldingsTable hybrid grouping: `typeFilter="all"` shows collapsible grouped sections, specific type shows flat list via `HoldingsFlatSection`
- Shared table rendering: `HoldingsTableContent` component handles row rendering for both grouped and flat views
- GroupHeader (components/holdings/group-header.tsx) shows label, count, total value, portfolio % badge — receives calculated values as props
- `calculateGroupTotal()` in holdings-table.tsx converts holdings to display currency — use for any group-level value aggregation
- `motion.create(TableRow)` creates a motion-enhanced `MotionTableRow` for stagger animations on table rows
- Stagger rows use `motion.tbody` as container with `variants` + `initial="hidden" animate="visible"` pattern
- Capped stagger: `Math.min(0.05, 0.5 / count)` ensures total stagger completes within 500ms regardless of row count
- `useReducedMotion()` from framer-motion checks OS prefers-reduced-motion — skip animations entirely when true
- Dormant holdings sorted to bottom of each group via `useMemo` sort in `HoldingsTableContent` and `HoldingsCurrencySection`
- EmptyState component (`components/ui/empty-state.tsx`) is shared across holdings, snapshots, transactions — keep prop API stable
- `AnimatePresence mode="popLayout"` on HoldingsTable wraps content keyed by typeFilter — handles enter/exit on tab change
- Holdings table rows are clickable (navigate to `/holdings/[id]`) — action buttons use `stopPropagation` to prevent row click
- Row hover: `hover:bg-accent/5 hover:scale-[1.005] active:bg-accent/10` with `transition-[background-color,transform] duration-150`
- Filter tabs (components/holdings/filter-tabs.tsx) use Framer Motion layoutId for animated sliding indicator
- scrollbar-hide utility class added to globals.css for hidden scrollbar on overflow-x-auto elements
- TypeSelector (components/transactions/type-selector.tsx) uses layoutId="active-transaction-type" for animated tab indicator
- react-hook-form + zod installed; shadcn/ui form.tsx component available in components/ui/form.tsx
- z.coerce.number() with useForm requires casting resolver: `zodResolver(schema) as unknown as Resolver<FormValues>`
- For numeric inputs with z.coerce: pass `field.value ?? ""` to prevent "undefined" showing
- TransactionSummary cards use stagger animation with motion.div and variants pattern
- Transaction table uses monthly grouping with sticky headers (sticky top-0 z-20 bg-background)
- MotionTableRow with stagger variants + AnimatePresence mode="wait" keyed by filterKey for table animations
- Transaction action colour mapping: BUY=positive/green, SELL=destructive/red, DIVIDEND=accent/purple, SPLIT=blue-400/blue-500
- onTransactionSaved/onDeleted callbacks enable row highlight and fade-out animations from parent component
- Check-in form uses react-hook-form + zod with useFieldArray for dynamic holdings list; showContributions is UI-only state (not in form schema)
- useFieldArray `replace()` syncs form fields with API data; use a ref-based sync key to prevent re-replacing on every render
- form.trigger(`holdings.${idx}.balance`) validates individual field array items for per-step validation in wizard flows
- form.setValue with `{ shouldValidate: form.formState.isSubmitted }` re-validates on change only after first validation attempt
- Check-in status API returns `previousBalances` keyed by holdingId — most recent snapshot balance before target month
- CheckInModal is a 3-step wizard (Select Month → Update Holdings → Review & Save) with currentStep state (0-2)
- animate-shake keyframes defined in tailwind.config.ts — use `animate-shake` class with useState toggle + setTimeout auto-clear
- Type icon mapping: super=Landmark, cash=Wallet, debt=CreditCard (from lucide-react)
- CheckinPrompt (components/dashboard/checkin-prompt.tsx) replaces CheckInPromptCard — moved to dashboard/ directory
- sessionStorage dismissal pattern: use `mounted` state + useEffect to avoid hydration mismatch when reading sessionStorage
- Accent glow prompt card: `border-accent/30 bg-card/50 shadow-glow-sm` for attention-grabbing cards
- Directional step transitions: use variants with `custom` prop on AnimatePresence to pass direction to exiting components — enter slides from `100*d%`, exit slides to `-100*d%` (d=1 forward, d=-1 backward)
- Step container needs `overflow-hidden` to clip sliding content during transitions
- Accordion expand animation: `motion.div` with `height: 0` → `height: "auto"`, `overflow-hidden`, wrapped in `AnimatePresence initial={false}`
- Check-in status API returns `latestContributions` for pre-populating super contribution fields
- Success summary pattern: store mutation result in state + `showSuccess` boolean, render different content in same step (no extra wizard step)
- CheckinStepper accepts currentStep=3 (beyond max) to mark all steps completed — no code change needed in stepper
- NumberTicker component (components/dashboard/number-ticker.tsx) animates currency values using useSpring + useMotionValue; tabular-nums prevents layout shift
- ChangeBadge component (components/dashboard/change-badge.tsx) shows positive/negative/zero with TrendingUp/TrendingDown/Minus icons; size="sm"|"md"
- StaleIndicator component (components/dashboard/stale-indicator.tsx) shows amber warning with tooltip (icon variant) or inline text (badge variant)
- framer-motion v12 `useSpring` subscribes via `.on("change", cb)` — use this to update textContent directly for performance
- Dashboard sections stagger in via motion.div container (80ms delay) with fadeIn+slideUp (opacity 0→1, y 16→0, 300ms easeOut)
- Progress bar animation: use useState(0) → useEffect setTimeout → setState(target) with CSS transition
- Donut centre overlay: absolute positioned div with pointer-events-none, marginBottom to offset legend
- Chart hex colours (#374151, #9CA3AF etc.) are required for SVG rendering — don't convert to CSS variables
- Grid gap-6 for section spacing, gap-4 only for small internal layouts
- All card-level elements use rounded-2xl; inner elements (tooltips, icons, row items) keep rounded-lg
- Yahoo Finance `chart()` method: `yahooFinance.chart(symbol, { period1, period2, interval: "1d" })` returns `{ quotes: [{ close }] }`
- CoinGecko market_chart: `/coins/{id}/market_chart?vs_currency=usd&days=30&interval=daily` returns `{ prices: [[timestamp, price]] }`
- Sparkline data API: `GET /api/prices/sparkline` returns `{ holdingId, symbol, prices: number[] }[]` — staleTime 30min
- SVG elements (non-Recharts) can use `stroke="currentColor"` with Tailwind `text-*` classes — avoids hardcoded hex
- ChartSkeleton uses ChartCard wrapper when `withContainer=true` — consistent with all chart sections
- All chart tooltips use `bg-card` (not `bg-background`) for consistent elevated surface styling
- Chart hex colours centralised in `lib/chart-palette.ts` — import CHART_GRID, CHART_TEXT, CHART_AXIS, POSITIVE, NEGATIVE, etc. instead of hardcoding hex
- Category asset type colours (STOCK, ETF, CRYPTO, SUPER, CASH) also in chart-palette.ts — use in getAssetHexColor() and similar functions
- PriceFlash (components/holdings/price-flash.tsx) wraps children with green/red flash on value change — use `<PriceFlash value={num}>{children}</PriceFlash>`
- PriceNumberTicker (components/holdings/price-number-ticker.tsx) animates price digits with spring animation — prefix prop stays static, only digits animate
- PriceTimestamp (components/holdings/price-timestamp.tsx) shows relative time + tooltip with exact time — three states: fresh/stale/error
- PriceSkeleton (components/holdings/price-skeleton.tsx) loading skeleton for price cells — variant="price" (3-bar) or variant="value" (single-bar)
- TanStack Query: `isFetching && !isLoading` detects background refetches without triggering initial skeleton

---

# UX-8 Live Price UI Progress Log

Started: 2026-02-06

---

## 2026-02-06 - US-001
- Created `components/holdings/price-flash.tsx` — wrapper component that flashes green (bg-positive/20) on value increase and red (bg-destructive/20) on value decrease
- Uses useRef to track previous value, skips flash on initial mount
- CSS transition (400ms) for smooth flash-to-transparent, no full re-render
- Respects `prefers-reduced-motion` via framer-motion `useReducedMotion()`
- Files changed: `components/holdings/price-flash.tsx` (new)
- **Learnings for future iterations:**
  - PriceFlash uses inline-block + rounded-sm for minimal layout impact when wrapping table cell content
  - bg-transparent is the explicit "no flash" state — ensures the transition works correctly from coloured → transparent
---

## 2026-02-06 - US-002
- Created `components/holdings/price-number-ticker.tsx` — lightweight number ticker for price cells
- Updated PriceCell in `holdings-table.tsx` to wrap price in PriceFlash + PriceNumberTicker
- Currency prefix (A$, NZ$, US$) rendered as static `<span>`, only digits animate
- Change percentage crossfades on update using AnimatePresence mode="wait" (150ms)
- Removed unused `formatPrice` function (replaced by PriceNumberTicker)
- Files changed: `components/holdings/price-number-ticker.tsx` (new), `components/holdings/holdings-table.tsx` (modified)
- **Learnings for future iterations:**
  - PriceNumberTicker is separate from dashboard NumberTicker — simpler, no formatCurrency dependency, uses will-change:transform for table perf
  - AnimatePresence mode="wait" with key={`${changePercent}-${changeAbsolute}`} ensures crossfade only on actual value changes
---

## 2026-02-06 - US-003
- Enhanced refresh button in `dashboard-header.tsx`: shows "Refreshing..." with spinning RefreshCw icon during refresh
- Toast on completion: success="Refreshed X prices", partial failure=warning "Refreshed X prices, Y failed"
- API now returns total count alongside success/errors
- Removed mobile-only "..." text (spinner icon is sufficient on small screens)
- Files changed: `components/dashboard/dashboard-header.tsx` (modified)
- **Learnings for future iterations:**
  - The prices POST API returns all results at once (Promise.all), no streaming — so real-time X/Y counter isn't possible without API changes
  - Use toast.warning() (not toast.success) for partial failure scenarios
---

## 2026-02-06 - US-004
- Created `components/holdings/price-timestamp.tsx` — dedicated timestamp display with tooltip
- Shows relative time ("just now", "2 min ago", etc.) that auto-updates every 30 seconds
- Tooltip shows exact timestamp on hover via shadcn/ui Tooltip
- Three visual states: fresh (Clock, muted), stale (AlertTriangle, text-warning), error (AlertTriangle, text-destructive + "(failed)")
- Replaced inline timestamp logic in PriceCell; removed unused `formatTimeAgo`
- Files changed: `components/holdings/price-timestamp.tsx` (new), `components/holdings/holdings-table.tsx` (modified)
- **Learnings for future iterations:**
  - Each PriceTimestamp wraps its own TooltipProvider for table cell isolation
---

## 2026-02-06 - US-005
- Polished retry button in PriceCell: pill-shaped (rounded-full px-2 py-0.5) with RotateCw icon + "Retry" text
- Default: bg-muted text-muted-foreground, hover: bg-accent/20 text-foreground
- Retrying state: icon spins, text "Retrying...", button disabled
- AnimatePresence wraps retry button for fade in/out entrance/exit animations
- Files changed: `components/holdings/holdings-table.tsx` (modified)
---

## 2026-02-06 - US-006
- Created `components/holdings/price-skeleton.tsx` with two variants: "price" (3-bar skeleton) and "value" (single-bar)
- Replaced "Loading..." text in PriceCell with PriceSkeleton variant="price"
- Replaced CurrencyDisplay isLoading in MarketValueCell and GainLossCell with PriceSkeleton variant="value"
- All skeletons use bg-muted + animate-pulse (design tokens)
- Files changed: `components/holdings/price-skeleton.tsx` (new), `components/holdings/holdings-table.tsx` (modified)
---

## 2026-02-06 - US-007
- Stale prices: price text dimmed to text-muted-foreground, amber left border (border-l-2 border-warning/50)
- Fresh prices: border-transparent (invisible), transition-all duration-200 for smooth stale↔fresh toggle
- PriceTimestamp already handles amber warning styling (US-004)
- Both fresh and stale states use border-l-2 + pl-2 to prevent layout shift on state change
- Files changed: `components/holdings/holdings-table.tsx` (modified)
---

## 2026-02-06 - US-008
- Three-state change indicator: positive (TrendingUp, text-positive), negative (TrendingDown, text-destructive), zero (Minus, text-muted-foreground)
- AnimatePresence key based on direction ("up"/"down"/"zero") — crossfades (150ms) on direction change
- Absolute change value shown in parentheses with text-muted-foreground
- All colours already use design tokens (text-positive, text-destructive)
- Files changed: `components/holdings/holdings-table.tsx` (modified)
---

## 2026-02-06 - US-009
- Added `pricesRefreshing` prop threaded through HoldingsTable → Section → TableContent → PriceCell
- PriceCell shows `animate-pulse` class when refreshing — subtle indicator without replacing content
- Holdings page derives `pricesRefreshingState` from: mutation isPending + TanStack Query isFetching (but not initial isLoading)
- Background auto-refresh uses same pulse treatment (no toast — existing behavior)
- Files changed: `app/(dashboard)/holdings/page.tsx` (modified), `components/holdings/holdings-table.tsx` (modified)
- **Learnings for future iterations:**
  - TanStack Query `isFetching` is true during both initial load AND refetches; `isLoading` is only true for initial load
  - Use `(isFetching && !isLoading)` to detect background refetches without triggering during initial skeleton load
  - Existing `isRefreshing` variable in holdings page conflicts — use distinct name (`pricesRefreshingState`)
---

## 2026-02-06 - US-010
- Replaced text-yellow-400 → text-warning in holdings-table.tsx (2 instances for snapshot staleness)
- Replaced all amber-* hardcoded colours in stale-data-warning.tsx with design tokens:
  - border-amber-500/30 → border-warning/30
  - bg-amber-500/10 → bg-warning/10
  - text-amber-500 → text-warning
  - text-amber-400 → text-warning
  - bg-amber-950/20 → bg-background
  - bg-amber-950/30 → bg-muted
- dashboard-header.tsx and holdings/page.tsx had no hardcoded colours
- Files changed: `components/holdings/holdings-table.tsx`, `components/dashboard/stale-data-warning.tsx`
---

