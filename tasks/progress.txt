## Codebase Patterns
- Project uses Next.js 16+ App Router with TypeScript
- Drizzle ORM is already installed (`drizzle-orm`, `drizzle-kit`, `@neondatabase/serverless`)
- shadcn/ui components available in `components/ui`
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Next.js 16 doesn't have `next lint` command - use `eslint .` directly

- Database module uses lazy initialization via Proxy to avoid build-time errors when DATABASE_URL is not set
- Use `sql` template tag from drizzle-orm for raw SQL queries with `db.execute(sql\`...\`)`
- ClerkProvider conditionally renders based on NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY to allow builds without Clerk keys
- Use `export const dynamic = "force-dynamic"` for pages/layouts that use Clerk components
- Dashboard routes at `/dashboard` and `/profile` are protected; landing page `/` is public
- Auth pages use `(auth)` route group; dashboard uses `(dashboard)` route group

- Drizzle migrations are stored in `drizzle/` directory and should be committed to git
- The holdings schema already exists in `lib/db/schema.ts` with all required fields

- TanStack Query provider is in `components/providers/query-provider.tsx` - wrap layouts with QueryProvider
- ClerkProvider wrapper is in `components/providers/clerk-provider.tsx` - handles missing Clerk keys gracefully
- Use `useAuthSafe` hook from `lib/hooks/use-auth-safe.ts` for client-side auth state that works with/without Clerk
- Holdings page is at `/holdings` using `app/(dashboard)/holdings/page.tsx`

- Toast notifications use Sonner - import `toast` from `sonner` and use `toast.success()` / `toast.error()`
- Toaster component is in root layout; for dark mode only, hardcode `theme="dark"` in Sonner component

- Dashboard navigation uses `components/dashboard/nav.tsx` with usePathname for active state
- Navigation items defined in array for easy extension
- ESLint no-case-declarations: wrap switch case blocks containing `const`/`let` declarations in braces `{ }`

---

# W-4 Transaction Tracking Progress Log

## 2026-02-01 - US-001
- What was implemented:
  - Updated transactionActionEnum to include DIVIDEND and SPLIT action types
  - Modified transactions table decimal precision from (20,8) to (18,8) per acceptance criteria
  - Added updatedAt timestamp field with default now()
  - Added deletedAt timestamp field for soft delete support
- Files changed:
  - lib/db/schema.ts - schema updates
  - drizzle/0001_silly_silver_surfer.sql - generated migration
  - drizzle/meta/_journal.json - migration metadata
  - drizzle/meta/0001_snapshot.json - schema snapshot
- **Learnings for future iterations:**
  - The transactions table already existed in schema.ts from a previous epic, only needed updates
  - Migration cannot be run without DATABASE_URL - this is expected for local dev without DB connection
  - npm dependencies may need to be installed if node_modules is missing (`npm install`)
---

## 2026-02-01 - US-002
- What was implemented:
  - Created GET /api/transactions endpoint with holding_id filter support
  - Created GET /api/transactions/[id] endpoint for single transaction retrieval
  - Both endpoints join with holdings table to include holding name/symbol
  - Auth enforced via Clerk - returns 401 if not authenticated
  - User ownership validated via holdings.userId join
  - Results sorted by date descending (newest first)
- Files changed:
  - app/api/transactions/route.ts - GET handler for listing transactions
  - app/api/transactions/[id]/route.ts - GET handler for single transaction
- **Learnings for future iterations:**
  - Use innerJoin with holdings table to both include holding info AND validate user ownership
  - Next.js 16 uses `params: Promise<{ id: string }>` pattern for dynamic route params
  - Follow existing holdings API patterns for consistency (error formats, auth checks)
---

## 2026-02-01 - US-003
- What was implemented:
  - Added POST handler to /api/transactions for creating new transactions
  - Full validation: required fields, date format (YYYY-MM-DD), numeric fields
  - Holding validation: checks existence, user ownership, tradeable type (stock/etf/crypto only)
  - Returns 201 with created transaction on success
  - Returns 400 with errors object on validation failure
- Files changed:
  - app/api/transactions/route.ts - added POST handler with validation
- **Learnings for future iterations:**
  - Follow holdings API pattern for POST endpoints: try/catch JSON parse, errors object for validation
  - NewTransaction type uses strings for decimal fields (quantity, unitPrice, fees)
  - Tradeable types are stock, etf, crypto - other types (super, cash, debt) use snapshots instead
---

## 2026-02-01 - US-004
- What was implemented:
  - Created `lib/calculations/quantity.ts` with `calculateQuantityHeld(holdingId)` function
  - Handles BUY (adds to quantity), SELL (subtracts), SPLIT (multiplies), DIVIDEND (no effect)
  - Processes transactions chronologically (ordered by date ascending)
  - Only includes non-deleted transactions (filters by deletedAt IS NULL)
- Files changed:
  - lib/calculations/quantity.ts - new file
- **Learnings for future iterations:**
  - `lib/calculations/` directory exists but was empty - meant for calculation helper functions
  - Decimal fields from Drizzle come as strings, need Number() conversion for arithmetic
  - SPLIT ratio stored in quantity field (e.g., 2:1 split = quantity of 2, multiplies holdings)
---

## 2026-02-01 - US-005
- What was implemented:
  - Added SELL quantity validation to POST handler in /api/transactions
  - Imports and uses calculateQuantityHeld helper to get current holdings
  - Validates sell quantity doesn't exceed current holdings for SELL action
  - Returns 400 with errors.quantity = "Sell quantity exceeds holdings" if exceeded
- Files changed:
  - app/api/transactions/route.ts - added SELL validation logic
- **Learnings for future iterations:**
  - Validation for SELL should run after holding validation passes (needs valid holding_id)
  - Also check !errors.quantity to avoid redundant validation if quantity already invalid
  - calculateQuantityHeld is reusable for both API validation and UI display
---

## 2026-02-01 - US-006
- What was implemented:
  - Added PATCH handler to /api/transactions/[id] for updating transactions
  - PATCH allows updating: date, quantity, unit_price, fees, notes
  - PATCH validates SELL quantity against holdings EXCLUDING current transaction
  - Added DELETE handler that performs soft delete (sets deleted_at timestamp)
  - Both endpoints verify transaction exists and belongs to user via holdings join
  - Both return 404 if transaction not found, 401 if not authenticated
- Files changed:
  - app/api/transactions/[id]/route.ts - added PATCH and DELETE handlers
- **Learnings for future iterations:**
  - For PATCH SELL validation, must exclude current transaction from quantity calculation to avoid double-counting
  - Use `ne(transactions.id, id)` from drizzle-orm to exclude a specific record
  - Soft delete should set both deletedAt AND updatedAt timestamps
  - Don't import calculateQuantityHeld if doing inline calculation - avoids lint errors for unused imports
---

## 2026-02-01 - US-007
- What was implemented:
  - Created `lib/calculations/cost-basis.ts` with `calculateCostBasis(holdingId)` function
  - Returns `{ costBasis: number, quantity: number, lots: Lot[] }`
  - FIFO methodology: BUY creates new lots, SELL consumes from oldest lots first
  - SPLIT adjusts all existing lots proportionally (quantity * ratio, price / ratio)
  - DIVIDEND does not affect cost basis
  - Only includes non-deleted transactions (filters by deletedAt IS NULL)
  - Exported `Lot` and `CostBasisResult` interfaces for type safety
- Files changed:
  - lib/calculations/cost-basis.ts - new file
- **Learnings for future iterations:**
  - ESLint no-case-declarations rule requires wrapping case blocks with lexical declarations (`const`, `let`) in braces `{ }`
  - SPLIT affects both lot.quantity AND lot.unitPrice to maintain total value invariant
  - Filter out lots with remainingQuantity <= 0 before returning to only show active lots
  - Cost basis pattern mirrors quantity calculation but tracks individual lots instead of running total
---

## 2026-02-01 - US-008
- What was implemented:
  - Added 'Transactions' link to dashboard navigation in `components/dashboard/nav.tsx`
  - Link navigates to `/transactions` route
  - Active state already handled by existing `isActive` logic comparing pathname to href
- Files changed:
  - components/dashboard/nav.tsx - added Transactions entry to navItems array
- **Learnings for future iterations:**
  - Navigation extension is simple: just add entry to navItems array with { href, label }
  - Active state styling is handled by existing isActive comparison
---

## 2026-02-01 - US-009
- What was implemented:
  - Created transactions list page at `app/(dashboard)/transactions/page.tsx`
  - Table with columns: Date, Holding, Action, Quantity, Unit Price, Fees, Total
  - Total calculation: BUY = (qty * price) + fees, SELL = (qty * price) - fees, SPLIT = 0
  - Color-coded action badges: green (BUY/DIVIDEND), red (SELL), blue (SPLIT)
  - Loading states: auth loading, data fetching, error state, empty state
  - Protected via `useAuthSafe` hook and `enabled: isLoaded && isSignedIn` on query
- Files changed:
  - app/(dashboard)/transactions/page.tsx - new page file
- **Learnings for future iterations:**
  - Follow holdings page pattern: useAuthSafe hook, multiple loading/error/empty states
  - SPLIT transactions display quantity as "X:1" ratio format (e.g., "2:1" for 2-for-1 split)
  - Use `font-mono` class for numeric columns to align digits properly
  - Format dates with toLocaleDateString("en-AU", { day: "numeric", month: "short", year: "numeric" })
  - Transaction API returns `holding` nested object with name, symbol, type, currency, exchange
---

## 2026-02-01 - US-010
- What was implemented:
  - Added holding filter dropdown to transactions page (fetches tradeable holdings: stock, etf, crypto)
  - Added action type filter with options: All, BUY, SELL, DIVIDEND, SPLIT
  - Filters persist in URL search params (?holding_id=&action=)
  - Updated GET /api/transactions to support `?action=` filter parameter
  - Empty state messaging changes based on whether filters are applied
- Files changed:
  - app/api/transactions/route.ts - added action filter support to GET endpoint
  - app/(dashboard)/transactions/page.tsx - added filter controls, URL param persistence
- **Learnings for future iterations:**
  - Use `useSearchParams` and `useRouter` from next/navigation for URL param filtering (same pattern as holdings page)
  - Radix Select requires a non-empty value; use "all" as placeholder value and convert to null for API
  - Fetch holdings with `?include_dormant=true` then filter client-side to get all tradeable types
  - Filter controls should be shown even during loading/error states so users can still adjust them
  - Query key should include filter values to refetch when filters change: `["transactions", { holdingId, action }]`
---

