# Ralph Progress Log — B4: Budget Dashboard & Sankey
# This file is reset at the start of each epic.

## Codebase Patterns
- visx packages require alpha v4.0.1-alpha.0 for React 19 compat — stable v3 only supports React 16-18
- Budget tables: budgetPeriods, budgetAllocations, budgetCategories, upTransactions in lib/db/schema.ts
- DB import: `import { db } from "@/lib/db"` with Drizzle ORM
- Budget categories use string slug IDs (e.g. "groceries", "income")
- Income category ID is "income" with isIncome=true
- Amounts stored in cents as bigint (mode: "number")
- Transactions: negative amountCents = debit, positive = credit
- Exclude transfers: `eq(upTransactions.isTransfer, false)`, soft-deletes: `isNull(upTransactions.deletedAt)`
- Calculation functions return rich typed objects (see lib/calculations/net-worth.ts for pattern)
- Use Promise.all for concurrent DB queries where possible
- Dashboard pages: use `useAuthSafe()` + `useQuery` pattern with `enabled: isLoaded && isSignedIn`
- Query key for budget summary: `queryKeys.budget.summary(periodId)` — accepts optional periodId
- `EmptyState` component: pass `icon`, `title`, `description`, optional `action` (ReactNode)
- Navigation: add new items to `navItems` array in `lib/navigation.ts` with `{ href, label, icon, description }`
- Format cents to AUD: `(cents / 100).toLocaleString("en-AU", { style: "currency", currency: "AUD" })`
- Budget components directory: `components/budget/` — SankeyChart, SankeyChartContainer, etc.
- Responsive chart pattern: Container component with ResizeObserver measures width, passes to SVG chart component
- visx Sankey uses children render function: `{({ graph, createPath }) => <Group>...</Group>}`

## 2026-02-08 - B4-001
- What was implemented: Budget summary calculation engine in lib/budget/summary.ts
- Files changed: lib/budget/summary.ts (new)
- **Learnings for future iterations:**
  - Don't destructure placeholder values from Promise.all — causes unused variable lint errors
  - Two-phase fetch needed: first get period dates, then fetch income/spending with those dates
  - SQL aggregation pattern: `sql<number>\`COALESCE(SUM(col), 0)\`` for safe nulls
  - Category status thresholds: under (<80%), warning (80-100%), over (>100%)
---

## 2026-02-08 - B4-002
- What was implemented: Budget summary API endpoint at app/api/budget/summary/route.ts
- Files changed: app/api/budget/summary/route.ts (new)
- **Learnings for future iterations:**
  - Use `withAuth(handler, "context")` pattern for all API routes — provides auth + error handling
  - `withAuth` catches thrown errors, but handle specific error cases (like 404) before they reach the wrapper to return custom response shapes (e.g. including `setupUrl`)
  - For "find current period" queries: use `lte(startDate, today)` + `gte(endDate, today)` to match today against the date range
  - Query params use snake_case convention (e.g. `period_id`)
---

## 2026-02-08 - B4-003
- What was implemented: Installed visx and d3-sankey charting dependencies
- Files changed: package.json, package-lock.json
- **Learnings for future iterations:**
  - visx stable (v3.12.0) only supports React 16-18 peer deps — use alpha v4.0.1-alpha.0 for React 19
  - d3-sankey and @types/d3-sankey have no React peer deps, install at latest stable
  - @types/d3-sankey was already present as a transitive dependency
---

## 2026-02-08 - B4-004
- What was implemented: Budget dashboard page layout at app/(dashboard)/budget/page.tsx
- Files changed: app/(dashboard)/budget/page.tsx (new), lib/navigation.ts (added Budget link), lib/query-keys.ts (added summary key)
- **Learnings for future iterations:**
  - Avoid `useState` for values that won't be set in the current story — use `const` with a comment noting which story will replace it
  - Lint catches unused `setPeriodId` from `useState` — if you don't use the setter yet, use a plain variable instead
  - Category card grid pattern: `grid-cols-2 md:grid-cols-3 lg:grid-cols-4` fits the Mjolnir dashboard style
  - Placeholder areas for future components should use descriptive divs (not empty) so layout is visible during development
  - `export const dynamic = "force-dynamic"` required on all dashboard pages
---

## 2026-02-08 - B4-005
- What was implemented: Sankey chart component for desktop budget visualisation
- Files changed: components/budget/SankeyChart.tsx (new), components/budget/SankeyChartContainer.tsx (new), app/(dashboard)/budget/page.tsx (integrated chart)
- **Learnings for future iterations:**
  - `@visx/sankey` Sankey component uses a children render function pattern: `{({ graph, createPath }) => ...}`
  - Graph data shape: `{ nodes: NodeExtra[], links: { source: number, target: number, value: number }[] }` — source/target are node indices
  - After d3-sankey layout, `link.source` and `link.target` become full node objects, not indices — cast accordingly
  - ResizeObserver pattern for responsive SVG: container div + useEffect observer → pass measured width to chart
  - `hidden md:block` on container for desktop-only; `md:hidden` for mobile fallback — both in same parent
  - Tooltip positioning: get SVG bounding rect via ref, subtract from `e.clientX/Y` for relative coords
  - Don't import unused types from summary — lint catches `CategoryBreakdown` if not used
  - Don't assign intermediate variables you won't use (e.g. `sourceNode`) — lint catches these
---

## 2026-02-08 - B4-006
- What was implemented: Mobile budget chart fallback with horizontal progress bars per category
- Files changed: components/budget/MobileBudgetChart.tsx (new), app/(dashboard)/budget/page.tsx (integrated)
- **Learnings for future iterations:**
  - Mobile-only component uses `md:hidden` class on root div; desktop chart container uses `hidden md:block` — both coexist in same parent
  - Use `active:bg-card/50` instead of `hover:` for touch interactions on mobile
  - StatusIcon pattern: small function component with switch on status string for clean icon rendering
  - `shrink-0` on icons prevents flex shrink when category names are long
  - Summary row at bottom uses `border-t border-border pt-1.5` to visually separate savings from totals
---

## 2026-02-08 - B4-007
- What was implemented: CategoryCard component extracted from inline rendering in budget dashboard
- Files changed: components/budget/CategoryCard.tsx (new), app/(dashboard)/budget/page.tsx (replaced inline cards with CategoryCard)
- **Learnings for future iterations:**
  - Extract inline card rendering into dedicated component when it has multiple data-driven states (under/warning/over)
  - CategoryCard accepts `category: CategoryBreakdown`, `periodStart`, `periodEnd` — keeps period context outside the component
  - Remaining amount text pattern: `${formatCents(remainingCents)} left` or `${formatCents(abs)} over` with colour-coded status
  - `min-w-0` on flex container with `truncate` child prevents text overflow in card layouts
---

## 2026-02-08 - B4-008
- What was implemented: PaydayCountdown component that fetches payday config and shows countdown
- Files changed: components/budget/PaydayCountdown.tsx (new), app/(dashboard)/budget/page.tsx (integrated)
- **Learnings for future iterations:**
  - `getDaysUntilPayday` and `findNextPayday` from lib/budget/payday.ts are pure functions — safe to call client-side without DB
  - PaydayCountdown fetches its own payday config from /api/budget/payday — self-contained, only needs daysElapsed/totalDays from parent
  - Use long staleTime (30min) for config data that rarely changes
  - Component returns null while config is loading — prevents flash of skeleton for secondary info cards
---

## 2026-02-08 - B4-009
- What was implemented: SavingsIndicator component with current savings, rate, projection, and on-track indicator
- Files changed: components/budget/SavingsIndicator.tsx (new), app/(dashboard)/budget/page.tsx (integrated in 2-col grid with PaydayCountdown)
- **Learnings for future iterations:**
  - Linear extrapolation: `projectedSpent = (spentCents / daysElapsed) * totalDays` — only compute when daysElapsed > 0
  - Colour thresholds for savings: green ≥30%, amber 25-30%, red <25%
  - Use projected rate mid-period but actual rate when period is complete (daysElapsed < totalDays check)
  - PaydayCountdown and SavingsIndicator pair well in `grid grid-cols-1 md:grid-cols-2` layout
---
