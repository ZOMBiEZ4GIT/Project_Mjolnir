## Codebase Patterns
- Project uses Next.js 14+ App Router with TypeScript
- Drizzle ORM is already installed (drizzle-orm, drizzle-kit, @neondatabase/serverless)
- shadcn/ui components available in components/ui
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Tailwind CSS with shadcn/ui CSS variable pattern using HSL format: hsl(var(--variable))
- CSS variables stored without hsl() wrapper e.g. --background: 240 10% 3.9%
- Glow shadows use rgba() since HSL variables can't express box-shadow alpha
- Inter font loaded via next/font/google in app/layout.tsx (applied via inter.className on body)
- Framer Motion components require "use client" directive
- Toast notifications use Sonner - import toast from sonner
- Dashboard navigation uses components/layout/sidebar.tsx and components/layout/mobile-nav.tsx
- Tailwind has semantic tokens: text-positive/bg-positive (green), text-negative/bg-negative (red), shadow-glow-sm/md/lg, shadow-glow-positive, shadow-glow-negative, shadow-card, shadow-card-hover
- Layout & spacing constants live in lib/theme.ts (sidebarWidth, cardRadius, spacing xs→2xl) — use instead of magic numbers
- Animation presets live in lib/animations.ts — import and spread onto motion.div elements (e.g. `<motion.div {...fadeIn}>`)
- Stagger presets (staggerContainer, staggerItem) use Variants type with "hidden"/"visible" keys — use with variants prop
- numberSpring is a Transition object for animating numeric values (e.g. useSpring, useMotionValue)
- Reduced motion: use `useReducedMotion()` from framer-motion directly — returns boolean for OS prefers-reduced-motion
- Hooks live in hooks/ directory (not lib/) — follow this convention for custom React hooks
- Recharts SVG props (stroke, fill) require raw hex values — CSS variables not supported in SVG rendering
- Category indicator colours (asset types, currencies) use hardcoded Tailwind colours (bg-blue-500 etc.) — these are intentional and distinct from theme tokens
- Card container pattern: `border-border bg-card/50` for bordered cards, `bg-muted` for skeleton placeholders
- Error state pattern: `border-destructive bg-destructive/10` with `text-destructive` for error messages
- Toggle pattern: active=`bg-muted text-foreground`, inactive=`text-muted-foreground hover:text-foreground`
- Form validation pattern: `border-destructive focus-visible:ring-destructive` on inputs, `text-destructive` on error messages
- Delete confirm button: `bg-destructive hover:bg-destructive/90 text-foreground`; cancel: `bg-card border-border text-foreground hover:bg-muted`
- Select dropdowns: `bg-background border-border text-muted-foreground` for trigger, `focus:bg-card focus:text-foreground` for items
- Warning/info colours (yellow-*, blue-*) are semantic and intentionally NOT part of design token migration
- Interactive toggle buttons (show/hide contributions): use `text-primary hover:text-primary/80` pattern
- html2canvas backgroundColor requires raw hex — use `#18181b` to match --card token
- Email templates (components/emails/) use inline hex values — email clients don't support CSS variables
- Only legitimate remaining hardcoded grey: `bg-gray-500` fallback in category indicator functions (asset-allocation, currency-exposure)
- Navigation items defined in lib/navigation.ts — import navItems and NavItem type from there (sidebar, mobile nav, command menu)
- New layout components live in components/layout/ — NavItemLink (nav-item.tsx) uses Framer Motion layoutId='active-nav' for animated active pill
- TooltipProvider with delayDuration={0} wraps collapsed nav items for instant tooltip display
- Sidebar collapse state persists in localStorage ('mjolnir-sidebar-collapsed') — use mounted state pattern to avoid hydration mismatch
- Sidebar is fixed positioned; content area needs dynamic left margin matching sidebar width (240px or 64px)
- AppShell (components/layout/app-shell.tsx) owns sidebar collapsed state — Sidebar receives isCollapsed/onToggleCollapsed as props
- Content area uses CSS custom property --sidebar-width with responsive Tailwind class ml-0 lg:ml-[var(--sidebar-width)] for responsive dynamic margin
- For responsive dynamic values, use CSS custom properties + Tailwind arbitrary value classes (inline styles can't be responsive)
- PageWrapper (components/layout/page-wrapper.tsx) wraps page content with fade transition — placed inside DashboardErrorBoundary in dashboard layout
- Mobile header (components/layout/mobile-nav.tsx) is fixed h-14 z-30 — content area needs pt-14 on mobile
- Sheet drawer (shadcn/ui) handles focus trapping and Escape close via Radix Dialog primitive
- Focus ring pattern: `focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring` matches shadcn/ui conventions
- Shared UI components (e.g. SpeedDial) live in `components/shared/` directory
- To open AddHoldingDialog/AddTransactionDialog programmatically: pass a hidden `<button ref={ref} />` as children, then call `ref.current?.click()`
- CheckInModal uses controlled `open`/`onOpenChange` props — can be opened from any external trigger
- HoldingsTable hybrid grouping: `typeFilter="all"` shows collapsible grouped sections, specific type shows flat list via `HoldingsFlatSection`
- Shared table rendering: `HoldingsTableContent` component handles row rendering for both grouped and flat views
- GroupHeader (components/holdings/group-header.tsx) shows label, count, total value, portfolio % badge — receives calculated values as props
- `calculateGroupTotal()` in holdings-table.tsx converts holdings to display currency — use for any group-level value aggregation
- `motion.create(TableRow)` creates a motion-enhanced `MotionTableRow` for stagger animations on table rows
- Stagger rows use `motion.tbody` as container with `variants` + `initial="hidden" animate="visible"` pattern
- Capped stagger: `Math.min(0.05, 0.5 / count)` ensures total stagger completes within 500ms regardless of row count
- `useReducedMotion()` from framer-motion checks OS prefers-reduced-motion — skip animations entirely when true
- Dormant holdings sorted to bottom of each group via `useMemo` sort in `HoldingsTableContent` and `HoldingsCurrencySection`
- EmptyState component (`components/ui/empty-state.tsx`) is shared across holdings, snapshots, transactions — keep prop API stable
- `AnimatePresence mode="popLayout"` on HoldingsTable wraps content keyed by typeFilter — handles enter/exit on tab change
- Holdings table rows are clickable (navigate to `/holdings/[id]`) — action buttons use `stopPropagation` to prevent row click
- Row hover: `hover:bg-accent/5 hover:scale-[1.005] active:bg-accent/10` with `transition-[background-color,transform] duration-150`
- Filter tabs (components/holdings/filter-tabs.tsx) use Framer Motion layoutId for animated sliding indicator
- scrollbar-hide utility class added to globals.css for hidden scrollbar on overflow-x-auto elements

---

# UX-4 Transaction UI Enhancement Progress Log

Started: 2026-02-06

---

## 2026-02-06 - US-001
- Created `components/transactions/type-selector.tsx` — animated tab bar with BUY/SELL/DIVIDEND/SPLIT options
- Sliding background indicator using Framer Motion `layoutId="active-transaction-type"`
- Colour-coded: BUY=positive/green, SELL=destructive/red, DIVIDEND=accent/purple, SPLIT=blue-400/blue-500
- Controlled component with `value`, `onChange`, `disabled` props
- Disabled mode: shows active type but prevents interaction, reduces opacity on inactive tabs
- Follows same pattern as `filter-tabs.tsx` (layoutId sliding indicator)
- Files changed: `components/transactions/type-selector.tsx` (new)
- **Learnings for future iterations:**
  - TypeSelector exports `TransactionType` type — import from `type-selector.tsx` instead of `add-transaction-dialog.tsx`
  - Uses `bg-muted p-1` container with `rounded-lg` for the pill-bar look
  - layoutId must be unique per AnimatePresence scope — used `"active-transaction-type"` to avoid conflicts with other layoutIds
---

## 2026-02-06 - US-002
- Refactored `add-transaction-dialog.tsx` from manual useState to react-hook-form + zod
- Installed react-hook-form, zod, @hookform/resolvers; added shadcn/ui form component
- Created unified `formSchema` with z.coerce.number() fields; per-action validation in onSubmit
- Replaced RadioGroup with TypeSelector from US-001
- Preserved two-step flow: Step 1 (holding + type) → Step 2 (details via react-hook-form)
- SELL validation checks available quantity and prevents overselling
- Real-time calculated totals using form.watch()
- Files changed: `components/transactions/add-transaction-dialog.tsx`, `components/ui/form.tsx` (new), `package.json`
- **Learnings for future iterations:**
  - z.coerce.number() has input type `unknown` — causes TS mismatch with useForm<FormValues>. Fix: cast resolver as `zodResolver(schema) as unknown as Resolver<FormValues>`
  - Import `Resolver` type from `react-hook-form` for the cast
  - For numeric inputs with z.coerce, pass `field.value ?? ""` to prevent "undefined" showing; use `e.target.value === "" ? "" : e.target.value` for onChange to allow clearing
  - Unified schema approach (single schema + onSubmit validation) is simpler than discriminated union schemas with refine
---

## 2026-02-06 - US-003
- Refactored `edit-transaction-dialog.tsx` from manual useState/errors to react-hook-form + zod
- Uses same `formSchema` and `FormValues` type as add dialog for consistency
- `useForm` pre-populated with transaction data via `form.reset()` in useEffect when dialog opens
- Replaced manual Label+Input+error with FormField/FormControl/FormMessage components
- Added TypeSelector in disabled mode (shows action type visually but prevents interaction)
- SELL validation accounts for the transaction being edited: `availableForSell = currentQuantity + originalSellQty`
- Holding name, currency, and action type displayed as read-only info above the form
- Real-time calculated totals using `form.watch()`
- Uses toast for error feedback (simplified from inline server errors)
- Files changed: `components/transactions/edit-transaction-dialog.tsx`
- **Learnings for future iterations:**
  - Edit dialogs need `form.reset()` in useEffect keyed on `[open, transaction, form]` to sync form with new transaction data
  - For edit dialogs, simplified `onError` to just toast (no inline server errors) since form validation catches most issues client-side
  - TypeSelector `disabled` prop + empty `onChange={() => {}}` provides clean read-only display of transaction type
---

## 2026-02-06 - US-004
- Created `components/transactions/transaction-summary.tsx` — 4 summary cards (Total Bought, Total Sold, Dividends Received, Net Cash Flow)
- Cards use staggerContainer/staggerItem animation presets from lib/animations.ts
- Grid responsive: 1 col mobile, 2 cols md, 4 cols lg+
- Each card shows label, formatted dollar amount (via CurrencyDisplay), and transaction count
- Colour-coded: Bought=text-positive, Sold=text-destructive, Dividends=text-accent, Net=dynamic based on sign
- Uses design tokens: bg-card/50, border-border
- Respects prefers-reduced-motion via useReducedMotion()
- Updated transactions page to compute per-action counts in aggregatedTotals useMemo
- Removed TableFooter (aggregated totals now shown in summary cards above table)
- Summary cards respect current filter state (holding, action, currency) since they consume the same aggregatedTotals derived from filtered transactions
- Files changed: `components/transactions/transaction-summary.tsx` (new), `app/(dashboard)/transactions/page.tsx`
- **Learnings for future iterations:**
  - AggregatedTotals interface extended with `buyCount`, `sellCount`, `dividendCount`, `totalCount`, `displayCurrencyCode` for summary card consumption
  - `displayCurrencyCode` precomputed in useMemo: uses display currency if mixed, otherwise the common native currency — avoids currency logic in child components
  - Card container pattern: `border border-border bg-card/50 p-4 rounded-lg` for consistent card look
---

