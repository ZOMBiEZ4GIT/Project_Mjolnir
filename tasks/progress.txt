## Codebase Patterns
- Project uses Next.js 14+ App Router with TypeScript
- Drizzle ORM is already installed (drizzle-orm, drizzle-kit, @neondatabase/serverless)
- shadcn/ui components available in components/ui
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Tailwind CSS with shadcn/ui CSS variable pattern using HSL format: hsl(var(--variable))
- CSS variables stored without hsl() wrapper e.g. --background: 240 10% 3.9%
- Glow shadows use rgba() since HSL variables can't express box-shadow alpha
- Inter font loaded via next/font/google in app/layout.tsx (applied via inter.className on body)
- Framer Motion components require "use client" directive
- Toast notifications use Sonner - import toast from sonner
- Dashboard navigation uses components/layout/sidebar.tsx and components/layout/mobile-nav.tsx
- Tailwind has semantic tokens: text-positive/bg-positive (green), text-negative/bg-negative (red), shadow-glow-sm/md/lg, shadow-glow-positive, shadow-glow-negative, shadow-card, shadow-card-hover
- Layout & spacing constants live in lib/theme.ts (sidebarWidth, cardRadius, spacing xs→2xl) — use instead of magic numbers
- Animation presets live in lib/animations.ts — import and spread onto motion.div elements (e.g. `<motion.div {...fadeIn}>`)
- Stagger presets (staggerContainer, staggerItem) use Variants type with "hidden"/"visible" keys — use with variants prop
- numberSpring is a Transition object for animating numeric values (e.g. useSpring, useMotionValue)
- Reduced motion: use `useReducedMotion()` from framer-motion directly — returns boolean for OS prefers-reduced-motion
- Hooks live in hooks/ directory (not lib/) — follow this convention for custom React hooks
- Recharts SVG props (stroke, fill) require raw hex values — CSS variables not supported in SVG rendering
- Category indicator colours (asset types, currencies) use hardcoded Tailwind colours (bg-blue-500 etc.) — these are intentional and distinct from theme tokens
- Card container pattern: `border-border bg-card/50` for bordered cards, `bg-muted` for skeleton placeholders
- Error state pattern: `border-destructive bg-destructive/10` with `text-destructive` for error messages
- Toggle pattern: active=`bg-muted text-foreground`, inactive=`text-muted-foreground hover:text-foreground`
- Form validation pattern: `border-destructive focus-visible:ring-destructive` on inputs, `text-destructive` on error messages
- Delete confirm button: `bg-destructive hover:bg-destructive/90 text-foreground`; cancel: `bg-card border-border text-foreground hover:bg-muted`
- Select dropdowns: `bg-background border-border text-muted-foreground` for trigger, `focus:bg-card focus:text-foreground` for items
- Warning colours use text-warning/bg-warning design tokens (--warning: 38 92% 50% ≈ amber-500) — added in UX-9 US-010
- Info colours (blue-*) are semantic and intentionally NOT part of design token migration
- Interactive toggle buttons (show/hide contributions): use `text-primary hover:text-primary/80` pattern
- html2canvas backgroundColor requires raw hex — use `#18181b` to match --card token
- Email templates (components/emails/) use inline hex values — email clients don't support CSS variables
- Only legitimate remaining hardcoded grey: `bg-gray-500` fallback in category indicator functions (asset-allocation, currency-exposure)
- TimeRangeSelector (components/charts/time-range-selector.tsx) exports TimeRange type and TIME_RANGE_OPTIONS — import from @/components/charts
- lightweight-charts v5 API: `chart.addSeries(AreaSeries, options)` — not `chart.addAreaSeries(options)` (deprecated)
- TradingView charts require `next/dynamic` with `ssr: false` — use TVChart from components/charts/tv-chart.tsx
- TVChartWrapper supports `onCrosshairMove` callback for custom tooltips — returns TVCrosshairData { time, value, x, y } or null
- TradingView custom tooltip: use absolute positioned div with pointer-events-none overlaying the chart container
- TradingView Time type accepts YYYY-MM-DD date strings cast as `Time` — works for monthly data points
- Navigation items defined in lib/navigation.ts — import navItems and NavItem type from there (sidebar, mobile nav, command menu)
- New layout components live in components/layout/ — NavItemLink (nav-item.tsx) uses Framer Motion layoutId='active-nav' for animated active pill
- TooltipProvider with delayDuration={0} wraps collapsed nav items for instant tooltip display
- Sidebar collapse state persists in localStorage ('mjolnir-sidebar-collapsed') — use mounted state pattern to avoid hydration mismatch
- Sidebar is fixed positioned; content area needs dynamic left margin matching sidebar width (240px or 64px)
- AppShell (components/layout/app-shell.tsx) owns sidebar collapsed state — Sidebar receives isCollapsed/onToggleCollapsed as props
- Content area uses CSS custom property --sidebar-width with responsive Tailwind class ml-0 lg:ml-[var(--sidebar-width)] for responsive dynamic margin
- For responsive dynamic values, use CSS custom properties + Tailwind arbitrary value classes (inline styles can't be responsive)
- PageWrapper (components/layout/page-wrapper.tsx) wraps page content with fade transition — placed inside DashboardErrorBoundary in dashboard layout
- Mobile header (components/layout/mobile-nav.tsx) is fixed h-14 z-30 — content area needs pt-14 on mobile
- Sheet drawer (shadcn/ui) handles focus trapping and Escape close via Radix Dialog primitive
- Focus ring pattern: `focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring` matches shadcn/ui conventions
- Shared UI components (e.g. SpeedDial) live in `components/shared/` directory
- To open AddHoldingDialog/AddTransactionDialog programmatically: pass a hidden `<button ref={ref} />` as children, then call `ref.current?.click()`
- CheckInModal uses controlled `open`/`onOpenChange` props — can be opened from any external trigger
- HoldingsTable hybrid grouping: `typeFilter="all"` shows collapsible grouped sections, specific type shows flat list via `HoldingsFlatSection`
- Shared table rendering: `HoldingsTableContent` component handles row rendering for both grouped and flat views
- GroupHeader (components/holdings/group-header.tsx) shows label, count, total value, portfolio % badge — receives calculated values as props
- `calculateGroupTotal()` in holdings-table.tsx converts holdings to display currency — use for any group-level value aggregation
- `motion.create(TableRow)` creates a motion-enhanced `MotionTableRow` for stagger animations on table rows
- Stagger rows use `motion.tbody` as container with `variants` + `initial="hidden" animate="visible"` pattern
- Capped stagger: `Math.min(0.05, 0.5 / count)` ensures total stagger completes within 500ms regardless of row count
- `useReducedMotion()` from framer-motion checks OS prefers-reduced-motion — skip animations entirely when true
- Dormant holdings sorted to bottom of each group via `useMemo` sort in `HoldingsTableContent` and `HoldingsCurrencySection`
- EmptyState component (`components/ui/empty-state.tsx`) is shared across holdings, snapshots, transactions — keep prop API stable
- `AnimatePresence mode="popLayout"` on HoldingsTable wraps content keyed by typeFilter — handles enter/exit on tab change
- Holdings table rows are clickable (navigate to `/holdings/[id]`) — action buttons use `stopPropagation` to prevent row click
- Row hover: `hover:bg-accent/5 hover:scale-[1.005] active:bg-accent/10` with `transition-[background-color,transform] duration-150`
- Filter tabs (components/holdings/filter-tabs.tsx) use Framer Motion layoutId for animated sliding indicator
- scrollbar-hide utility class added to globals.css for hidden scrollbar on overflow-x-auto elements
- TypeSelector (components/transactions/type-selector.tsx) uses layoutId="active-transaction-type" for animated tab indicator
- react-hook-form + zod installed; shadcn/ui form.tsx component available in components/ui/form.tsx
- z.coerce.number() with useForm requires casting resolver: `zodResolver(schema) as unknown as Resolver<FormValues>`
- Zod v4 API difference: use `{ error: "..." }` for custom error messages on z.coerce.number(), not `{ required_error, invalid_type_error }` (Zod v3 API)
- Zod v4 superRefine: use `code: "custom"` string literal instead of `z.ZodIssueCode.custom` enum
- For numeric inputs with z.coerce: pass `field.value ?? ""` to prevent "undefined" showing
- TransactionSummary cards use stagger animation with motion.div and variants pattern
- Transaction table uses monthly grouping with sticky headers (sticky top-0 z-20 bg-background)
- MotionTableRow with stagger variants + AnimatePresence mode="wait" keyed by filterKey for table animations
- Transaction action colour mapping: BUY=positive/green, SELL=destructive/red, DIVIDEND=accent/purple, SPLIT=blue-400/blue-500
- onTransactionSaved/onDeleted callbacks enable row highlight and fade-out animations from parent component
- Check-in form uses react-hook-form + zod with useFieldArray for dynamic holdings list; showContributions is UI-only state (not in form schema)
- useFieldArray `replace()` syncs form fields with API data; use a ref-based sync key to prevent re-replacing on every render
- form.trigger(`holdings.${idx}.balance`) validates individual field array items for per-step validation in wizard flows
- form.setValue with `{ shouldValidate: form.formState.isSubmitted }` re-validates on change only after first validation attempt
- Check-in status API returns `previousBalances` keyed by holdingId — most recent snapshot balance before target month
- CheckInModal is a 3-step wizard (Select Month → Update Holdings → Review & Save) with currentStep state (0-2)
- animate-shake keyframes defined in tailwind.config.ts — use `animate-shake` class with useState toggle + setTimeout auto-clear
- Type icon mapping: super=Landmark, cash=Wallet, debt=CreditCard (from lucide-react)
- CheckinPrompt (components/dashboard/checkin-prompt.tsx) replaces CheckInPromptCard — moved to dashboard/ directory
- sessionStorage dismissal pattern: use `mounted` state + useEffect to avoid hydration mismatch when reading sessionStorage
- Accent glow prompt card: `border-accent/30 bg-card/50 shadow-glow-sm` for attention-grabbing cards
- Directional step transitions: use variants with `custom` prop on AnimatePresence to pass direction to exiting components — enter slides from `100*d%`, exit slides to `-100*d%` (d=1 forward, d=-1 backward)
- Step container needs `overflow-hidden` to clip sliding content during transitions
- Accordion expand animation: `motion.div` with `height: 0` → `height: "auto"`, `overflow-hidden`, wrapped in `AnimatePresence initial={false}`
- Check-in status API returns `latestContributions` for pre-populating super contribution fields
- Success summary pattern: store mutation result in state + `showSuccess` boolean, render different content in same step (no extra wizard step)
- CheckinStepper accepts currentStep=3 (beyond max) to mark all steps completed — no code change needed in stepper
- NumberTicker component (components/dashboard/number-ticker.tsx) animates currency values using useSpring + useMotionValue; tabular-nums prevents layout shift
- ChangeBadge component (components/dashboard/change-badge.tsx) shows positive/negative/zero with TrendingUp/TrendingDown/Minus icons; size="sm"|"md"
- StaleIndicator component (components/dashboard/stale-indicator.tsx) shows amber warning with tooltip (icon variant) or inline text (badge variant)
- framer-motion v12 `useSpring` subscribes via `.on("change", cb)` — use this to update textContent directly for performance
- Dashboard sections stagger in via motion.div container (80ms delay) with fadeIn+slideUp (opacity 0→1, y 16→0, 300ms easeOut)
- Progress bar animation: use useState(0) → useEffect setTimeout → setState(target) with CSS transition
- Donut centre overlay: absolute positioned div with pointer-events-none, marginBottom to offset legend
- Chart hex colours (#374151, #9CA3AF etc.) are required for SVG rendering — don't convert to CSS variables
- Grid gap-6 for section spacing, gap-4 only for small internal layouts
- All card-level elements use rounded-2xl; inner elements (tooltips, icons, row items) keep rounded-lg
- Yahoo Finance `chart()` method: `yahooFinance.chart(symbol, { period1, period2, interval: "1d" })` returns `{ quotes: [{ close }] }`
- CoinGecko market_chart: `/coins/{id}/market_chart?vs_currency=usd&days=30&interval=daily` returns `{ prices: [[timestamp, price]] }`
- Sparkline data API: `GET /api/prices/sparkline` returns `{ holdingId, symbol, prices: number[] }[]` — staleTime 30min
- SVG elements (non-Recharts) can use `stroke="currentColor"` with Tailwind `text-*` classes — avoids hardcoded hex
- ChartSkeleton uses ChartCard wrapper when `withContainer=true` — consistent with all chart sections
- All chart tooltips use `bg-card` (not `bg-background`) for consistent elevated surface styling
- Chart hex colours centralised in `lib/chart-palette.ts` — import CHART_GRID, CHART_TEXT, CHART_AXIS, POSITIVE, NEGATIVE, etc. instead of hardcoding hex
- Category asset type colours (STOCK, ETF, CRYPTO, SUPER, CASH) also in chart-palette.ts — use in getAssetHexColor() and similar functions
- PriceFlash (components/holdings/price-flash.tsx) wraps children with green/red flash on value change — use `<PriceFlash value={num}>{children}</PriceFlash>`
- PriceNumberTicker (components/holdings/price-number-ticker.tsx) animates price digits with spring animation — prefix prop stays static, only digits animate
- PriceTimestamp (components/holdings/price-timestamp.tsx) shows relative time + tooltip with exact time — three states: fresh/stale/error
- PriceSkeleton (components/holdings/price-skeleton.tsx) loading skeleton for price cells — variant="price" (3-bar) or variant="value" (single-bar)
- TanStack Query: `isFetching && !isLoading` detects background refetches without triggering initial skeleton
- Currency bar colours: AUD=`bg-positive` (green), NZD=`bg-blue-400` (blue), USD=`bg-amber-500` (amber) — use in progress bars and charts
- AnimatedPercentage pattern: requestAnimationFrame loop with ease-out cubic for lightweight percentage transitions (no framer-motion dependency)
- CurrencyToggle (components/ui/currency-toggle.tsx) is a horizontal pill toggle with Framer Motion layoutId='currency-indicator' — replaces CurrencySelector dropdown on dashboard
- CURRENCY_SYMBOLS exported from lib/utils/currency.ts — use for displaying currency symbol separately from formatted number
- CurrencyDisplay uses useSpring for animated number transitions; motionValue.jump() for instant, motionValue.set() for animated
- Flash highlight pattern: bg-accent/15 with transitionDuration 0ms→400ms trick for instant-on, fade-off effect
- CurrencyDisplay shows rich tooltip (conversion info + rate) only when showNative=true and currencies differ — no tooltip otherwise
- Effective exchange rate: compute from amount/nativeAmount rather than passing rates as prop
- NativeCurrencyToggle accepts `showDescription` prop for optional descriptive text; Switch override: `data-[state=checked]:bg-accent data-[state=unchecked]:bg-muted`
- CurrencyDisplay flash also triggers on showNative change for components with different native currency
- Radix + Framer Motion: use `asChild` + `motion.div` pattern (not `motion.create(Primitive)`) to avoid `onDrag` type conflict
- AnimatedDialog/AnimatedAlertDialog: drop-in replacements for Dialog/AlertDialog — import from `@/components/ui/animated-dialog` or `animated-alert-dialog`
- Framer Motion centering: use `style={{ x: "-50%", y: "-50%" }}` not CSS translate classes (FM overwrites transform)
- FormField/FormTextareaField/FormSelectField: convenience wrappers in components/ui/ — use Controller + useFormContext, require FormProvider parent
- FormField uses motion.input with focusGlow for purple glow on focus; FormSelectField uses Radix Select (no motion wrapper)
- useFormShake hook (hooks/use-form-shake.ts): returns { formRef, triggerShake } — attach ref to form container, call triggerShake() in handleSubmit onInvalid callback; cast formRef to `React.RefObject<HTMLDivElement | null>` when attaching to a `<div>`
- animate-shake CSS class defined in tailwind.config.ts — use for CSS-based shake animations (500ms ease-in-out)
- Toast helpers: import { showSuccess, showError, showInfo } from "@/lib/toast-helpers" — success auto-dismiss 3s, error persists until dismissed, info 4s
- showError accepts optional { onRetry } to render a Retry action button; use for retryable operations
- check-in-modal.tsx: use aliased imports (toastSuccess/toastError) because local `showSuccess` state variable shadows the import
- shadcn/ui Accordion requires `accordion-down`/`accordion-up` keyframes in tailwind.config.ts — add manually after `shadcn add accordion`
- SettingsSection (components/settings/settings-section.tsx) wraps AccordionItem with icon+title+description trigger — use for settings-style pages
- Global `prefers-reduced-motion: reduce` in globals.css disables all CSS animations/transitions (0.01ms duration)
- ConfirmDialog (components/ui/confirm-dialog.tsx) is a ready-to-use confirmation dialog — wraps AnimatedAlertDialog with simple props API (title, description, variant, onConfirm, loading)
- ImportPreview (components/import/import-preview.tsx) shows first 10 rows of parsed CSV with stagger animation and validation warnings
- Import page flow: file upload → preview (with row count) → import → results — state machine with step: "upload" | "preview" | "importing" | "results"
- ImportResults AnimatedCount uses useSpring + useMotionValue pattern for integer count animations (same as NumberTicker)
- Error report download: client-side CSV generation using Blob + createObjectURL + click trick
- Export button states tracked per-button via Map<ExportKey, ButtonState> — allows independent download progress
- animate-shimmer keyframe (200%→-200% backgroundPosition) for indeterminate progress bar shimmer effect
- Recent imports badges: Transactions=bg-accent/20 text-accent, Snapshots=bg-positive/20 text-positive

---

# UX-12 Ambient Effects & Final Polish Progress Log

Started: 2026-02-07

---

## 2026-02-07 - US-001
- Created `components/effects/animated-gradient.tsx` with `variant` prop ('auth' | 'error') and `className` prop
- Auth variant uses purple-900/indigo-950/blue-950 gradient tints at 40% opacity
- Error variant uses red-950/rose-950/red-900 gradient tints (ready for US-003)
- Added `gradient-shift` keyframes and `animate-gradient-shift` (18s ease infinite loop) to tailwind.config.ts
- Updated sign-in and sign-up pages with AnimatedGradient at z-0, content at z-10
- Auth pages already used `bg-background` (not bg-gray-950) — no class replacement needed
- `prefers-reduced-motion` handled by global CSS rule in globals.css (animation-duration: 0.01ms)
- Files changed: components/effects/animated-gradient.tsx (new), tailwind.config.ts, app/(auth)/sign-in page, app/(auth)/sign-up page
- **Learnings for future iterations:**
  - AnimatedGradient uses `fixed inset-0` positioning — reusable as full-page background layer
  - Error variant already defined — just use `variant="error"` for US-003 error page
  - `pointer-events-none` and `aria-hidden="true"` on decorative background layers is important
---

## 2026-02-07 - US-002
- Created `components/effects/hero-beams.tsx` — 5 thin semi-transparent purple beams that drift upward
- Added `beam-drift` keyframe to tailwind.config.ts — translateY(100%) to translateY(-100%) with opacity fade
- 5 animation variants (beam-drift-1 through beam-drift-5) with staggered delays (0-4s) and varied durations (10-14s)
- Beams use `w-px` (1px) or `w-[2px]` with purple-400/10 to purple-500/15 gradient opacity (10-15% range)
- Integrated HeroBeams into net-worth-hero.tsx — renders when `!shouldReduceMotion`
- Beams contained via `overflow-hidden rounded-2xl` on container — no bleed outside card
- GPU-accelerated: only transform (translateY, scaleY) and opacity animated
- Files changed: components/effects/hero-beams.tsx (new), tailwind.config.ts, components/dashboard/net-worth-hero.tsx
- **Learnings for future iterations:**
  - Beam containment: `overflow-hidden rounded-2xl` on absolute container matches parent card's border radius
  - Conditional rendering with `{!shouldReduceMotion && <Effect />}` is cleaner than CSS-only hide for pure decorative effects
  - Staggered animation delays (2s, 3s, 4s) create more natural movement than synchronized beams
  - `bg-gradient-to-t from-transparent via-color to-transparent` creates a nice beam line that fades at both ends
---

