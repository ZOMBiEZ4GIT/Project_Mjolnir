## Codebase Patterns
- Project uses Next.js 16+ App Router with TypeScript
- Drizzle ORM is already installed (`drizzle-orm`, `drizzle-kit`, `@neondatabase/serverless`)
- shadcn/ui components available in `components/ui`
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Next.js 16 doesn't have `next lint` command - use `eslint .` directly

- Database module uses lazy initialization via Proxy to avoid build-time errors when DATABASE_URL is not set
- Use `sql` template tag from drizzle-orm for raw SQL queries with `db.execute(sql\`...\`)`
- ClerkProvider conditionally renders based on NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY to allow builds without Clerk keys
- Use `export const dynamic = "force-dynamic"` for pages/layouts that use Clerk components
- Dashboard routes at `/dashboard` and `/profile` are protected; landing page `/` is public
- Auth pages use `(auth)` route group; dashboard uses `(dashboard)` route group

- Drizzle migrations are stored in `drizzle/` directory and should be committed to git
- The holdings schema exists in `lib/db/schema.ts` with all required fields
- Transactions schema exists with action enum: BUY, SELL, DIVIDEND, SPLIT

- TanStack Query provider is in `components/providers/query-provider.tsx` - wrap layouts with QueryProvider
- ClerkProvider wrapper is in `components/providers/clerk-provider.tsx` - handles missing Clerk keys gracefully
- Use `useAuthSafe` hook from `lib/hooks/use-auth-safe.ts` for client-side auth state that works with/without Clerk
- Holdings page is at `/holdings` using `app/(dashboard)/holdings/page.tsx`
- Transactions page is at `/transactions` using `app/(dashboard)/transactions/page.tsx`

- Toast notifications use Sonner - import `toast` from `sonner` and use `toast.success()` / `toast.error()`
- Toaster component is in root layout; for dark mode only, hardcode `theme="dark"` in Sonner component

- Dashboard navigation uses `components/dashboard/nav.tsx` with usePathname for active state

- CurrencyDisplay component in `components/ui/currency-display.tsx`:
  - Use for all currency value displays for consistency
  - Props: amount, currency, showNative?, nativeCurrency?, nativeAmount?, isLoading?, compact?
  - Tooltip shows ISO code on hover; skeleton for loading state
  - Import: `import { CurrencyDisplay } from "@/components/ui/currency-display"`
- CurrencySelector component in `components/ui/currency-selector.tsx`:
  - Dropdown for switching display currency preference
  - Uses useCurrency() hook for state and API updates
  - Props: className?, showLoadingState?, compact?
  - Import: `import { CurrencySelector } from "@/components/ui/currency-selector"`
- Navigation items defined in array for easy extension
- ESLint no-case-declarations: wrap switch case blocks containing `const`/`let` declarations in braces `{ }`
- GroupBySelector component in `components/holdings/group-by-selector.tsx`:
  - Dropdown for switching group by mode (Type or Currency)
  - Export both component and type: `import { GroupBySelector, type GroupByValue }`
  - GroupByValue: "type" | "currency"
  - Import: `import { GroupBySelector } from "@/components/holdings/group-by-selector"`
- HoldingsTable supports groupBy prop for switching between type and currency grouping

- API patterns:
  - Use innerJoin with holdings to validate user ownership AND include holding info
  - Return 409 Conflict for duplicate prevention (unique constraint violations)
  - Return 400 with `{ errors: { field: "message" } }` for validation errors
  - Decimal fields from Drizzle come as strings, need Number() conversion for arithmetic

- Calculation helpers in `lib/calculations/`:
  - `quantity.ts` - calculateQuantityHeld for tradeable holdings
  - `cost-basis.ts` - calculateCostBasis with FIFO methodology
  - `super-returns.ts` - calculateInvestmentReturns() and calculateMonthlyInvestmentReturns() for super fund performance

- Snapshots and contributions schema: uses `employer_contrib`/`employee_contrib` (not `employer_contribution`) for DB column names to avoid migration renames

- Query helpers in `lib/queries/`:
  - `snapshots.ts` - getLatestSnapshots() and getLatestSnapshotForHolding() for fetching most recent snapshots
  - `users.ts` - ensureUser(), getUserPreferences(), updateUserPreferences() for user management

- Check-in status API at `/api/check-in/status` returns holdings needing current month snapshots
- Dashboard components in `components/check-in/` for monthly check-in workflow
- Quote paths with parentheses in bash git commands: `git add "app/(dashboard)/..."`

- Edit modals pattern: components/[domain]/edit-[entity]-modal.tsx structure
- For related entity editing (e.g., contributions for super snapshots), fetch existing data with useQuery and handle create/update based on existence

- Neon MCP tools can be used to run migrations when DATABASE_URL is not configured locally
- Migration snapshot chain: each snapshot's prevId must point to the previous migration's id to avoid collision errors

- Price services in `lib/services/`:
  - `yahoo-finance.ts` - fetchStockPrice() with normalizeSymbol() for ASX/NZX suffixes
  - `coingecko.ts` - fetchCryptoPrice() using symbol-to-ID mapping
  - `exchange-rates.ts` - getExchangeRate() with 1-hour cache
  - `price-cache.ts` - getCachedPrice(), setCachedPrice() with 15-minute TTL
  - `price-fetcher.ts` - fetchPrice() unified interface routing to correct provider
  - `crypto-symbols.ts` - getCoinGeckoId() mapping for 60+ tokens

- Holdings table in `components/holdings/holdings-table.tsx` includes:
  - PriceCell with stale/error indicators and retry button
  - MarketValueCell calculating quantity x price
  - GainLossCell showing unrealized gain/loss with percentage

- Net worth calculation in `lib/calculations/net-worth.ts`:
  - `calculateNetWorth(userId, { displayCurrency? })` returns NetWorthResult with netWorth, totalAssets, totalDebt, breakdown by type
  - `calculateAssetBreakdown(userId, { displayCurrency? })` returns AssetBreakdown with percentage for each type and holding
  - Both functions accept optional `displayCurrency` param (AUD, NZD, USD) - defaults to AUD
  - Both functions return `displayCurrency` and `ratesUsed` for transparency
  - Uses `calculateQuantityHeld()` for tradeable assets, `getLatestSnapshots()` for snapshot-based assets
  - HoldingValue.value is in display currency; HoldingValue.valueNative is original currency
  - Carry-forward logic: stale data is used for calculations with `StaleHolding[]` tracking
  - Tradeable staleness: 15-minute price TTL via `isCacheValid()`
  - Snapshot staleness: 2-month threshold (SNAPSHOT_STALE_THRESHOLD_MS)

- Historical net worth calculation in `lib/calculations/net-worth-history.ts`:
  - `calculateHistoricalNetWorth(userId, months)` returns HistoricalNetWorthResult with history array
  - HistoryPoint: { date, netWorth, totalAssets, totalDebt }
  - Uses carry-forward for snapshots (most recent on or before date)
  - Tradeable uses current prices (historical prices not stored) - values are estimates

- Top performers calculation in `lib/calculations/performers.ts`:
  - `getTopPerformers(userId, limit)` returns gainers and losers based on unrealized gain/loss
  - Drizzle `inArray()` with enum columns requires `as const` on values array for type safety

- Dashboard components in `components/dashboard/`:
  - Client components using TanStack Query for data fetching from API routes
  - Pattern: fetch data from API, show loading skeleton, then render content
  - Use `useAuthSafe` hook to check `isLoaded && isSignedIn` before enabling queries
  - Currency formatting: use `formatCurrency()` from `lib/utils/currency.ts` for consistent display
    - Options: `showCode`, `showSymbol`, `compact`
    - Symbols: AUD = "$", NZD = "NZ$", USD = "US$"
  - Icons from `lucide-react` (TrendingUp, TrendingDown, AlertTriangle, etc.)

- CurrencyProvider in `components/providers/currency-provider.tsx`:
  - `useCurrency()` hook for currency context in client components
  - Provides: displayCurrency, setDisplayCurrency, rates, isLoading, isStale, ratesFetchedAt, convert(), refreshRates()
  - `convert(amount, fromCurrency)` converts to display currency using current rates
  - Uses optimistic updates for immediate UI feedback when changing currency
  - Hierarchy: ClerkProvider > QueryProvider > CurrencyProvider > app

- Existing chart components using Recharts:
  - `NetWorthChart` in `components/dashboard/net-worth-chart.tsx` - LineChart for 12-month history
  - `AssetAllocation` in `components/dashboard/asset-allocation.tsx` - Progress bars (not actual chart)
  - `CurrencyExposure` in `components/dashboard/currency-exposure.tsx` - Progress bars
  - Recharts components: LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer
  - Custom tooltip pattern: `<Tooltip content={<CustomTooltip currency={displayCurrency} />} />`
  - Dark mode colors: stroke="#374151" for grid, fill="#9CA3AF" for axis text

- URL param persistence in client components:
  - Use `useSearchParams`, `useRouter`, `usePathname` from `next/navigation`
  - Create params with `new URLSearchParams(searchParams.toString())`
  - Update URL with `router.replace(newUrl, { scroll: false })` to avoid scroll jump
  - Remove param if default value to keep URLs clean

---

# W-9 Charts & Visualisation Progress Log

Started: 2026-02-02

---

## 2026-02-02 - US-001
- Implemented time range selector for net worth chart
- Files changed: `components/dashboard/net-worth-chart.tsx`
- **Learnings for future iterations:**
  - URL param persistence pattern: use useSearchParams + useRouter.replace with scroll: false
  - TanStack Query refetches automatically when queryKey changes (months param)
  - Time range selector uses simple button group with Tailwind styling for dark mode
  - Keep URL clean by removing param when it matches default value
---

## 2026-02-02 - US-002
- Added mini sparkline to net worth hero card
- Files changed: `components/dashboard/net-worth-hero.tsx`
- **Learnings for future iterations:**
  - Sparkline pattern: Use Recharts LineChart with no axes, grid, or dots for minimal display
  - Set `isAnimationActive={false}` for sparklines to avoid unnecessary animation
  - Sparkline color based on trend: compare first and last values, green for increase, red for decrease
  - Increased history fetch from 2 to 6 months for sparkline data (SPARKLINE_MONTHS constant)
  - Wrap sparkline in flex container with gap-4 to position next to main value
---

## 2026-02-02 - US-003
- Created AssetAllocationPieChart component using Recharts PieChart
- Files changed: `components/dashboard/asset-allocation-pie-chart.tsx`
- **Learnings for future iterations:**
  - Recharts PieChart components: PieChart, Pie, Cell, Tooltip, Legend, ResponsiveContainer
  - Use hex colors for Recharts fills (not Tailwind classes): stock=#3B82F6, etf=#8B5CF6, crypto=#F97316, super=#10B981, cash=#06B6D4
  - Donut chart style: use innerRadius and outerRadius props on Pie component
  - Custom Legend with content prop for full styling control
  - PieDataPoint interface holds both display data (name, percentage) and raw data (type, value, count)
  - Filter out zero-value slices before rendering to avoid empty segments
  - paddingAngle prop adds spacing between pie slices for cleaner look
---

## 2026-02-02 - US-004
- Added chart type toggle to asset allocation (Bars | Pie views)
- Files changed: `components/dashboard/asset-allocation.tsx`
- **Learnings for future iterations:**
  - ViewToggle pattern: Button group with conditional styling based on selected state
  - localStorage persistence: Use STORAGE_KEY constant, read on mount with useEffect, write on change
  - When consolidating similar components, keep one source of data fetching and render conditionally
  - Icons for toggles: Use lucide-react BarChart3 and PieChartIcon (not PieChart to avoid Recharts conflict)
  - Type safety: Define ViewMode = "bars" | "pie" and validate localStorage values before setting state
---

