## Codebase Patterns
- Project uses Next.js 14+ App Router with TypeScript
- Drizzle ORM is already installed (drizzle-orm, drizzle-kit, @neondatabase/serverless)
- shadcn/ui components available in components/ui
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Tailwind CSS with shadcn/ui CSS variable pattern using HSL format: hsl(var(--variable))
- CSS variables stored without hsl() wrapper e.g. --background: 240 10% 3.9%
- Glow shadows use rgba() since HSL variables can't express box-shadow alpha
- Inter font loaded via next/font/google in app/layout.tsx (applied via inter.className on body)
- Framer Motion components require "use client" directive
- Toast notifications use Sonner - import toast from sonner
- Dashboard navigation uses components/layout/sidebar.tsx and components/layout/mobile-nav.tsx
- Tailwind has semantic tokens: text-positive/bg-positive (green), text-negative/bg-negative (red), shadow-glow-sm/md/lg, shadow-glow-positive, shadow-glow-negative, shadow-card, shadow-card-hover
- Layout & spacing constants live in lib/theme.ts (sidebarWidth, cardRadius, spacing xsâ†’2xl) â€” use instead of magic numbers
- Animation presets live in lib/animations.ts â€” import and spread onto motion.div elements (e.g. `<motion.div {...fadeIn}>`)
- Stagger presets (staggerContainer, staggerItem) use Variants type with "hidden"/"visible" keys â€” use with variants prop
- numberSpring is a Transition object for animating numeric values (e.g. useSpring, useMotionValue)
- Reduced motion: use `useReducedMotion()` from framer-motion directly â€” returns boolean for OS prefers-reduced-motion
- Hooks live in hooks/ directory (not lib/) â€” follow this convention for custom React hooks
- Recharts SVG props (stroke, fill) require raw hex values â€” CSS variables not supported in SVG rendering
- Category indicator colours (asset types, currencies) use hardcoded Tailwind colours (bg-blue-500 etc.) â€” these are intentional and distinct from theme tokens
- Card container pattern: `border-border bg-card/50` for bordered cards, `bg-muted` for skeleton placeholders
- Error state pattern: `border-destructive bg-destructive/10` with `text-destructive` for error messages
- Toggle pattern: active=`bg-muted text-foreground`, inactive=`text-muted-foreground hover:text-foreground`
- Form validation pattern: `border-destructive focus-visible:ring-destructive` on inputs, `text-destructive` on error messages
- Delete confirm button: `bg-destructive hover:bg-destructive/90 text-foreground`; cancel: `bg-card border-border text-foreground hover:bg-muted`
- Select dropdowns: `bg-background border-border text-muted-foreground` for trigger, `focus:bg-card focus:text-foreground` for items
- Warning colours now use text-warning/bg-warning/border-warning design tokens (migrated from amber-* in UX-8)
- Info colours (blue-*) are semantic and intentionally NOT part of design token migration
- Interactive toggle buttons (show/hide contributions): use `text-primary hover:text-primary/80` pattern
- html2canvas backgroundColor requires raw hex â€” use `#18181b` to match --card token
- Email templates (components/emails/) use inline hex values â€” email clients don't support CSS variables
- Only legitimate remaining hardcoded grey: `bg-gray-500` fallback in category indicator functions (asset-allocation, currency-exposure)
- TimeRangeSelector (components/charts/time-range-selector.tsx) exports TimeRange type and TIME_RANGE_OPTIONS â€” import from @/components/charts
- lightweight-charts v5 API: `chart.addSeries(AreaSeries, options)` â€” not `chart.addAreaSeries(options)` (deprecated)
- TradingView charts require `next/dynamic` with `ssr: false` â€” use TVChart from components/charts/tv-chart.tsx
- TVChartWrapper supports `onCrosshairMove` callback for custom tooltips â€” returns TVCrosshairData { time, value, x, y } or null
- TradingView custom tooltip: use absolute positioned div with pointer-events-none overlaying the chart container
- TradingView Time type accepts YYYY-MM-DD date strings cast as `Time` â€” works for monthly data points
- Navigation items defined in lib/navigation.ts â€” import navItems and NavItem type from there (sidebar, mobile nav, command menu)
- New layout components live in components/layout/ â€” NavItemLink (nav-item.tsx) uses Framer Motion layoutId='active-nav' for animated active pill
- TooltipProvider with delayDuration={0} wraps collapsed nav items for instant tooltip display
- Sidebar collapse state persists in localStorage ('mjolnir-sidebar-collapsed') â€” use mounted state pattern to avoid hydration mismatch
- Sidebar is fixed positioned; content area needs dynamic left margin matching sidebar width (240px or 64px)
- AppShell (components/layout/app-shell.tsx) owns sidebar collapsed state â€” Sidebar receives isCollapsed/onToggleCollapsed as props
- Content area uses CSS custom property --sidebar-width with responsive Tailwind class ml-0 lg:ml-[var(--sidebar-width)] for responsive dynamic margin
- For responsive dynamic values, use CSS custom properties + Tailwind arbitrary value classes (inline styles can't be responsive)
- PageWrapper (components/layout/page-wrapper.tsx) wraps page content with fade transition â€” placed inside DashboardErrorBoundary in dashboard layout
- Mobile header (components/layout/mobile-nav.tsx) is fixed h-14 z-30 â€” content area needs pt-14 on mobile
- Sheet drawer (shadcn/ui) handles focus trapping and Escape close via Radix Dialog primitive
- Focus ring pattern: `focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring` matches shadcn/ui conventions
- Shared UI components (e.g. SpeedDial) live in `components/shared/` directory
- To open AddHoldingDialog/AddTransactionDialog programmatically: pass a hidden `<button ref={ref} />` as children, then call `ref.current?.click()`
- CheckInModal uses controlled `open`/`onOpenChange` props â€” can be opened from any external trigger
- HoldingsTable hybrid grouping: `typeFilter="all"` shows collapsible grouped sections, specific type shows flat list via `HoldingsFlatSection`
- Shared table rendering: `HoldingsTableContent` component handles row rendering for both grouped and flat views
- GroupHeader (components/holdings/group-header.tsx) shows label, count, total value, portfolio % badge â€” receives calculated values as props
- `calculateGroupTotal()` in holdings-table.tsx converts holdings to display currency â€” use for any group-level value aggregation
- `motion.create(TableRow)` creates a motion-enhanced `MotionTableRow` for stagger animations on table rows
- Stagger rows use `motion.tbody` as container with `variants` + `initial="hidden" animate="visible"` pattern
- Capped stagger: `Math.min(0.05, 0.5 / count)` ensures total stagger completes within 500ms regardless of row count
- `useReducedMotion()` from framer-motion checks OS prefers-reduced-motion â€” skip animations entirely when true
- Dormant holdings sorted to bottom of each group via `useMemo` sort in `HoldingsTableContent` and `HoldingsCurrencySection`
- EmptyState component (`components/ui/empty-state.tsx`) is shared across holdings, snapshots, transactions â€” keep prop API stable
- `AnimatePresence mode="popLayout"` on HoldingsTable wraps content keyed by typeFilter â€” handles enter/exit on tab change
- Holdings table rows are clickable (navigate to `/holdings/[id]`) â€” action buttons use `stopPropagation` to prevent row click
- Row hover: `hover:bg-accent/5 hover:scale-[1.005] active:bg-accent/10` with `transition-[background-color,transform] duration-150`
- Filter tabs (components/holdings/filter-tabs.tsx) use Framer Motion layoutId for animated sliding indicator
- scrollbar-hide utility class added to globals.css for hidden scrollbar on overflow-x-auto elements
- TypeSelector (components/transactions/type-selector.tsx) uses layoutId="active-transaction-type" for animated tab indicator
- react-hook-form + zod installed; shadcn/ui form.tsx component available in components/ui/form.tsx
- z.coerce.number() with useForm requires casting resolver: `zodResolver(schema) as unknown as Resolver<FormValues>`
- For numeric inputs with z.coerce: pass `field.value ?? ""` to prevent "undefined" showing
- TransactionSummary cards use stagger animation with motion.div and variants pattern
- Transaction table uses monthly grouping with sticky headers (sticky top-0 z-20 bg-background)
- MotionTableRow with stagger variants + AnimatePresence mode="wait" keyed by filterKey for table animations
- Transaction action colour mapping: BUY=positive/green, SELL=destructive/red, DIVIDEND=accent/purple, SPLIT=blue-400/blue-500
- onTransactionSaved/onDeleted callbacks enable row highlight and fade-out animations from parent component
- Check-in form uses react-hook-form + zod with useFieldArray for dynamic holdings list; showContributions is UI-only state (not in form schema)
- useFieldArray `replace()` syncs form fields with API data; use a ref-based sync key to prevent re-replacing on every render
- form.trigger(`holdings.${idx}.balance`) validates individual field array items for per-step validation in wizard flows
- form.setValue with `{ shouldValidate: form.formState.isSubmitted }` re-validates on change only after first validation attempt
- Check-in status API returns `previousBalances` keyed by holdingId â€” most recent snapshot balance before target month
- CheckInModal is a 3-step wizard (Select Month â†’ Update Holdings â†’ Review & Save) with currentStep state (0-2)
- animate-shake keyframes defined in tailwind.config.ts â€” use `animate-shake` class with useState toggle + setTimeout auto-clear
- Type icon mapping: super=Landmark, cash=Wallet, debt=CreditCard (from lucide-react)
- CheckinPrompt (components/dashboard/checkin-prompt.tsx) replaces CheckInPromptCard â€” moved to dashboard/ directory
- sessionStorage dismissal pattern: use `mounted` state + useEffect to avoid hydration mismatch when reading sessionStorage
- Accent glow prompt card: `border-accent/30 bg-card/50 shadow-glow-sm` for attention-grabbing cards
- Directional step transitions: use variants with `custom` prop on AnimatePresence to pass direction to exiting components â€” enter slides from `100*d%`, exit slides to `-100*d%` (d=1 forward, d=-1 backward)
- Step container needs `overflow-hidden` to clip sliding content during transitions
- Accordion expand animation: `motion.div` with `height: 0` â†’ `height: "auto"`, `overflow-hidden`, wrapped in `AnimatePresence initial={false}`
- Check-in status API returns `latestContributions` for pre-populating super contribution fields
- Success summary pattern: store mutation result in state + `showSuccess` boolean, render different content in same step (no extra wizard step)
- CheckinStepper accepts currentStep=3 (beyond max) to mark all steps completed â€” no code change needed in stepper
- NumberTicker component (components/dashboard/number-ticker.tsx) animates currency values using useSpring + useMotionValue; tabular-nums prevents layout shift
- ChangeBadge component (components/dashboard/change-badge.tsx) shows positive/negative/zero with TrendingUp/TrendingDown/Minus icons; size="sm"|"md"
- StaleIndicator component (components/dashboard/stale-indicator.tsx) shows amber warning with tooltip (icon variant) or inline text (badge variant)
- framer-motion v12 `useSpring` subscribes via `.on("change", cb)` â€” use this to update textContent directly for performance
- Dashboard sections stagger in via motion.div container (80ms delay) with fadeIn+slideUp (opacity 0â†’1, y 16â†’0, 300ms easeOut)
- Progress bar animation: use useState(0) â†’ useEffect setTimeout â†’ setState(target) with CSS transition
- Donut centre overlay: absolute positioned div with pointer-events-none, marginBottom to offset legend
- Chart hex colours (#374151, #9CA3AF etc.) are required for SVG rendering â€” don't convert to CSS variables
- Grid gap-6 for section spacing, gap-4 only for small internal layouts
- All card-level elements use rounded-2xl; inner elements (tooltips, icons, row items) keep rounded-lg
- Yahoo Finance `chart()` method: `yahooFinance.chart(symbol, { period1, period2, interval: "1d" })` returns `{ quotes: [{ close }] }`
- CoinGecko market_chart: `/coins/{id}/market_chart?vs_currency=usd&days=30&interval=daily` returns `{ prices: [[timestamp, price]] }`
- Sparkline data API: `GET /api/prices/sparkline` returns `{ holdingId, symbol, prices: number[] }[]` â€” staleTime 30min
- SVG elements (non-Recharts) can use `stroke="currentColor"` with Tailwind `text-*` classes â€” avoids hardcoded hex
- ChartSkeleton uses ChartCard wrapper when `withContainer=true` â€” consistent with all chart sections
- All chart tooltips use `bg-card` (not `bg-background`) for consistent elevated surface styling
- Chart hex colours centralised in `lib/chart-palette.ts` â€” import CHART_GRID, CHART_TEXT, CHART_AXIS, POSITIVE, NEGATIVE, etc. instead of hardcoding hex
- Category asset type colours (STOCK, ETF, CRYPTO, SUPER, CASH) also in chart-palette.ts â€” use in getAssetHexColor() and similar functions
- PriceFlash (components/holdings/price-flash.tsx) wraps children with green/red flash on value change â€” use `<PriceFlash value={num}>{children}</PriceFlash>`
- PriceNumberTicker (components/holdings/price-number-ticker.tsx) animates price digits with spring animation â€” prefix prop stays static, only digits animate
- PriceTimestamp (components/holdings/price-timestamp.tsx) shows relative time + tooltip with exact time â€” three states: fresh/stale/error
- PriceSkeleton (components/holdings/price-skeleton.tsx) loading skeleton for price cells â€” variant="price" (3-bar) or variant="value" (single-bar)
- TanStack Query: `isFetching && !isLoading` detects background refetches without triggering initial skeleton
- Currency bar colours: AUD=`bg-positive` (green), NZD=`bg-blue-400` (blue), USD=`bg-amber-500` (amber) â€” use in progress bars and charts
- AnimatedPercentage pattern: requestAnimationFrame loop with ease-out cubic for lightweight percentage transitions (no framer-motion dependency)

- CurrencyToggle (components/ui/currency-toggle.tsx) is a horizontal pill toggle with Framer Motion layoutId='currency-indicator' â€” replaces CurrencySelector dropdown on dashboard
- CURRENCY_SYMBOLS exported from lib/utils/currency.ts â€” use for displaying currency symbol separately from formatted number
- CurrencyDisplay uses useSpring for animated number transitions; motionValue.jump() for instant, motionValue.set() for animated
- Flash highlight pattern: bg-accent/15 with transitionDuration 0msâ†’400ms trick for instant-on, fade-off effect
- CurrencyDisplay shows rich tooltip (conversion info + rate) only when showNative=true and currencies differ â€” no tooltip otherwise
- Effective exchange rate: compute from amount/nativeAmount rather than passing rates as prop
- NativeCurrencyToggle accepts `showDescription` prop for optional descriptive text; Switch override: `data-[state=checked]:bg-accent data-[state=unchecked]:bg-muted`
- CurrencyDisplay flash also triggers on showNative change for components with different native currency

---

# UX-9 Multi-Currency Display Progress Log

Started: 2026-02-06

---

## 2026-02-06 - US-001
- Implemented animated currency toggle pills for dashboard header
- Files changed: components/ui/currency-toggle.tsx (new), components/dashboard/dashboard-header.tsx (modified)
- **Learnings for future iterations:**
  - CurrencyToggle uses layoutId='currency-indicator' for the sliding pill â€” avoid reusing this layoutId in other components
  - CurrencySelector (components/ui/currency-selector.tsx) still exists for use on settings page â€” dashboard now uses CurrencyToggle instead
  - useCurrency() hook from currency-provider.tsx provides displayCurrency, setDisplayCurrency, isLoading
  - useReducedMotion() from framer-motion returns boolean â€” use to set transition duration to 0 for instant switch
  - Spring transition { stiffness: 300, damping: 25 } gives a snappy but smooth slide for the indicator pill
---

## 2026-02-06 - US-002
- Polished settings page currency selector with flag emojis and design tokens
- Files changed: components/ui/currency-selector.tsx, app/(dashboard)/settings/page.tsx
- **Learnings for future iterations:**
  - CURRENCY_OPTIONS now includes `flag` field (ðŸ‡¦ðŸ‡º, ðŸ‡³ðŸ‡¿, ðŸ‡ºðŸ‡¸) â€” use for any currency display needing flag emojis
  - DollarSign icon removed from CurrencySelector trigger â€” flags serve as the visual identifier now
  - Compact mode shows just currency code, full mode shows flag + code in trigger and flag + code + "â€” Full Name" in dropdown items
  - SelectContent/SelectItem design tokens: bg-card border-border for content, focus:bg-accent/10 for item highlight
  - Settings page currency selector width increased from 180px to 220px to fit flag + full name in dropdown
---

## 2026-02-06 - US-003
- Animated currency values on display currency change
- Files changed: components/ui/currency-display.tsx (rewritten), lib/utils/currency.ts (exported CURRENCY_SYMBOLS)
- **Learnings for future iterations:**
  - CURRENCY_SYMBOLS is now exported from lib/utils/currency.ts â€” use when you need symbol without full formatCurrency
  - CurrencyDisplay now uses useSpring + useMotionValue for lightweight number animation (not per-digit)
  - motionValue.jump(amount) sets value instantly without animation â€” use for initial render
  - motionValue.set(amount) animates to new value via spring â€” use for subsequent changes
  - Flash highlight: bg-accent/15 with transitionDuration trick (0ms on, 400ms off) for instant-on, fade-off effect
  - AnimatePresence mode="wait" with initial={false} prevents animation on first render but crossfades on symbol change
  - formatNumber() helper strips currency symbol (uses AUD with showSymbol:false) â€” the symbol is rendered separately for crossfade
  - isInitialMount ref prevents animation from 0 on first render â€” all subsequent value/currency changes animate
---

## 2026-02-06 - US-004
- Enhanced native currency tooltip display with rich conversion info
- Files changed: components/ui/currency-display.tsx
- **Learnings for future iterations:**
  - CurrencyDisplay now shows rich tooltip only when hasDifferentNativeCurrency is true â€” no tooltip when currencies are same or showNative is off
  - Tooltip shows "Converted from [native amount] [native currency]" + "Rate: 1 [native] = X.XXXX [display]"
  - Effective exchange rate computed from amount/nativeAmount â€” no need to pass rates as prop
  - Tooltip styled with bg-card border border-border rounded-lg p-2 shadow-lg â€” matches design system elevated surface pattern
  - Native currency parenthetical uses text-body-sm (design token) instead of text-xs (hardcoded)
  - Removed FormatCurrencyOptions import â€” no longer needed after refactoring tooltip content
  - valueSpan extracted as variable to avoid duplicating the animated display markup between tooltip and non-tooltip paths
---

## 2026-02-06 - US-005
- Polished native currency toggle with design tokens and optional description
- Added flash highlight on CurrencyDisplay when showNative toggles
- Files changed: components/ui/native-currency-toggle.tsx, components/ui/currency-display.tsx
- **Learnings for future iterations:**
  - Switch component accepts className to override track colours: `data-[state=checked]:bg-accent data-[state=unchecked]:bg-muted`
  - NativeCurrencyToggle now accepts `showDescription` prop for optional descriptive text below label
  - CurrencyDisplay flash triggers on showNative change â€” only flashes on components where nativeCurrency differs from currency
  - prevShowNativeRef pattern added alongside prevAmountRef/prevCurrencyRef to track showNative changes independently
---

## 2026-02-06 - US-006
- Polished FX rates display with design tokens and auto-updating timestamp
- Files changed: components/ui/fx-rates-display.tsx
- **Learnings for future iterations:**
  - Auto-updating relative timestamp: `useState` tick counter + `setInterval` every 30s â€” minimal rerenders to keep timestamp fresh
  - Replaced `Info` icon with `TrendingUp` for compact mode button â€” better semantic match for exchange rates
  - `text-amber-400` replaced with `text-warning` design token throughout
  - Stale state shows "Rates may be outdated" message above the timestamp line
  - Clock icon added next to relative timestamp for visual clarity
  - `text-body-sm` design token used instead of `text-xs` for timestamp line
  - Tooltip styled with `bg-card border border-border rounded-lg p-3 shadow-lg` â€” consistent with CurrencyDisplay tooltip pattern
  - Inline mode uses `bg-card/50` instead of `bg-background/50` â€” matches card container pattern from codebase
---

## 2026-02-06 - US-007
- Animated currency exposure progress bars with stagger, NumberTicker, and hover effects
- Files changed: components/dashboard/currency-exposure.tsx
- **Learnings for future iterations:**
  - Progress bars use Framer Motion `motion.div` with `initial={{ width: "0%" }}` â†’ `animate={{ width: target }}` for smooth fill animation
  - Stagger delay on progress bars: `delay: index * 0.05` on each bar's transition â€” separate from staggerContainer children stagger
  - Rows stagger in via `exposureStaggerContainer` (50ms staggerChildren) + `staggerItem` variants on each `ExposureItem`
  - AnimatedPercentage uses raw `requestAnimationFrame` loop with ease-out cubic â€” lighter than useSpring for simple percentage labels
  - `getCurrencyBarColor` returns design token colours: AUD=`bg-positive`, NZD=`bg-blue-400`, USD=`bg-amber-500`
  - `getCurrencyBadgeColor` returns `/20` opacity variants for the currency icon badge background
  - Old `getCurrencyColor` + `bg-opacity-20` pattern replaced â€” Tailwind v3+ supports `bg-positive/20` directly
  - Row hover: `hover:bg-accent/5` with `rounded-lg px-2 py-1.5 -mx-2` for padded hover area without affecting layout
  - NumberTicker used for value amounts â€” animates on currency change (e.g., AUDâ†’USD recalculation)
---

## 2026-02-06 - US-008
- Polished currency exposure card with design tokens
- Files changed: components/dashboard/currency-exposure.tsx
- **Learnings for future iterations:**
  - Currency exposure card was already mostly using design tokens from US-007 work
  - Changed currency display name from `text-muted-foreground` to `text-foreground font-medium` per AC
  - Replaced `bg-gray-500` fallback in getCurrencyBarColor with `bg-muted` design token
  - Replaced `bg-gray-500/20` fallback in getCurrencyBadgeColor with `bg-muted/20` design token
  - Skeleton loading already used `bg-muted animate-pulse` pattern â€” no changes needed
  - All dashboard cards consistently use `bg-card` (not `bg-card/50`) â€” keep this pattern
---

## 2026-02-06 - US-009
- Polished currency filter dropdown on holdings page with flag emojis and design tokens
- Files changed: components/holdings/currency-filter.tsx
- **Learnings for future iterations:**
  - CurrencyFilter options now include flag emojis: ðŸ‡¦ðŸ‡º AUD, ðŸ‡³ðŸ‡¿ NZD, ðŸ‡ºðŸ‡¸ USD (All Currencies has no flag)
  - SelectTrigger: `bg-card border border-border text-foreground` â€” matches card surface pattern
  - SelectContent: `bg-card border-border` â€” uses card background for elevated dropdown
  - SelectItem: `text-foreground focus:bg-accent/10 focus:text-foreground` â€” accent highlight on focus/selection
  - Width increased from 160px to 180px to accommodate flag emojis
  - Filter icon keeps `text-muted-foreground` as a subdued visual cue
---
