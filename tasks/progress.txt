## Codebase Patterns
- Project uses Next.js 16+ App Router with TypeScript
- Drizzle ORM is already installed (`drizzle-orm`, `drizzle-kit`, `@neondatabase/serverless`)
- shadcn/ui components available in `components/ui`
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Next.js 16 doesn't have `next lint` command - use `eslint .` directly

- Database module uses lazy initialization via Proxy to avoid build-time errors when DATABASE_URL is not set
- ClerkProvider conditionally renders based on NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY to allow builds without Clerk keys
- Use `export const dynamic = "force-dynamic"` for pages/layouts that use Clerk components
- Dashboard routes at `/dashboard` and `/profile` are protected; landing page `/` is public

- TanStack Query provider is in `components/providers/query-provider.tsx` - wrap layouts with QueryProvider
- ClerkProvider wrapper is in `components/providers/clerk-provider.tsx` - handles missing Clerk keys gracefully
- Use `useAuthSafe` hook from `lib/hooks/use-auth-safe.ts` for client-side auth state that works with/without Clerk

- Toast notifications use Sonner - import `toast` from `sonner` and use `toast.success()` / `toast.error()`
- Toaster component is in root layout; for dark mode only, hardcode `theme="dark"` in Sonner component

- Dashboard navigation uses `components/dashboard/nav.tsx` with usePathname for active state
- Navigation items array can be extended with new pages (Import and Export pages follow same pattern)

- Existing database schemas in `lib/db/schema.ts`:
  - holdings: id, name, symbol, type, currency, exchange, is_dormant, user_id, created_at, deleted_at
  - transactions: id, holding_id, date, action, quantity, unit_price, fees, currency, notes
  - snapshots: id, holding_id, date, balance, currency
  - contributions: id, holding_id, date, employer_contrib, employee_contrib

- Import utilities in `lib/import/`:
  - csv-parser.ts - parseCSV function
  - transaction-importer.ts - importTransactions
  - snapshot-importer.ts - importSnapshots
  - validators/ - transaction and snapshot validators

- File download pattern (from import page templates):
  - Create Blob with content and MIME type
  - Use URL.createObjectURL and temporary anchor element
  - Set download attribute for filename
  - Click programmatically and revoke object URL

- API response patterns:
  - For file downloads: set Content-Type and Content-Disposition headers
  - Return new Response(content, { headers })
  - CSV MIME type: "text/csv;charset=utf-8"
  - JSON MIME type: "application/json"

---

# W-13 Data Export Progress Log

Started: 2026-02-03

---

## 2026-02-03 - US-001
- Implemented holdings export utility with CSV and JSON export functions
- Files created: lib/export/holdings-exporter.ts
- **Learnings for future iterations:**
  - Export utilities should map camelCase DB fields to snake_case for CSV/JSON consistency with import format
  - CSV escaping handles commas, quotes, and newlines - wrapping in quotes and doubling internal quotes
  - Use Holding type from @/lib/db/schema for type safety
---

## 2026-02-03 - US-002
- Implemented transactions export utility with CSV and JSON export functions
- Files created: lib/export/transactions-exporter.ts
- **Learnings for future iterations:**
  - Transactions require symbol from related holding for meaningful exports - created TransactionWithSymbol interface extending Transaction
  - Follow same escapeCSVValue pattern and CSV_COLUMNS structure from holdings exporter for consistency
  - CSV column order matches import format: date, symbol, action, quantity, unit_price, fees, currency, notes
---

## 2026-02-03 - US-003
- Implemented snapshots export utility with CSV and JSON export functions
- Files created: lib/export/snapshots-exporter.ts
- **Learnings for future iterations:**
  - Snapshots need holding name for meaningful exports - created SnapshotWithDetails interface extending Snapshot
  - Contributions (employer_contrib, employee_contrib) are optional fields - may be present if snapshot corresponds to super holdings
  - CSV columns: date, holding_name, balance, currency, employer_contrib, employee_contrib
---

## 2026-02-03 - US-004
- Implemented full backup export utility combining all data types into a single JSON file
- Files created: lib/export/backup-exporter.ts
- **Learnings for future iterations:**
  - Full backup includes: metadata (export_date, version, user_id), holdings, transactions, snapshots, contributions
  - Reuse existing type interfaces from other exporters (TransactionWithSymbol, SnapshotWithDetails)
  - Created ContributionWithHoldingName interface for contributions with holding context
  - Used FullBackupInput interface to type the input object for better API clarity
  - Version field (BACKUP_VERSION = "1.0.0") allows future format changes to be tracked
---

## 2026-02-03 - US-005
- Created export API endpoint for holdings at app/api/export/holdings/route.ts
- Files created: app/api/export/holdings/route.ts
- **Learnings for future iterations:**
  - Export API endpoints use `new Response(content, { headers })` instead of NextResponse.json for file downloads
  - Content-Type for CSV: "text/csv;charset=utf-8", for JSON: "application/json"
  - Content-Disposition: `attachment; filename="holdings-${timestamp}.csv"` triggers browser download
  - Query param `format=csv|json` controls export format (default: csv)
  - Fetch all holdings including dormant (exclude deleted via isNull(deletedAt))
---


## 2026-02-03 - US-006
- Created export API endpoint for transactions at app/api/export/transactions/route.ts
- Files created: app/api/export/transactions/route.ts
- **Learnings for future iterations:**
  - Transactions require a join with holdings table to include the symbol in exports
  - Use `innerJoin` with holdings to get symbol field, filtering by userId on holdings table
  - Must exclude both deleted transactions AND deleted holdings in the where clause
  - Same Response pattern as holdings export: Content-Type and Content-Disposition headers
---

## 2026-02-03 - US-007
- Created export API endpoint for snapshots at app/api/export/snapshots/route.ts
- Files created: app/api/export/snapshots/route.ts
- **Learnings for future iterations:**
  - Snapshots require a join with holdings to get holding name for meaningful exports
  - Contributions are fetched separately and matched by holdingId + date via a Map lookup
  - Use Map for contribution lookup: key = `${holdingId}-${date}`, value = { employerContrib, employeeContrib }
  - Same Response pattern: Content-Type and Content-Disposition headers with timestamp in filename
  - Must exclude deleted snapshots, deleted holdings, and deleted contributions in where clauses
---
