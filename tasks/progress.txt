# Ralph Progress Log — bi-c-dashboard-ui
# Budget Intelligence Phase C — Dashboard UI Rebuild
# 12 stories: BI-C-001 through BI-C-012

## Codebase Patterns
- Budget page now uses `useBudgetSummary()` hook from `lib/hooks/use-budget-summary.ts` (not the old `lib/budget/summary.ts` type)
- API `/api/budget/summary` returns new shape: `{ periodId, period: { startDate, endDate, totalDays, daysElapsed, daysRemaining, progressPercent }, income, spendingSavers, totalSpentCents, totalBudgetedCents, savingsGoals }`
- Old `BudgetSummary` type in `lib/budget/summary.ts` is still used by `SankeyChartContainer`, `MobileBudgetChart`, `CategoryCard` — those components not yet migrated
- SaverSummary, CategorySummary, GoalSummary types exported from `lib/hooks/use-budget-summary.ts`
- Traffic light logic: compare `pacePercent` (actualCents/budgetCents*100) vs `progressPercent` (time-based), not raw percentUsed
- Saver colour from DB is hex string used inline via `style={{ backgroundColor }}` — CSS variables not applicable here
- Quote glob paths with parentheses in git commands: `git add "app/(dashboard)/budget/page.tsx"`
- Transaction API supports `saver` query param to filter by saver_key; response includes `saverKey`, `categoryKey`, `tags`
- Next.js 16 dynamic routes use `params: Promise<{}>` — unwrap with `use(params)` from React
- Budget chart components go in `components/budget/charts/` directory; wrap with `ChartCard` from `components/charts/chart-card.tsx`
- For horizontal bar charts: Recharts `BarChart layout="vertical"`, use `barGap={-barHeight}` to overlay bars
- Spending transactions have negative `amountCents`; use `Math.abs()` when summing and filter `>= 0` to exclude income
- For Recharts dashed reference lines as Area: use `<Area fill="none" strokeDasharray="6 4" />` instead of ReferenceLine when you need data-bound diagonal lines
- Transaction API supports `categoryKey` and `tag` query params for filtering; tag uses JSONB `@>` containment operator
- PUT `/api/budget/transactions/[id]/category` accepts optional `saverKey`, `categoryKey`, `tags` alongside required `category_id`
- Savers API returns `{ savers: [...] }` wrapper — unwrap with `data.savers` when fetching client-side
- For JSONB array aggregation use raw SQL: `db.execute(sql\`SELECT ... FROM table, jsonb_array_elements_text(col) AS tag ...\`)` — returns `{ rows: [...] }`
- Recharts `Treemap` data needs index signature (`[key: string]: ...`) on interface to satisfy `TreemapDataType`; `Tooltip` must be a child of `<Treemap>`, not outside `ResponsiveContainer`
- Waterfall chart technique: stacked bars with invisible `base` bar + visible `value` bar; use `stackId` to stack them

---

## 2026-02-13 - BI-C-001
- What was implemented: Replaced flat category-based budget page with saver-based overview
- Files changed:
  - `app/(dashboard)/budget/page.tsx` — full rewrite to saver-based layout
  - `app/api/budget/summary/route.ts` — added `periodId` to JSON response
  - `lib/hooks/use-budget-summary.ts` — added `periodId` to BudgetSummary type, exported sub-types
- **Learnings for future iterations:**
  - The old page imported `BudgetSummary` from `lib/budget/summary.ts` and fetched directly via inline `fetchBudgetSummary`. New page uses `useBudgetSummary()` hook which has its own type definitions.
  - The old summary API returned a flat shape with `categories[]` and `totals{}`. The new API returns `spendingSavers[]` with nested `categories[]` per saver.
  - PeriodSelector and AIRecommendationButton both need `summary.periodId` — this was missing from the new API response until added.
  - `RecommendationModal` uses a `categoryMap` — when flattening from savers, use `cat.categoryKey` as the key (not categoryId).
  - Components removed from page imports (SankeyChartContainer, MobileBudgetChart, CategoryCard, PaydayCountdown, SavingsIndicator, SpendingTrends) still exist and may be used in future stories.
---

## 2026-02-13 - BI-C-002
- What was implemented: Goal tracker widget with expandable cards, progress bars, inline edit form
- Files changed:
  - `components/budget/goal-tracker.tsx` — new component with GoalTracker, GoalCard, GoalEditForm, GoalTrackerSkeleton
  - `app/(dashboard)/budget/page.tsx` — imported and placed GoalTracker after Spending Savers section
- **Learnings for future iterations:**
  - `useBudgetGoals()` hook from `lib/hooks/use-budget-goals.ts` provides full Goal[] with percentComplete, status, notes, etc.
  - `useUpdateGoal(id)` mutation invalidates both `budget.goals` and `budget.summary()` query keys on success
  - Goal colour from DB is hex string (same pattern as savers) — use inline `style={{ backgroundColor }}` for progress bars
  - For ETA calculation: if `targetDate` is set, use it directly; otherwise estimate from `monthlyContributionCents` vs remaining amount
  - Debt payoff goals identified by name containing "debt", "payoff", "pay off", or "loan" — show "Clears [month]" instead of "ETA [month]"
  - Goal cards use click-to-expand pattern (not navigate) since goals don't have their own detail pages
---

## 2026-02-13 - BI-C-003
- What was implemented: Saver detail view with category drilldown and recent transactions
- Files changed:
  - `app/(dashboard)/budget/saver/[saverKey]/page.tsx` — new dynamic route page with saver header, category breakdown, and transaction list
  - `app/api/budget/transactions/route.ts` — added `saver` query param filter and `saverKey`, `categoryKey`, `tags` to response
- **Learnings for future iterations:**
  - Transaction API now supports `?saver=food` filter using `eq(upTransactions.saverKey, saver)`
  - Transaction response now includes `saverKey`, `categoryKey`, and `tags` fields (needed for BI-C-007 too)
  - Saver detail page reuses `useBudgetSummary()` to get the saver data, then filters to find the matching saver by `saverKey`
  - Transactions fetched separately via `/api/budget/transactions?saver=X&from=Y&to=Z&limit=20`
  - Next.js 16 uses `params: Promise<{}>` pattern — unwrap with `use(params)` from React
  - Categories sorted by actual spend descending, then alphabetically — gives a natural "where the money went" ordering
  - Tags rendered as pill badges using `bg-muted text-muted-foreground` for subtle appearance
---

## 2026-02-13 - BI-C-004
- What was implemented: Horizontal bar chart showing budget vs actual for each spending saver with pace reference line
- Files changed:
  - `components/budget/charts/budget-vs-actual-chart.tsx` — new chart component using Recharts BarChart with vertical layout
  - `app/(dashboard)/budget/page.tsx` — imported and placed BudgetVsActualChart between progress bar and saver cards
- **Learnings for future iterations:**
  - Recharts horizontal bars: use `layout="vertical"` on BarChart component
  - Overflow visualisation: split actual into `actualNormal` (capped at budget) and `actualOverflow` (excess), stack them with `stackId="actual"`, colour overflow in NEGATIVE red
  - Budget bar rendered as transparent fill with `stroke={CHART_GRID}` for outlined/ghost appearance
  - Pace reference line uses `ReferenceLine x={paceLineValue}` with dashed stroke
  - Custom YAxisLabel component renders emoji + name as SVG text — pass chartData as prop to look up emoji
  - `barGap={-barHeight}` overlays actual bar on top of budget bar for visual comparison
  - ChartCard wrapper from `components/charts/chart-card.tsx` provides consistent card styling + Framer Motion fade-in
  - Chart height is dynamic based on number of savers: `savers.length * (barHeight + gap) + padding`
---

## 2026-02-13 - BI-C-005
- What was implemented: Cumulative spending pace line chart showing actual spending vs budget pace line
- Files changed:
  - `components/budget/charts/spending-pace-chart.tsx` — new chart using Recharts AreaChart with pace line overlay
  - `app/(dashboard)/budget/page.tsx` — imported and placed SpendingPaceChart after BudgetVsActualChart
- **Learnings for future iterations:**
  - Transaction data grouped client-side by day rather than adding a new API endpoint — fetch all period transactions with limit=2000 and group by `Math.floor(diffMs / (1000*60*60*24)) + 1`
  - Pace line rendered as an Area with `fill="none"` and dashed stroke for the diagonal reference line effect
  - Spending = negative amountCents in up_transactions; filter `txn.amountCents >= 0` to exclude income
  - Line colour dynamically set: NEGATIVE (red) if current cumulative > pace, POSITIVE (green) if under pace
  - Area fill uses linearGradient with low opacity for subtle under-pace shading
  - X-axis tick labels use modulo filter (`day % 5 === 0`) to avoid label crowding on ~30 day periods
  - Today marker uses ReferenceLine with `x={daysElapsed}` and dotted stroke
  - Query key reuses `queryKeys.budget.transactions.list()` with from/to/limit filters for proper cache management
---

## 2026-02-13 - BI-C-006
- What was implemented: AI check-in card showing latest recommendation with overall status, saver health grid, insights, actionable tip, and "Run Check-in" button with polling
- Files changed:
  - `components/budget/ai-checkin-card.tsx` — new component with AiCheckinCard, RecommendationDisplay, AiCheckinSkeleton
  - `app/(dashboard)/budget/page.tsx` — imported and placed AiCheckinCard after GoalTracker section
- **Learnings for future iterations:**
  - `useLatestRecommendation(periodId)` from `lib/hooks/use-budget-recommendation.ts` returns structured `Recommendation` with `overallStatus`, `saverStatuses`, `insights`, `actionableTip`, etc.
  - `useRequestRecommendation()` mutation calls POST `/api/budget/recommendations/request` (saver-based, not the old category-based POST)
  - Polling for async n8n results: use `queryClient.invalidateQueries` on a timer (every 5s) rather than manual fetch — TanStack Query handles cache updates and re-renders automatically
  - Baseline ID pattern: capture current recommendation ID before requesting, stop polling when a new ID appears via the query data
  - Recommendation `generatedAt` may be null (for old records) — fall back to `createdAt` for timestamp display
  - Saver health grid uses `saverStatuses[].saverKey` as labels — these are machine keys (e.g. "food"), not display names with emojis
---

## 2026-02-13 - BI-C-007
- What was implemented: Updated transaction list with three-tier classification display (saver/category/tags), filter capabilities, and inline edit form
- Files changed:
  - `app/(dashboard)/budget/transactions/page.tsx` — added saver/category/tags display, ClassificationLabel component, TagPills component, TransactionEditForm, saver filter, tag filter, edit button per row
  - `app/api/budget/transactions/route.ts` — added `categoryKey` and `tag` query param filters (tag uses JSONB `@>` containment operator)
  - `app/api/budget/transactions/[id]/category/route.ts` — extended to accept `saverKey`, `categoryKey`, and `tags` in addition to `category_id`
- **Learnings for future iterations:**
  - Transaction API now supports `?categoryKey=X` and `?tag=Y` filters; tag filter uses `tags @> '["tagvalue"]'::jsonb` for JSONB array containment
  - PUT category endpoint now accepts optional `saverKey`, `categoryKey`, and `tags` fields alongside the required `category_id`
  - Savers API (`/api/budget/savers`) returns `{ savers: [...] }` wrapper — unwrap with `data.savers` when fetching
  - Edit form cascading dropdowns: when saver changes, reset category selection — use `saverCategories` from the selected saver's `categories[]` array to filter the BudgetCategory list
  - `ClassificationLabel` component shows "emoji Saver > Category" using savers data to resolve display names from machine keys
  - Tags rendered as pill badges with `bg-muted text-muted-foreground` for subtle styling consistent with saver detail page
  - Mobile TransactionCard doesn't need `onCategoryChange` prop — it uses the edit form for all classification changes
---

## 2026-02-13 - BI-C-008
- What was implemented: Tag explorer page with JSONB unnest API, sortable table, period selector, search filter, and navigation to filtered transaction list
- Files changed:
  - `app/api/budget/tags/route.ts` — new API endpoint using raw SQL with `jsonb_array_elements_text()` to unnest and aggregate tags
  - `app/(dashboard)/budget/tags/page.tsx` — new page with sortable table, period dropdown, search input, empty state
  - `app/(dashboard)/budget/page.tsx` — added Tags link button in header actions
  - `lib/query-keys.ts` — added `budget.tags(periodId)` query key
- **Learnings for future iterations:**
  - JSONB unnest in Drizzle requires raw SQL via `db.execute(sql\`...\`)` — returns `{ rows: [...] }` not an array directly
  - For raw SQL with Drizzle column references, use `${upTransactions.columnName}` inside `sql` template for proper table/column resolution
  - Budget periods API returns sorted by startDate desc — `periods[0]` is the most recent period
  - Clicking a tag navigates to `/budget/transactions?tag=encodedTag` — the existing transactions page already supports the `tag` query param
  - The `withAuth` wrapper handles auth + error catching uniformly — just return NextResponse from the handler
  - Unused Drizzle imports (and, gte, lte, isNull) cause lint errors — only import what's actually used
---

## 2026-02-13 - BI-C-009
- What was implemented: Category treemap chart for saver detail view showing proportional spend by category with traffic-light colouring
- Files changed:
  - `components/budget/charts/category-treemap.tsx` — new Recharts Treemap component with custom content renderer, tooltip, click-to-filter, and legend
  - `app/(dashboard)/budget/saver/[saverKey]/page.tsx` — imported and placed CategoryTreemap above the category list
- **Learnings for future iterations:**
  - Recharts `Treemap` requires data with index signature `[key: string]: ...` — use `interface X { [key: string]: string | number | ... }` to satisfy `TreemapDataType`
  - Treemap custom content renderer receives all data fields as props — access `fill` via `(props as Record<string, unknown>)["fill"]`
  - Recharts `Tooltip` must be a child of the chart component (`<Treemap>...</Treemap>`) not outside `ResponsiveContainer`
  - For treemap rectangles, use `rx`/`ry` attributes on SVG `<rect>` for rounded corners
  - Label visibility in treemap cells should be gated on rectangle width/height to avoid text overflow in small cells
  - Categories with zero actual spend are filtered out of the treemap to avoid empty rectangles
---

## 2026-02-13 - BI-C-010
- What was implemented: Savings waterfall chart showing income flowing into spending savers, savings goals, and investments with a remaining float bar
- Files changed:
  - `components/budget/charts/savings-waterfall.tsx` — new waterfall chart using Recharts stacked BarChart with invisible base + visible value bars
  - `app/(dashboard)/budget/page.tsx` — added toggle tabs switching between Budget vs Actual and Income Allocation (waterfall) views
- **Learnings for future iterations:**
  - Waterfall chart technique: use stacked bars with an invisible `base` bar (fill="transparent") and a visible `value` bar, both sharing a `stackId`
  - The summary API only returns spending savers — to get savings_goal and investment savers, use `useBudgetSavers()` which fetches all saver types
  - Toggle tabs between charts: use a simple state variable with styled buttons in a `bg-muted/50` container, active tab gets `bg-card shadow-sm`
  - Income for waterfall should use `expectedCents` (budget) not `actualCents` (received so far) — budget allocation is about the plan, not actuals
  - SankeyChartContainer is no longer imported on the budget page — it still exists but is effectively replaced by the waterfall
---
