## Codebase Patterns
- Project uses Next.js 16+ App Router with TypeScript
- Drizzle ORM is already installed (`drizzle-orm`, `drizzle-kit`, `@neondatabase/serverless`)
- shadcn/ui components available in `components/ui`
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Next.js 16 doesn't have `next lint` command - use `eslint .` directly

- Database module uses lazy initialization via Proxy to avoid build-time errors when DATABASE_URL is not set
- Use `sql` template tag from drizzle-orm for raw SQL queries with `db.execute(sql\`...\`)`
- ClerkProvider conditionally renders based on NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY to allow builds without Clerk keys
- Use `export const dynamic = "force-dynamic"` for pages/layouts that use Clerk components
- Dashboard routes at `/dashboard` and `/profile` are protected; landing page `/` is public
- Auth pages use `(auth)` route group; dashboard uses `(dashboard)` route group

- Drizzle migrations are stored in `drizzle/` directory and should be committed to git
- The holdings schema exists in `lib/db/schema.ts` with all required fields
- Transactions schema exists with action enum: BUY, SELL, DIVIDEND, SPLIT
- Snapshots and contributions schemas exist for super/cash/debt tracking

- TanStack Query provider is in `components/providers/query-provider.tsx` - wrap layouts with QueryProvider
- ClerkProvider wrapper is in `components/providers/clerk-provider.tsx` - handles missing Clerk keys gracefully
- Use `useAuthSafe` hook from `lib/hooks/use-auth-safe.ts` for client-side auth state that works with/without Clerk

- Toast notifications use Sonner - import `toast` from `sonner` and use `toast.success()` / `toast.error()`
- Toaster component is in root layout; for dark mode only, hardcode `theme="dark"` in Sonner component

- Dashboard navigation uses `components/dashboard/nav.tsx` with usePathname for active state
- Settings page exists at `/settings` for user preferences

- API patterns:
  - Use innerJoin with holdings to validate user ownership AND include holding info
  - Return 409 Conflict for duplicate prevention (unique constraint violations)
  - Return 400 with `{ errors: { field: "message" } }` for validation errors
  - Decimal fields from Drizzle come as strings, need Number() conversion for arithmetic
  - Multipart form data: use request.formData() to get files

- Existing holdings types: stock, etf, crypto, super, cash, debt
- Holdings have: symbol, name, currency (AUD/NZD/USD), exchange, is_dormant flag
- Transactions have: date, action (BUY/SELL/DIVIDEND/SPLIT), quantity, unit_price, fees, currency
- Snapshots have: date, balance, currency (for super/cash/debt)
- Contributions have: date, employer_contrib, employee_contrib (for super only)

- CSV Import format (from CLAUDE.md):
  - Transactions: date,symbol,action,quantity,unit_price,fees,currency,exchange,notes
  - Super Snapshots: date,fund_name,balance,employer_contrib,employee_contrib,currency
  - Import should be idempotent - re-running doesn't create duplicates

---

# W-11 Data Import Progress Log

Started: 2026-02-02

---

## 2026-02-02 - US-001
- Implemented CSV parsing utility at `lib/import/csv-parser.ts`
- Files created: `lib/import/csv-parser.ts`
- **Learnings for future iterations:**
  - CSVRow type is `Record<string, string | null>` - column names as keys, values as strings or null
  - parseCSV function handles: headers, quoted values, newlines in fields, empty values -> null
  - The parser trims whitespace from field values and headers
---

## 2026-02-02 - US-002
- Implemented transaction import validator at `lib/import/validators/transaction-validator.ts`
- Files created: `lib/import/validators/transaction-validator.ts`
- **Learnings for future iterations:**
  - TransactionRow interface: date (string), symbol (string), action (BUY|SELL|DIVIDEND), quantity (number), unitPrice (number), fees (number|null), currency/exchange/notes (string|null)
  - ValidationResult interface: { valid: boolean, errors: string[], data: TransactionRow | null }
  - validateTransactionRow takes a CSVRow and optional rowNumber for error messages
  - Validates date format YYYY-MM-DD, action is case-insensitive (converts to uppercase)
  - parseNumber helper removes commas for numbers like "1,000.50"
  - PRD specifies BUY, SELL, DIVIDEND for import (schema also has SPLIT but not for import)
---

## 2026-02-02 - US-003
- Implemented snapshot import validator at `lib/import/validators/snapshot-validator.ts`
- Files created: `lib/import/validators/snapshot-validator.ts`
- **Learnings for future iterations:**
  - SnapshotRow interface: date (string), fundName (string), balance (number), employerContrib (number|null), employeeContrib (number|null), currency (string|null)
  - Same ValidationResult interface pattern as transaction validator
  - validateSnapshotRow takes CSVRow with field names: date, fund_name, balance, employer_contrib, employee_contrib, currency
  - Balance can be negative (for debt) or zero - no positivity constraint unlike transaction amounts
  - Contribution fields (employer/employee) must be non-negative if provided
  - Both validators share same date validation (YYYY-MM-DD) and parseNumber helper pattern
---

## 2026-02-02 - US-004
- Implemented transaction import service at `lib/import/transaction-importer.ts`
- Files created: `lib/import/transaction-importer.ts`
- **Learnings for future iterations:**
  - ImportResult interface: { imported: number, skipped: number, errors: ImportError[] }
  - ImportError interface: { row: number, message: string, data?: TransactionRow }
  - importTransactions(userId, rows) takes validated TransactionRow[] from US-002
  - Auto-creates holdings by symbol if not exists - uses symbol suffix (.AX -> ASX, .NZ -> NZX) to determine type
  - Duplicate detection: same holdingId + date + action + quantity (as string comparison in Drizzle)
  - Holding cache used to avoid repeated DB lookups for same symbol
  - Decimal fields stored as strings in Drizzle (quantity, unitPrice, fees use String())
  - Default currency is AUD if not provided in CSV row
---

## 2026-02-02 - US-005
- Implemented snapshot import service at `lib/import/snapshot-importer.ts`
- Files created: `lib/import/snapshot-importer.ts`
- **Learnings for future iterations:**
  - importSnapshots(userId, rows) takes validated SnapshotRow[] from US-003
  - Auto-creates holdings by fund_name (case-insensitive match) with type determined by keywords:
    - "super", "retirement", "pension", "kiwisaver" -> super
    - "debt", "loan", "credit", "mortgage", "hecs", "help" -> debt
    - Default -> cash
  - Duplicate detection: same holdingId + date (simpler than transactions since no action/quantity)
  - Creates contributions record for super holdings if employer/employee contrib provided (uses upsert pattern)
  - Holding cache uses lowercase fund name as key for case-insensitive matching
  - Shares ImportResult and ImportError interfaces with transaction importer
---

## 2026-02-02 - US-006
- Implemented transaction import API endpoint at `app/api/import/transactions/route.ts`
- Files created: `app/api/import/transactions/route.ts`
- **Learnings for future iterations:**
  - POST accepts multipart form data via `request.formData()`
  - File extracted with `formData.get("file")` - must check `file instanceof File`
  - File content read via `file.text()` - returns Promise<string>
  - Flow: parse CSV -> validate rows -> import valid rows -> combine validation errors with import errors
  - Response format: { total, imported, skipped, errors } matching ImportSummary interface
  - Validation errors counted in `skipped` (invalid rows that couldn't be imported)
  - Clerk auth via `import { auth } from "@clerk/nextjs/server"` and `const { userId } = await auth()`
  - Return 401 for unauthorized, 400 for missing/invalid file
---

## 2026-02-02 - US-007
- Implemented snapshot import API endpoint at `app/api/import/snapshots/route.ts`
- Files created: `app/api/import/snapshots/route.ts`
- **Learnings for future iterations:**
  - Follows identical pattern to transaction import endpoint (US-006)
  - Uses validateSnapshotRows from snapshot-validator and importSnapshots from snapshot-importer
  - ImportSummary interface and response format consistent with transactions endpoint
  - Both import endpoints now complete - UI components can call either:
    - POST /api/import/transactions (multipart form with CSV file)
    - POST /api/import/snapshots (multipart form with CSV file)
---

