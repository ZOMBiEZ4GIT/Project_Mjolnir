## Codebase Patterns
- Project uses Next.js 16+ App Router with TypeScript
- Drizzle ORM is already installed (`drizzle-orm`, `drizzle-kit`, `@neondatabase/serverless`)
- shadcn/ui components available in `components/ui`
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Next.js 16 doesn't have `next lint` command - use `eslint .` directly

- Database module uses lazy initialization via Proxy to avoid build-time errors when DATABASE_URL is not set
- Use `sql` template tag from drizzle-orm for raw SQL queries with `db.execute(sql\`...\`)`
- ClerkProvider conditionally renders based on NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY to allow builds without Clerk keys
- Use `export const dynamic = "force-dynamic"` for pages/layouts that use Clerk components
- Dashboard routes at `/dashboard` and `/profile` are protected; landing page `/` is public
- Auth pages use `(auth)` route group; dashboard uses `(dashboard)` route group

- Drizzle migrations are stored in `drizzle/` directory and should be committed to git
- The holdings schema exists in `lib/db/schema.ts` with all required fields
- Transactions schema exists with action enum: BUY, SELL, DIVIDEND, SPLIT

- TanStack Query provider is in `components/providers/query-provider.tsx` - wrap layouts with QueryProvider
- ClerkProvider wrapper is in `components/providers/clerk-provider.tsx` - handles missing Clerk keys gracefully
- Use `useAuthSafe` hook from `lib/hooks/use-auth-safe.ts` for client-side auth state that works with/without Clerk
- Holdings page is at `/holdings` using `app/(dashboard)/holdings/page.tsx`
- Transactions page is at `/transactions` using `app/(dashboard)/transactions/page.tsx`

- Toast notifications use Sonner - import `toast` from `sonner` and use `toast.success()` / `toast.error()`
- Toaster component is in root layout; for dark mode only, hardcode `theme="dark"` in Sonner component

- Dashboard navigation uses `components/dashboard/nav.tsx` with usePathname for active state
- Navigation items defined in array for easy extension
- ESLint no-case-declarations: wrap switch case blocks containing `const`/`let` declarations in braces `{ }`

- API patterns:
  - Use innerJoin with holdings to validate user ownership AND include holding info
  - Return 409 Conflict for duplicate prevention (unique constraint violations)
  - Return 400 with `{ errors: { field: "message" } }` for validation errors
  - Decimal fields from Drizzle come as strings, need Number() conversion for arithmetic

- Calculation helpers in `lib/calculations/`:
  - `quantity.ts` - calculateQuantityHeld for tradeable holdings
  - `cost-basis.ts` - calculateCostBasis with FIFO methodology

- Snapshots and contributions schema: uses `employer_contrib`/`employee_contrib` (not `employer_contribution`) for DB column names to avoid migration renames

---

# W-5 Snapshot Tracking Progress Log

## 2026-02-01 - US-006
- What was implemented: Contributions GET and POST endpoints
- Files changed:
  - app/api/contributions/route.ts - GET and POST handlers
- **Learnings for future iterations:**
  - Contributions only for "super" type holdings (not cash/debt)
  - Default contribution amounts to "0" when not provided
---

## 2026-02-01 - US-005
- What was implemented: Snapshots PATCH and DELETE endpoints
- Files changed:
  - app/api/snapshots/[id]/route.ts - added PATCH and DELETE handlers
- **Learnings for future iterations:**
  - Keep existing select structure for ownership check, then build separate update object
  - Soft delete pattern: set deletedAt and updatedAt timestamps
---

## 2026-02-01 - US-004
- What was implemented: Snapshots POST endpoint with validation and duplicate prevention
- Files changed:
  - app/api/snapshots/route.ts - added POST handler
- **Learnings for future iterations:**
  - Date normalization helper: normalizeToFirstOfMonth() converts any date to YYYY-MM-01
  - Month validation: isValidSnapshotMonth() checks current or previous month only
  - Validate holding type with snapshotTypes = ["super", "cash", "debt"]
---

## 2026-02-01 - US-003
- What was implemented: Snapshots API GET endpoints
- Files changed:
  - app/api/snapshots/route.ts - GET /api/snapshots with ?holding_id filter
  - app/api/snapshots/[id]/route.ts - GET /api/snapshots/[id] single snapshot
- **Learnings for future iterations:**
  - Use innerJoin with holdings table to validate user ownership AND include holding info in response
  - Pattern: select specific fields from join to create clean response object with holdingName, holdingType
---

## 2026-02-01 - US-001 & US-002
- What was implemented: Added updated_at, deleted_at fields to snapshots and contributions tables; added unique constraint on contributions(holding_id, date)
- Files changed:
  - lib/db/schema.ts - added missing fields to snapshots and contributions
  - drizzle/0001_white_scream.sql - generated migration
  - drizzle/meta/_journal.json, drizzle/meta/0001_snapshot.json - migration metadata
- **Learnings for future iterations:**
  - Schema already existed from W-1 scaffolding; only needed to add soft delete support
  - Keep DB column names as `employer_contrib`/`employee_contrib` (not renamed) to avoid interactive drizzle-kit prompts
  - Migration generation requires no interactive input when not renaming columns
---

