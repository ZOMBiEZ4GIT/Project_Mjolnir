## Codebase Patterns
- Project uses Next.js 16+ App Router with TypeScript
- Drizzle ORM is already installed (`drizzle-orm`, `drizzle-kit`, `@neondatabase/serverless`)
- shadcn/ui components available in `components/ui`
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Next.js 16 doesn't have `next lint` command - use `eslint .` directly

- Database module uses lazy initialization via Proxy to avoid build-time errors when DATABASE_URL is not set
- Use `sql` template tag from drizzle-orm for raw SQL queries with `db.execute(sql\`...\`)`
- ClerkProvider conditionally renders based on NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY to allow builds without Clerk keys
- Use `export const dynamic = "force-dynamic"` for pages/layouts that use Clerk components
- Dashboard routes at `/dashboard` and `/profile` are protected; landing page `/` is public
- Auth pages use `(auth)` route group; dashboard uses `(dashboard)` route group

- Drizzle migrations are stored in `drizzle/` directory and should be committed to git
- The holdings schema exists in `lib/db/schema.ts` with all required fields
- Transactions schema exists with action enum: BUY, SELL, DIVIDEND, SPLIT

- TanStack Query provider is in `components/providers/query-provider.tsx` - wrap layouts with QueryProvider
- ClerkProvider wrapper is in `components/providers/clerk-provider.tsx` - handles missing Clerk keys gracefully
- Use `useAuthSafe` hook from `lib/hooks/use-auth-safe.ts` for client-side auth state that works with/without Clerk
- Holdings page is at `/holdings` using `app/(dashboard)/holdings/page.tsx`
- Transactions page is at `/transactions` using `app/(dashboard)/transactions/page.tsx`

- Toast notifications use Sonner - import `toast` from `sonner` and use `toast.success()` / `toast.error()`
- Toaster component is in root layout; for dark mode only, hardcode `theme="dark"` in Sonner component

- Dashboard navigation uses `components/dashboard/nav.tsx` with usePathname for active state

- CurrencyDisplay component in `components/ui/currency-display.tsx`:
  - Use for all currency value displays for consistency
  - Props: amount, currency, showNative?, nativeCurrency?, nativeAmount?, isLoading?, compact?
  - Tooltip shows ISO code on hover; skeleton for loading state
  - Import: `import { CurrencyDisplay } from "@/components/ui/currency-display"`
- CurrencySelector component in `components/ui/currency-selector.tsx`:
  - Dropdown for switching display currency preference
  - Uses useCurrency() hook for state and API updates
  - Props: className?, showLoadingState?, compact?
  - Import: `import { CurrencySelector } from "@/components/ui/currency-selector"`
- Navigation items defined in array for easy extension
- ESLint no-case-declarations: wrap switch case blocks containing `const`/`let` declarations in braces `{ }`
- GroupBySelector component in `components/holdings/group-by-selector.tsx`:
  - Dropdown for switching group by mode (Type or Currency)
  - Export both component and type: `import { GroupBySelector, type GroupByValue }`
  - GroupByValue: "type" | "currency"
  - Import: `import { GroupBySelector } from "@/components/holdings/group-by-selector"`
- HoldingsTable supports groupBy prop for switching between type and currency grouping

- API patterns:
  - Use innerJoin with holdings to validate user ownership AND include holding info
  - Return 409 Conflict for duplicate prevention (unique constraint violations)
  - Return 400 with `{ errors: { field: "message" } }` for validation errors
  - Decimal fields from Drizzle come as strings, need Number() conversion for arithmetic

- Calculation helpers in `lib/calculations/`:
  - `quantity.ts` - calculateQuantityHeld for tradeable holdings
  - `cost-basis.ts` - calculateCostBasis with FIFO methodology

- Snapshots and contributions schema: uses `employer_contrib`/`employee_contrib` (not `employer_contribution`) for DB column names to avoid migration renames

- Query helpers in `lib/queries/`:
  - `snapshots.ts` - getLatestSnapshots() and getLatestSnapshotForHolding() for fetching most recent snapshots
  - `users.ts` - ensureUser(), getUserPreferences(), updateUserPreferences() for user management

- Calculation helpers in `lib/calculations/`:
  - `super-returns.ts` - calculateInvestmentReturns() and calculateMonthlyInvestmentReturns() for super fund performance

- Check-in status API at `/api/check-in/status` returns holdings needing current month snapshots
- Dashboard components in `components/check-in/` for monthly check-in workflow
- Quote paths with parentheses in bash git commands: `git add "app/(dashboard)/..."`

- Edit modals pattern: components/[domain]/edit-[entity]-modal.tsx structure
- For related entity editing (e.g., contributions for super snapshots), fetch existing data with useQuery and handle create/update based on existence

- Neon MCP tools can be used to run migrations when DATABASE_URL is not configured locally
- Migration snapshot chain: each snapshot's prevId must point to the previous migration's id to avoid collision errors

- Price services in `lib/services/`:
  - `yahoo-finance.ts` - fetchStockPrice() with normalizeSymbol() for ASX/NZX suffixes
  - `coingecko.ts` - fetchCryptoPrice() using symbol-to-ID mapping
  - `exchange-rates.ts` - getExchangeRate() with 1-hour cache
  - `price-cache.ts` - getCachedPrice(), setCachedPrice() with 15-minute TTL
  - `price-fetcher.ts` - fetchPrice() unified interface routing to correct provider
  - `crypto-symbols.ts` - getCoinGeckoId() mapping for 60+ tokens

- Holdings table in `components/holdings/holdings-table.tsx` includes:
  - PriceCell with stale/error indicators and retry button
  - MarketValueCell calculating quantity x price
  - GainLossCell showing unrealized gain/loss with percentage

- Net worth calculation in `lib/calculations/net-worth.ts`:
  - `calculateNetWorth(userId, { displayCurrency? })` returns NetWorthResult with netWorth, totalAssets, totalDebt, breakdown by type
  - `calculateAssetBreakdown(userId, { displayCurrency? })` returns AssetBreakdown with percentage for each type and holding
  - Both functions accept optional `displayCurrency` param (AUD, NZD, USD) - defaults to AUD
  - Both functions return `displayCurrency` and `ratesUsed` for transparency
  - Uses `calculateQuantityHeld()` for tradeable assets, `getLatestSnapshots()` for snapshot-based assets
  - HoldingValue.value is in display currency; HoldingValue.valueNative is original currency
  - Carry-forward logic: stale data is used for calculations with `StaleHolding[]` tracking
  - Tradeable staleness: 15-minute price TTL via `isCacheValid()`
  - Snapshot staleness: 2-month threshold (SNAPSHOT_STALE_THRESHOLD_MS)

- Historical net worth calculation in `lib/calculations/net-worth-history.ts`:
  - `calculateHistoricalNetWorth(userId, months)` returns HistoricalNetWorthResult with history array
  - HistoryPoint: { date, netWorth, totalAssets, totalDebt }
  - Uses carry-forward for snapshots (most recent on or before date)
  - Tradeable uses current prices (historical prices not stored) - values are estimates

- Top performers calculation in `lib/calculations/performers.ts`:
  - `getTopPerformers(userId, limit)` returns gainers and losers based on unrealized gain/loss
  - Drizzle `inArray()` with enum columns requires `as const` on values array for type safety

- Dashboard components in `components/dashboard/`:
  - Client components using TanStack Query for data fetching from API routes
  - Pattern: fetch data from API, show loading skeleton, then render content
  - Use `useAuthSafe` hook to check `isLoaded && isSignedIn` before enabling queries
  - Currency formatting: use `formatCurrency()` from `lib/utils/currency.ts` for consistent display
    - Options: `showCode`, `showSymbol`, `compact`
    - Symbols: AUD = "$", NZD = "NZ$", USD = "US$"
  - Icons from `lucide-react` (TrendingUp, TrendingDown, AlertTriangle, etc.)

- CurrencyProvider in `components/providers/currency-provider.tsx`:
  - `useCurrency()` hook for currency context in client components
  - Provides: displayCurrency, setDisplayCurrency, rates, isLoading, isStale, ratesFetchedAt, convert(), refreshRates()
  - `convert(amount, fromCurrency)` converts to display currency using current rates
  - Uses optimistic updates for immediate UI feedback when changing currency
  - Hierarchy: ClerkProvider > QueryProvider > CurrencyProvider > app

---

# W-8 Multi-Currency Support Progress Log

Started: 2026-02-02

---

## 2026-02-02 - US-001
- Implemented user_preferences table schema for storing display currency preference
- Files changed:
  - `lib/db/schema.ts` - Added userPreferences table, relations, and types
  - `drizzle/0005_robust_leo.sql` - Migration for new table
  - `drizzle/meta/0005_snapshot.json` - Drizzle meta snapshot
  - `drizzle/meta/_journal.json` - Updated journal
- **Learnings for future iterations:**
  - The currencyEnum already exists in the schema, so we can reuse it
  - Schema follows existing patterns: uuid id, timestamp fields, relations
  - Unique constraint on user_id ensures one preference per user
---

## 2026-02-02 - US-002
- Implemented user preferences API endpoints
- Files changed:
  - `app/api/preferences/route.ts` - GET and PATCH handlers for preferences
  - `lib/queries/users.ts` - Helper functions for user management
- **Learnings for future iterations:**
  - The user_preferences table has a foreign key to users table - must ensure user exists before creating preferences
  - Created ensureUser() helper to upsert user records when needed
  - API follows existing patterns: Clerk auth, error handling with { errors: { field: message } } format
  - Preferences API returns { displayCurrency, updatedAt } to match acceptance criteria
---

## 2026-02-02 - US-003
- Implemented currency conversion utility
- Files changed:
  - `lib/utils/currency.ts` - New file with convertCurrency function and types
- **Learnings for future iterations:**
  - Currency utilities are in `lib/utils/` directory (separate from `lib/utils.ts` which has shadcn utility)
  - Uses AUD as intermediary for cross-currency conversions (e.g., USDâ†’NZD goes via AUD)
  - ExchangeRates type: `{ "USD/AUD": number, "NZD/AUD": number }` - rates represent how many AUD per 1 foreign unit
  - Rounds to 2 decimal places for display consistency
---

## 2026-02-02 - US-004
- Implemented currency formatting utility
- Files changed:
  - `lib/utils/currency.ts` - Added formatCurrency function, FormatCurrencyOptions interface, CURRENCY_SYMBOLS map
- **Learnings for future iterations:**
  - formatCurrency supports options: showCode, showSymbol, compact
  - Currency symbols: AUD = "$", NZD = "NZ$", USD = "US$"
  - Compact notation uses K/M/B suffixes for 1000+/1M+/1B+ values
  - formatCompactValue helper shows 1 decimal place only when needed
---

## 2026-02-02 - US-005
- Implemented CurrencyDisplay component for consistent currency formatting
- Files changed:
  - `components/ui/currency-display.tsx` - New CurrencyDisplay component with tooltip and skeleton
  - `components/ui/tooltip.tsx` - Added shadcn/ui Tooltip component
  - `package.json` - Added @radix-ui/react-tooltip dependency
  - `app/test-currency/page.tsx` - Test page for visual verification
- **Learnings for future iterations:**
  - CurrencyDisplay accepts: amount, currency, showNative?, nativeCurrency?, nativeAmount?, isLoading?, compact?
  - Tooltip uses shadcn/ui pattern with TooltipProvider, Tooltip, TooltipTrigger, TooltipContent
  - Native currency indicator shows `(currencyCode)` badge when showNative=true and currencies differ
  - Loading skeleton uses inline span with animate-pulse for consistent sizing
  - Test pages can be added at `/test-*` routes for component verification
---

## 2026-02-02 - US-006
- Implemented CurrencyProvider context for app-wide currency management
- Files changed:
  - `components/providers/currency-provider.tsx` - New provider with TanStack Query integration
  - `app/layout.tsx` - Wrapped app in CurrencyProvider
- **Learnings for future iterations:**
  - CurrencyProvider must be inside QueryProvider (needs queryClient) and ClerkProvider (needs auth)
  - Provider hierarchy: ClerkProvider > QueryProvider > CurrencyProvider > app content
  - `useCurrency()` hook provides: displayCurrency, setDisplayCurrency, rates, isLoading, isStale, ratesFetchedAt, convert, refreshRates
  - Uses optimistic updates for setDisplayCurrency (immediate UI update, persist async)
  - Fetches from `/api/preferences` and `/api/exchange-rates` on mount when authenticated
  - `convert(amount, fromCurrency)` function handles rates unavailable gracefully (returns original)
  - Import pattern: `import { CurrencyProvider, useCurrency } from "@/components/providers/currency-provider"`
---

## 2026-02-02 - US-007
- Implemented CurrencySelector component for display currency switching
- Files changed:
  - `components/ui/currency-selector.tsx` - New dropdown selector component
- **Learnings for future iterations:**
  - CurrencySelector uses shadcn/ui Select component with custom trigger
  - Uses useCurrency() hook from CurrencyProvider for state and API updates
  - Two display modes: compact (currency code only) and full (symbol + code + label)
  - DollarSign icon from lucide-react indicates currency context
  - setDisplayCurrency handles optimistic updates automatically (via CurrencyProvider)
  - Import: `import { CurrencySelector } from "@/components/ui/currency-selector"`
---

## 2026-02-02 - US-008
- Added CurrencySelector to dashboard header next to refresh button
- Files changed:
  - `components/dashboard/dashboard-header.tsx` - Added CurrencySelector import and component
- **Learnings for future iterations:**
  - DashboardHeader has a flex container with welcome message on left, toolbar items on right
  - Toolbar items (CurrencySelector, Refresh button) are grouped in a flex div with gap-3
  - CurrencySelector uses compact mode by default which fits well in toolbar
  - Changing currency will trigger CurrencyProvider optimistic update, which re-renders all components using useCurrency()
  - Actual dashboard value conversion happens in US-009/US-010 (net worth calculations + dashboard updates)
---

## 2026-02-02 - US-009
- Updated net worth calculations to support multi-currency display
- Files changed:
  - `lib/calculations/net-worth.ts` - Added displayCurrency parameter and ratesUsed to both functions
- **Learnings for future iterations:**
  - `calculateNetWorth(userId, { displayCurrency: "USD" })` - optional second param for display currency
  - `calculateAssetBreakdown(userId, { displayCurrency: "USD" })` - same pattern
  - Both functions now return `displayCurrency` and `ratesUsed` (ExchangeRates type) for transparency
  - `fetchExchangeRates()` helper fetches both USD/AUD and NZD/AUD rates concurrently
  - `convertToDisplayCurrency(value, fromCurrency, toCurrency, rates)` uses convertCurrency utility
  - Helper functions `calculateTradeableValue` and `calculateSnapshotValue` now take rates and displayCurrency
  - Pre-fetch quantities and prices in maps for better performance (avoid await in loop)
  - HoldingValue.value is now in display currency, HoldingValue.valueNative is still native currency
---

## 2026-02-02 - US-010
- Updated dashboard components to use display currency conversion
- Files changed:
  - `app/api/net-worth/route.ts` - Added displayCurrency query parameter
  - `components/dashboard/net-worth-hero.tsx` - Use useCurrency hook, pass displayCurrency to API
  - `components/dashboard/summary-cards.tsx` - Use useCurrency hook, convert history values
  - `components/dashboard/asset-allocation.tsx` - Use useCurrency hook, pass displayCurrency to API
  - `components/dashboard/net-worth-chart.tsx` - Use useCurrency hook, convert chart values
  - `components/dashboard/top-performers.tsx` - Use useCurrency hook, convert gain/loss values
- **Learnings for future iterations:**
  - Dashboard components should include displayCurrency in queryKey for proper cache invalidation
  - Historical net worth values are stored in AUD, convert to display currency using `convert(amount, "AUD")`
  - API endpoints accept `displayCurrency` query param: `/api/net-worth?displayCurrency=USD`
  - All dashboard components wait for `!currencyLoading` before showing content (prevents flicker)
  - Recharts custom tooltip components need currency prop passed separately
  - formatCurrency(value, currency) from lib/utils/currency.ts handles multi-currency formatting
---

## 2026-02-02 - US-011
- Updated holdings list to display values in user's selected display currency
- Files changed:
  - `components/holdings/holdings-table.tsx` - Added currency conversion to all value cells
- **Learnings for future iterations:**
  - HoldingsTable uses useCurrency() hook at the top level, passes displayCurrency/convert/currencyLoading down to child cells
  - MarketValueCell, GainLossCell, and new CostBasisCell all use CurrencyDisplay component for consistent formatting
  - CurrencyDisplay shows native currency indicator `(NZD)` when showNative=true and currencies differ
  - Removed unused local formatting functions (formatCurrency, formatMarketValue, formatGainLossAmount) in favor of CurrencyDisplay
  - Pattern: cell components receive displayCurrency, convert function, and currencyLoading as props from parent section
---

## 2026-02-02 - US-012
- Implemented native currency toggle option for holdings page
- Files changed:
  - `lib/db/schema.ts` - Added showNativeCurrency boolean field to userPreferences table
  - `drizzle/0006_spotty_lucky_pierre.sql` - Migration for new column
  - `app/api/preferences/route.ts` - Extended PATCH to accept showNativeCurrency, updated response
  - `lib/queries/users.ts` - Updated updateUserPreferences to accept partial updates
  - `components/providers/currency-provider.tsx` - Added showNativeCurrency state and setShowNativeCurrency
  - `components/ui/native-currency-toggle.tsx` - New toggle component using Switch
  - `app/(dashboard)/holdings/page.tsx` - Added NativeCurrencyToggle to toolbar
  - `components/holdings/holdings-table.tsx` - Extended cell components to support showNativeCurrency prop
- **Learnings for future iterations:**
  - updateUserPreferences now takes an object `{ displayCurrency?, showNativeCurrency? }` for partial updates
  - CurrencyProvider has two separate mutations for displayCurrency and showNativeCurrency to allow independent updates
  - NativeCurrencyToggle uses inline skeleton styles (span with animate-pulse) since Skeleton component doesn't exist
  - When showNativeCurrency=true, cells display native currency directly without conversion or native indicator
  - showNativeCurrency affects individual holding values, but totals still use display currency for aggregation
---

## 2026-02-02 - US-013
- Implemented currency filter on holdings list
- Files changed:
  - `components/holdings/currency-filter.tsx` - New CurrencyFilter component with Select dropdown
  - `app/(dashboard)/holdings/page.tsx` - Added currency filter with URL param persistence
- **Learnings for future iterations:**
  - CurrencyFilter component exports both component and type: `import { CurrencyFilter, type CurrencyFilterValue }`
  - Filter values are: "all" | "AUD" | "NZD" | "USD"
  - URL param pattern: `/holdings?currency=AUD` - "all" removes the param entirely
  - Filter state read from searchParams with validation: check if value is in allowed list before using
  - useMemo for filtering: `filteredHoldings = holdings.filter(h => h.currency === currencyFilter)`
  - Separate empty state for "no holdings" vs "no holdings matching filter"
  - Filter integrates with existing show_dormant switch - both can be active simultaneously
---

## 2026-02-02 - US-014
- Implemented currency grouping option on holdings list
- Files changed:
  - `components/holdings/group-by-selector.tsx` - New GroupBySelector component with Select dropdown
  - `components/holdings/holdings-table.tsx` - Added groupBy prop, groupHoldingsByCurrency function, HoldingsCurrencySection component
  - `app/(dashboard)/holdings/page.tsx` - Added GroupBySelector with URL param persistence
- **Learnings for future iterations:**
  - GroupBySelector exports both component and type: `import { GroupBySelector, type GroupByValue }`
  - GroupBy values are: "type" | "currency" (default is "type")
  - URL param pattern: `/holdings?group_by=currency` - "type" removes the param entirely
  - HoldingsTable now accepts `groupBy` prop to switch between type and currency grouping
  - HoldingsCurrencySection shows subtotal per currency section using `calculateSectionSubtotal()`
  - When grouping by currency, table shows mixed holding types with Type column visible
  - hasTradeableHoldings and hasSnapshotHoldings determine which columns to show in currency sections
  - Subtotal calculates: tradeable (quantity x price) + snapshot (latest balance), debt subtracts
---

## 2026-02-02 - US-015
- Implemented currency exposure breakdown on dashboard
- Files changed:
  - `lib/calculations/net-worth.ts` - Added calculateCurrencyExposure function with types
  - `app/api/currency-exposure/route.ts` - New API endpoint for currency exposure
  - `components/dashboard/currency-exposure.tsx` - New CurrencyExposure component
  - `app/(dashboard)/dashboard/page.tsx` - Added CurrencyExposure side-by-side with AssetAllocation
- **Learnings for future iterations:**
  - calculateCurrencyExposure groups holdings by native currency (not type)
  - Debt is excluded from currency exposure calculations
  - CurrencyExposure component uses progress bars with flag emojis for visual representation
  - Dashboard layout uses grid (lg:grid-cols-2) for side-by-side Asset Allocation and Currency Exposure
  - API follows same pattern as net-worth: displayCurrency query param, returns ratesUsed for transparency
  - Color scheme: AUD=green, NZD=blue, USD=amber for differentiation
---

