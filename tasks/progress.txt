## Codebase Patterns
- Project uses Next.js 14+ App Router with TypeScript
- Drizzle ORM is already installed (drizzle-orm, drizzle-kit, @neondatabase/serverless)
- shadcn/ui components available in components/ui
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Tailwind CSS with shadcn/ui CSS variable pattern using HSL format: hsl(var(--variable))
- CSS variables stored without hsl() wrapper e.g. --background: 240 10% 3.9%
- Glow shadows use rgba() since HSL variables can't express box-shadow alpha
- Inter font loaded via next/font/google in app/layout.tsx (applied via inter.className on body)
- Framer Motion components require "use client" directive
- Toast notifications use Sonner - import toast from sonner
- Dashboard navigation uses components/layout/sidebar.tsx and components/layout/mobile-nav.tsx
- Tailwind has semantic tokens: text-positive/bg-positive (green), text-negative/bg-negative (red), shadow-glow-sm/md/lg, shadow-glow-positive, shadow-glow-negative, shadow-card, shadow-card-hover
- Layout & spacing constants live in lib/theme.ts (sidebarWidth, cardRadius, spacing xs→2xl) — use instead of magic numbers
- Animation presets live in lib/animations.ts — import and spread onto motion.div elements (e.g. `<motion.div {...fadeIn}>`)
- Stagger presets (staggerContainer, staggerItem) use Variants type with "hidden"/"visible" keys — use with variants prop
- numberSpring is a Transition object for animating numeric values (e.g. useSpring, useMotionValue)
- Reduced motion: use `useReducedMotion()` from framer-motion directly — returns boolean for OS prefers-reduced-motion
- Hooks live in hooks/ directory (not lib/) — follow this convention for custom React hooks
- Recharts SVG props (stroke, fill) require raw hex values — CSS variables not supported in SVG rendering
- Category indicator colours (asset types, currencies) use hardcoded Tailwind colours (bg-blue-500 etc.) — these are intentional and distinct from theme tokens
- Card container pattern: `border-border bg-card/50` for bordered cards, `bg-muted` for skeleton placeholders
- Error state pattern: `border-destructive bg-destructive/10` with `text-destructive` for error messages
- Toggle pattern: active=`bg-muted text-foreground`, inactive=`text-muted-foreground hover:text-foreground`
- Form validation pattern: `border-destructive focus-visible:ring-destructive` on inputs, `text-destructive` on error messages
- Delete confirm button: `bg-destructive hover:bg-destructive/90 text-foreground`; cancel: `bg-card border-border text-foreground hover:bg-muted`
- Select dropdowns: `bg-background border-border text-muted-foreground` for trigger, `focus:bg-card focus:text-foreground` for items
- Warning/info colours (yellow-*, blue-*) are semantic and intentionally NOT part of design token migration
- Interactive toggle buttons (show/hide contributions): use `text-primary hover:text-primary/80` pattern
- html2canvas backgroundColor requires raw hex — use `#18181b` to match --card token
- Email templates (components/emails/) use inline hex values — email clients don't support CSS variables
- Only legitimate remaining hardcoded grey: `bg-gray-500` fallback in category indicator functions (asset-allocation, currency-exposure)
- Navigation items defined in lib/navigation.ts — import navItems and NavItem type from there (sidebar, mobile nav, command menu)
- New layout components live in components/layout/ — NavItemLink (nav-item.tsx) uses Framer Motion layoutId='active-nav' for animated active pill
- TooltipProvider with delayDuration={0} wraps collapsed nav items for instant tooltip display
- Sidebar collapse state persists in localStorage ('mjolnir-sidebar-collapsed') — use mounted state pattern to avoid hydration mismatch
- Sidebar is fixed positioned; content area needs dynamic left margin matching sidebar width (240px or 64px)
- AppShell (components/layout/app-shell.tsx) owns sidebar collapsed state — Sidebar receives isCollapsed/onToggleCollapsed as props
- Content area uses CSS custom property --sidebar-width with responsive Tailwind class ml-0 lg:ml-[var(--sidebar-width)] for responsive dynamic margin
- For responsive dynamic values, use CSS custom properties + Tailwind arbitrary value classes (inline styles can't be responsive)
- PageWrapper (components/layout/page-wrapper.tsx) wraps page content with fade transition — placed inside DashboardErrorBoundary in dashboard layout
- Mobile header (components/layout/mobile-nav.tsx) is fixed h-14 z-30 — content area needs pt-14 on mobile
- Sheet drawer (shadcn/ui) handles focus trapping and Escape close via Radix Dialog primitive
- Focus ring pattern: `focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring` matches shadcn/ui conventions
- Shared UI components (e.g. SpeedDial) live in `components/shared/` directory
- To open AddHoldingDialog/AddTransactionDialog programmatically: pass a hidden `<button ref={ref} />` as children, then call `ref.current?.click()`
- CheckInModal uses controlled `open`/`onOpenChange` props — can be opened from any external trigger
- HoldingsTable hybrid grouping: `typeFilter="all"` shows collapsible grouped sections, specific type shows flat list via `HoldingsFlatSection`
- Shared table rendering: `HoldingsTableContent` component handles row rendering for both grouped and flat views
- GroupHeader (components/holdings/group-header.tsx) shows label, count, total value, portfolio % badge — receives calculated values as props
- `calculateGroupTotal()` in holdings-table.tsx converts holdings to display currency — use for any group-level value aggregation
- `motion.create(TableRow)` creates a motion-enhanced `MotionTableRow` for stagger animations on table rows
- Stagger rows use `motion.tbody` as container with `variants` + `initial="hidden" animate="visible"` pattern
- Capped stagger: `Math.min(0.05, 0.5 / count)` ensures total stagger completes within 500ms regardless of row count
- `useReducedMotion()` from framer-motion checks OS prefers-reduced-motion — skip animations entirely when true
- Dormant holdings sorted to bottom of each group via `useMemo` sort in `HoldingsTableContent` and `HoldingsCurrencySection`
- EmptyState component (`components/ui/empty-state.tsx`) is shared across holdings, snapshots, transactions — keep prop API stable
- `AnimatePresence mode="popLayout"` on HoldingsTable wraps content keyed by typeFilter — handles enter/exit on tab change
- Holdings table rows are clickable (navigate to `/holdings/[id]`) — action buttons use `stopPropagation` to prevent row click
- Row hover: `hover:bg-accent/5 hover:scale-[1.005] active:bg-accent/10` with `transition-[background-color,transform] duration-150`
- Filter tabs (components/holdings/filter-tabs.tsx) use Framer Motion layoutId for animated sliding indicator
- scrollbar-hide utility class added to globals.css for hidden scrollbar on overflow-x-auto elements
- TypeSelector (components/transactions/type-selector.tsx) uses layoutId="active-transaction-type" for animated tab indicator
- react-hook-form + zod installed; shadcn/ui form.tsx component available in components/ui/form.tsx
- z.coerce.number() with useForm requires casting resolver: `zodResolver(schema) as unknown as Resolver<FormValues>`
- For numeric inputs with z.coerce: pass `field.value ?? ""` to prevent "undefined" showing
- TransactionSummary cards use stagger animation with motion.div and variants pattern
- Transaction table uses monthly grouping with sticky headers (sticky top-0 z-20 bg-background)
- MotionTableRow with stagger variants + AnimatePresence mode="wait" keyed by filterKey for table animations
- Transaction action colour mapping: BUY=positive/green, SELL=destructive/red, DIVIDEND=accent/purple, SPLIT=blue-400/blue-500
- onTransactionSaved/onDeleted callbacks enable row highlight and fade-out animations from parent component
- Check-in form uses react-hook-form + zod with useFieldArray for dynamic holdings list; showContributions is UI-only state (not in form schema)
- useFieldArray `replace()` syncs form fields with API data; use a ref-based sync key to prevent re-replacing on every render
- form.trigger(`holdings.${idx}.balance`) validates individual field array items for per-step validation in wizard flows
- form.setValue with `{ shouldValidate: form.formState.isSubmitted }` re-validates on change only after first validation attempt
- Check-in status API returns `previousBalances` keyed by holdingId — most recent snapshot balance before target month
- CheckInModal is a 3-step wizard (Select Month → Update Holdings → Review & Save) with currentStep state (0-2)
- animate-shake keyframes defined in tailwind.config.ts — use `animate-shake` class with useState toggle + setTimeout auto-clear
- Type icon mapping: super=Landmark, cash=Wallet, debt=CreditCard (from lucide-react)
- CheckinPrompt (components/dashboard/checkin-prompt.tsx) replaces CheckInPromptCard — moved to dashboard/ directory
- sessionStorage dismissal pattern: use `mounted` state + useEffect to avoid hydration mismatch when reading sessionStorage
- Accent glow prompt card: `border-accent/30 bg-card/50 shadow-glow-sm` for attention-grabbing cards
- Directional step transitions: use variants with `custom` prop on AnimatePresence to pass direction to exiting components — enter slides from `100*d%`, exit slides to `-100*d%` (d=1 forward, d=-1 backward)
- Step container needs `overflow-hidden` to clip sliding content during transitions
- Accordion expand animation: `motion.div` with `height: 0` → `height: "auto"`, `overflow-hidden`, wrapped in `AnimatePresence initial={false}`
- Check-in status API returns `latestContributions` for pre-populating super contribution fields
- Success summary pattern: store mutation result in state + `showSuccess` boolean, render different content in same step (no extra wizard step)
- CheckinStepper accepts currentStep=3 (beyond max) to mark all steps completed — no code change needed in stepper

---

# UX-6 Dashboard Transformation Progress Log

Started: 2026-02-06

---

## 2026-02-06 - US-001
- Created `components/dashboard/number-ticker.tsx` — animated number ticker
- Uses `useSpring` + `useMotionValue` from framer-motion with `numberSpring` preset
- Initial mount: counts from 0 to value (600ms spring via stiffness=80, damping=20)
- Value changes: morphs to new value using spring physics
- Uses `formatCurrency()` for proper AUD/NZD/USD formatting during animation
- `tabular-nums` font-variant prevents layout shift
- `useReducedMotion()` check skips animation when OS prefers reduced motion
- Files changed: `components/dashboard/number-ticker.tsx` (new)
- **Learnings for future iterations:**
  - framer-motion v12 `useSpring` subscribes via `.on("change", cb)` — use this to update textContent directly for performance
  - `motion.span` with ref + textContent update avoids React re-renders during animation
  - `requestAnimationFrame` needed after setting initial 0 to ensure spring starts from 0 → target
---

## 2026-02-06 - US-002
- Created `components/dashboard/change-badge.tsx` — reusable change indicator
- Positive (green), negative (red), zero (muted) with TrendingUp/TrendingDown/Minus icons
- Two sizes: sm (compact for tables) and md (standard for cards)
- Uses design tokens: `text-positive bg-positive/10`, `text-destructive bg-destructive/10`
- Optional `showAmount` prop to toggle currency amount display
- Files changed: `components/dashboard/change-badge.tsx` (new)
- **Learnings for future iterations:**
  - Use `Math.abs()` for both amount and percentage display, prepend sign manually for consistent formatting
---

## 2026-02-06 - US-003
- Created `components/dashboard/stale-indicator.tsx` — stale data indicator
- Icon variant: amber AlertTriangle with shadcn/ui Tooltip showing "Last updated: X ago"
- Badge variant: amber pill with icon + relative time text
- Returns null when `isStale` is false (safe to render unconditionally)
- Files changed: `components/dashboard/stale-indicator.tsx` (new)
- **Learnings for future iterations:**
  - TooltipProvider with `delayDuration={0}` needed per usage site (or wrap at app level)
  - `asChild` on TooltipTrigger avoids extra DOM element — use span wrapper for inline display
---

## 2026-02-06 - US-004
- Rebuilt `components/dashboard/net-worth-hero.tsx` with premium styling
- Purple glow: `shadow-glow-md` + `border-accent/20` + gradient `from-card via-card to-accent/5`
- Net worth value now uses `NumberTicker` with `text-display-xl` typography
- "Net Worth" label uses `text-label` (small caps, tracking wide)
- Change indicator uses `ChangeBadge` component
- Stale data uses `StaleIndicator` (top-right corner)
- `slideUp` entrance animation with `useReducedMotion` check
- Mobile: sparkline shows below value instead of inline
- Removed unused `formatCurrency` import (caught by lint)
- Files changed: `components/dashboard/net-worth-hero.tsx` (modified)
- **Learnings for future iterations:**
  - When replacing formatCurrency with NumberTicker, remove the import — ESLint `no-unused-vars` catches this
  - `rounded-2xl` from design system for card borders
  - `relative` positioning needed on card for `absolute` stale indicator placement
---

## 2026-02-06 - US-005
- Updated `components/dashboard/summary-cards.tsx` with NumberTicker, ChangeBadge, stagger animations
- Cards stagger in with 100ms delay (overrides default 50ms)
- Hover effect: `shadow-card-hover` with 150ms transition
- Added percentage-of-net-worth indicator
- For debt cards, flip badge sign so decrease shows as positive (green)
- All hardcoded colours replaced with design tokens
- Files changed: `components/dashboard/summary-cards.tsx` (modified)
- **Learnings for future iterations:**
  - For debt: negate changeAmount/changePercent before passing to ChangeBadge so decrease = positive
  - Override staggerContainer staggerChildren: spread `...staggerContainer` then override `visible.transition`
---

## 2026-02-06 - US-006
- Updated `components/dashboard/asset-allocation.tsx` with animations and design tokens
- Bar rows stagger in (50ms), progress bars animate 0% → target (400ms ease-out)
- Donut chart centre overlay with NumberTicker showing total assets
- fadeIn entrance on card, hover bg-accent/5 on rows
- Replaced text-sm/text-xs with text-body-sm and text-label typography tokens
- Card uses rounded-2xl border border-border bg-card
- Files changed: `components/dashboard/asset-allocation.tsx` (modified)
- **Learnings for future iterations:**
  - Progress bar animation: use useState(0) → useEffect setTimeout → setState(target) with CSS transition
  - Donut centre overlay: absolute positioned div with pointer-events-none, marginBottom to offset legend
---

## 2026-02-06 - US-007
- Updated `components/dashboard/top-performers.tsx` — ChangeBadge, stagger rows, fadeIn
- Replaced inline gain/loss display with `ChangeBadge` component (size="sm")
- Stagger rows (50ms), fadeIn card entrance, hover bg-accent/5
- text-label for section headers, text-body-sm for labels
- Files changed: `components/dashboard/top-performers.tsx` (modified)
---

## 2026-02-06 - US-008 through US-012 (Design Token Batch)
- US-008: dashboard-header.tsx — heading uses text-heading-lg/text-display-md
- US-009: stale-data-warning.tsx — all yellow-* → amber-* (border-amber-500/30, bg-amber-500/10, text-amber-500)
- US-010: currency-exposure.tsx — rounded-2xl bg-card, text-label, text-body-sm
- US-011: super-breakdown-section.tsx + super-growth-chart.tsx — rounded-2xl bg-card, text-label
- US-012: net-worth-chart.tsx — rounded-2xl bg-card, text-label
- **Learnings for future iterations:**
  - Chart hex colours (#374151, #9CA3AF etc.) are required for SVG rendering — don't convert to CSS variables
  - Category indicator colours (bg-green-500, bg-blue-500 etc.) are intentional — not part of design token migration
---

## 2026-02-06 - US-013
- Updated `components/dashboard/dashboard-content.tsx` — stagger animation wrapper
- motion.div stagger container (80ms) wrapping all dashboard sections
- Each section: fadeIn+slideUp (opacity 0→1, y 16→0, 300ms easeOut)
- useReducedMotion check — all sections appear instantly when reduced motion preferred
- space-y-6 container layout, px-4 py-4 sm:px-6 sm:py-6 content padding
- Files changed: `components/dashboard/dashboard-content.tsx` (modified)
---

## 2026-02-06 - US-014
- Responsive dashboard grid refinement
- Consistent gap-6 spacing across all grid layouts (summary-cards.tsx updated from gap-4)
- All card-level elements use rounded-2xl (checkin-prompt, stale-data-warning, asset-allocation-pie-chart updated from rounded-lg)
- asset-allocation-pie-chart also updated to use bg-card and text-label tokens
- Desktop (lg+): Summary cards 2-col, Allocation+Currency 2-col, Top Performers full width with internal 2-col
- Tablet (md): Summary cards 2-col, Allocation+Currency stacked
- Mobile: Everything single column
- Files changed: `summary-cards.tsx`, `checkin-prompt.tsx`, `stale-data-warning.tsx`, `asset-allocation-pie-chart.tsx`
- **Learnings for future iterations:**
  - Check card-level border radius consistency after design token migrations — inner elements (tooltips, icons, row items) keep rounded-lg
  - Grid gap-6 for section spacing, gap-4 only for small internal layouts

## ALL 14 STORIES COMPLETE — UX-6 Dashboard Transformation finished
