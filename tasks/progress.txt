## Codebase Patterns
- Project uses Next.js 16+ App Router with TypeScript
- Drizzle ORM is already installed (`drizzle-orm`, `drizzle-kit`, `@neondatabase/serverless`)
- shadcn/ui components available in `components/ui`
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Next.js 16 doesn't have `next lint` command - use `eslint .` directly

- Database module uses lazy initialization via Proxy to avoid build-time errors when DATABASE_URL is not set
- Use `sql` template tag from drizzle-orm for raw SQL queries with `db.execute(sql\`...\`)`
- ClerkProvider conditionally renders based on NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY to allow builds without Clerk keys
- Use `export const dynamic = "force-dynamic"` for pages/layouts that use Clerk components
- Dashboard routes at `/dashboard` and `/profile` are protected; landing page `/` is public
- Auth pages use `(auth)` route group; dashboard uses `(dashboard)` route group

- Drizzle migrations are stored in `drizzle/` directory and should be committed to git
- The holdings schema exists in `lib/db/schema.ts` with all required fields
- Transactions schema exists with action enum: BUY, SELL, DIVIDEND, SPLIT

- TanStack Query provider is in `components/providers/query-provider.tsx` - wrap layouts with QueryProvider
- ClerkProvider wrapper is in `components/providers/clerk-provider.tsx` - handles missing Clerk keys gracefully
- Use `useAuthSafe` hook from `lib/hooks/use-auth-safe.ts` for client-side auth state that works with/without Clerk
- Holdings page is at `/holdings` using `app/(dashboard)/holdings/page.tsx`
- Transactions page is at `/transactions` using `app/(dashboard)/transactions/page.tsx`

- Toast notifications use Sonner - import `toast` from `sonner` and use `toast.success()` / `toast.error()`
- Toaster component is in root layout; for dark mode only, hardcode `theme="dark"` in Sonner component

- Dashboard navigation uses `components/dashboard/nav.tsx` with usePathname for active state

- API patterns:
  - Use innerJoin with holdings to validate user ownership AND include holding info
  - Return 409 Conflict for duplicate prevention (unique constraint violations)
  - Return 400 with `{ errors: { field: "message" } }` for validation errors
  - Decimal fields from Drizzle come as strings, need Number() conversion for arithmetic

- User preferences in `lib/db/schema.ts`:
  - userPreferences table with displayCurrency, showNativeCurrency fields
  - Foreign key to users table - must ensure user exists first
  - Query helpers in `lib/queries/users.ts`: ensureUser(), getUserPreferences(), updateUserPreferences()

- Check-in status API at `/api/check-in/status` returns holdings needing current month snapshots
- Dashboard components in `components/check-in/` for monthly check-in workflow

- Services in `lib/services/`:
  - `exchange-rates.ts` - getExchangeRate() with 1-hour cache
  - `price-cache.ts` - getCachedPrice(), setCachedPrice() with 15-minute TTL
  - `price-fetcher.ts` - fetchPrice() unified interface routing to correct provider

- Environment variables in .env.example:
  - DATABASE_URL, NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY, CLERK_SECRET_KEY
  - COINGECKO_API_KEY, EXCHANGE_RATE_API_KEY
  - RESEND_API_KEY (for email reminders)
  - NEXT_PUBLIC_APP_URL

- Email templates in `components/emails/`:
  - Use @react-email/components for email-compatible React components
  - Inline styles only (no Tailwind) - use style objects with `as const` for strict typing
  - Dark mode colors: background=#111827, card=#1f2937, border=#374151
  - Export both named component and default for React Email preview compatibility

---

# W-10 Email Reminders Progress Log

Started: 2026-02-02

---

## 2026-02-02 - US-001: Install and configure Resend SDK
- Installed resend npm package (v6.9.1)
- Created `lib/services/email.ts` with:
  - Lazy Resend client initialization (follows existing pattern in exchange-rates.ts)
  - `EmailError` custom error class
  - `SendEmailOptions` and `SendEmailResult` typed interfaces
  - `sendEmail()` function for sending transactional emails
  - `isEmailConfigured()` helper to check if API key is set
- Added RESEND_API_KEY to .env.example
- Files changed: `lib/services/email.ts`, `.env.example`, `package.json`, `package-lock.json`
- **Learnings for future iterations:**
  - Resend SDK uses `{ data, error }` return pattern instead of throwing
  - Default from address uses Resend's testing domain `onboarding@resend.dev`
  - Follow existing service patterns: lazy initialization, custom error classes, typed interfaces
---

## 2026-02-02 - US-002: Create email preferences schema
- Added two new fields to `userPreferences` table in `lib/db/schema.ts`:
  - `emailReminders`: boolean (default true) - enables/disables reminder emails
  - `reminderDay`: integer (default 1) - day of month (1-28) to send reminders
- Added `integer` import from drizzle-orm/pg-core
- Generated migration `drizzle/0007_rapid_blonde_phantom.sql`
- Files changed: `lib/db/schema.ts`, `drizzle/0007_rapid_blonde_phantom.sql`, `drizzle/meta/0007_snapshot.json`, `drizzle/meta/_journal.json`
- **Learnings for future iterations:**
  - Use `integer()` from drizzle-orm for integer columns (not smallint)
  - Schema fields use camelCase in code, snake_case in database (Drizzle handles conversion)
  - When committing schema changes, include both migration .sql file AND meta files
---

## 2026-02-02 - US-003: Create check-in reminder email template
- Installed @react-email/components package for email templating
- Created `components/emails/check-in-reminder.tsx` with:
  - `CheckInReminderEmail` component using React Email components
  - Dark mode styling (gray-900 background, gray-800 card) matching app design
  - Personalized greeting with user name
  - Holdings summary card showing super, cash, debt counts
  - CTA button linking to check-in page
  - Footer with optional unsubscribe link
- Exported TypeScript interfaces:
  - `HoldingsSummary` - counts for super, cash, debt, total
  - `CheckInReminderEmailProps` - userName, currentMonth, holdings, checkInUrl, unsubscribeUrl
- Files changed: `components/emails/check-in-reminder.tsx`, `package.json`, `package-lock.json`
- **Learnings for future iterations:**
  - React Email uses `@react-email/components` package (not `react-email` directly)
  - Email styles must use inline style objects, not Tailwind classes
  - Use `fontWeight: "bold" as const` for TypeScript strict mode compliance
  - Email template is a React component that exports as default for React Email preview compatibility
---

## 2026-02-02 - US-004: Create send reminder email function
- Created `lib/services/reminders.ts` with:
  - `getCheckInStatus()` - reusable function to get holdings needing check-in (extracted from API logic)
  - `sendCheckInReminder()` - main function to send personalized check-in reminder emails
- Function signature: `sendCheckInReminder({ userId, email, userName? })`
- Returns structured result: `{ success, needsCheckIn, holdingsToUpdate, error?, messageId? }`
- Email not sent if user has no holdings needing updates (needsCheckIn: false)
- Uses `render()` from @react-email/components to convert React Email template to HTML
- Builds check-in URL from NEXT_PUBLIC_APP_URL env var
- Files changed: `lib/services/reminders.ts`
- **Learnings for future iterations:**
  - Use `render()` from @react-email/components to convert React Email components to HTML string
  - Extract reusable query logic from API routes into `lib/services/` or `lib/queries/`
  - Return structured results with clear success/failure states rather than throwing errors
  - Include optional fields (like messageId) only when relevant to avoid undefined checks
---

## 2026-02-02 - US-005: Create cron job API route
- Created `app/api/cron/send-reminders/route.ts` with:
  - POST endpoint for Vercel Cron to call daily
  - CRON_SECRET authorization via Bearer token in Authorization header
  - Query for users with emailReminders=true AND reminderDay matching current day
  - Days 29-31 treated as day 28 (since reminderDay max is 28)
  - Calls sendCheckInReminder for each eligible user
  - Returns summary: { eligibleUsers, emailsSent, skippedNoCheckIn, failed }
  - GET endpoint as health check
- Added CRON_SECRET to .env.example
- Files changed: `app/api/cron/send-reminders/route.ts`, `.env.example`
- **Learnings for future iterations:**
  - Vercel Cron sends secret as "Bearer <secret>" in Authorization header
  - Use innerJoin with users and userPreferences to get both user info and preferences
  - Handle edge cases gracefully (days 29-31 â†’ day 28 for monthly reminders)
  - Log progress with prefix like `[send-reminders]` for easier debugging
---

## 2026-02-02 - US-006: Configure Vercel cron schedule
- Updated `vercel.json` to add crons configuration
- Schedule: `0 23 * * *` (daily at 11pm UTC = 9am AEST)
- Path: `/api/cron/send-reminders`
- CRON_SECRET was already in .env.example from US-005
- Files changed: `vercel.json`
- **Learnings for future iterations:**
  - Vercel cron schedule uses standard cron syntax in UTC timezone
  - 9am AEST = 11pm UTC previous day (AEST is UTC+10 during standard time, UTC+11 during daylight saving)
  - Cron config goes in `crons` array in vercel.json with `path` and `schedule` properties
---

## 2026-02-02 - US-007: Add email preferences API endpoints
- Extended `/api/preferences` GET response to include `emailReminders` and `reminderDay` fields
- Extended `/api/preferences` PATCH to accept `emailReminders` (boolean) and `reminderDay` (integer 1-28)
- Added validation for `reminderDay` range (must be between 1 and 28)
- Updated `lib/queries/users.ts` `UpdatePreferencesInput` interface to include new fields
- Updated `updateUserPreferences` function to handle `emailReminders` and `reminderDay`
- Files changed: `app/api/preferences/route.ts`, `lib/queries/users.ts`
- **Learnings for future iterations:**
  - Preferences API follows pattern: GET returns all prefs, PATCH accepts partial updates
  - Validation errors use `{ errors: { field: "message" } }` format with 400 status
  - Integer validation in JS: check `typeof === "number"` AND `Number.isInteger()` for proper integer checking
---

## 2026-02-02 - US-008: Create email preferences UI component
- Created `components/settings/email-preferences.tsx` with:
  - Toggle switch for enabling/disabling email reminders
  - Dropdown selector for reminder day (1st-28th of month)
  - User's primary email address display from Clerk
  - Loading skeleton while preferences load
  - Toast notifications for success/error on updates
- Used TanStack Query with same `["preferences"]` query key as CurrencyProvider
- Implemented optimistic updates with rollback on error
- Used `useUser` hook from `@clerk/nextjs` for client-side user email access
- Files changed: `components/settings/email-preferences.tsx`
- **Learnings for future iterations:**
  - Use `useUser()` from `@clerk/nextjs` to get user info client-side (vs `currentUser()` server-side)
  - Access email via `user?.primaryEmailAddress?.emailAddress`
  - When sharing query key with other providers, optimistic updates should follow same pattern
  - Day selector uses 1-28 range to avoid month-end edge cases
  - Disable dependent controls (like day selector) when parent toggle is off
---

