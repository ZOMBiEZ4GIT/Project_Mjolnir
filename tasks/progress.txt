## Codebase Patterns
- Project uses Next.js 16+ App Router with TypeScript
- Drizzle ORM is already installed (`drizzle-orm`, `drizzle-kit`, `@neondatabase/serverless`)
- shadcn/ui components available in `components/ui`
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Next.js 16 doesn't have `next lint` command - use `eslint .` directly

- Database module uses lazy initialization via Proxy to avoid build-time errors when DATABASE_URL is not set
- Use `sql` template tag from drizzle-orm for raw SQL queries with `db.execute(sql\`...\`)`
- ClerkProvider conditionally renders based on NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY to allow builds without Clerk keys
- Use `export const dynamic = "force-dynamic"` for pages/layouts that use Clerk components
- Dashboard routes at `/dashboard` and `/profile` are protected; landing page `/` is public
- Auth pages use `(auth)` route group; dashboard uses `(dashboard)` route group

- Drizzle migrations are stored in `drizzle/` directory and should be committed to git
- The holdings schema already exists in `lib/db/schema.ts` with all required fields

- TanStack Query provider is in `components/providers/query-provider.tsx` - wrap layouts with QueryProvider
- ClerkProvider wrapper is in `components/providers/clerk-provider.tsx` - handles missing Clerk keys gracefully
- Use `useAuthSafe` hook from `lib/hooks/use-auth-safe.ts` for client-side auth state that works with/without Clerk
- Holdings page is at `/holdings` using `app/(dashboard)/holdings/page.tsx`

- Toast notifications use Sonner - import `toast` from `sonner` and use `toast.success()` / `toast.error()`
- Toaster component is in root layout; for dark mode only, hardcode `theme="dark"` in Sonner component

- Dashboard navigation uses `components/dashboard/nav.tsx` with usePathname for active state
- Navigation items defined in array for easy extension
- ESLint no-case-declarations: wrap switch case blocks containing `const`/`let` declarations in braces `{ }`

---

# W-4 Transaction Tracking Progress Log

## 2026-02-01 - US-001
- What was implemented:
  - Updated transactionActionEnum to include DIVIDEND and SPLIT action types
  - Modified transactions table decimal precision from (20,8) to (18,8) per acceptance criteria
  - Added updatedAt timestamp field with default now()
  - Added deletedAt timestamp field for soft delete support
- Files changed:
  - lib/db/schema.ts - schema updates
  - drizzle/0001_silly_silver_surfer.sql - generated migration
  - drizzle/meta/_journal.json - migration metadata
  - drizzle/meta/0001_snapshot.json - schema snapshot
- **Learnings for future iterations:**
  - The transactions table already existed in schema.ts from a previous epic, only needed updates
  - Migration cannot be run without DATABASE_URL - this is expected for local dev without DB connection
  - npm dependencies may need to be installed if node_modules is missing (`npm install`)
---

## 2026-02-01 - US-002
- What was implemented:
  - Created GET /api/transactions endpoint with holding_id filter support
  - Created GET /api/transactions/[id] endpoint for single transaction retrieval
  - Both endpoints join with holdings table to include holding name/symbol
  - Auth enforced via Clerk - returns 401 if not authenticated
  - User ownership validated via holdings.userId join
  - Results sorted by date descending (newest first)
- Files changed:
  - app/api/transactions/route.ts - GET handler for listing transactions
  - app/api/transactions/[id]/route.ts - GET handler for single transaction
- **Learnings for future iterations:**
  - Use innerJoin with holdings table to both include holding info AND validate user ownership
  - Next.js 16 uses `params: Promise<{ id: string }>` pattern for dynamic route params
  - Follow existing holdings API patterns for consistency (error formats, auth checks)
---

## 2026-02-01 - US-003
- What was implemented:
  - Added POST handler to /api/transactions for creating new transactions
  - Full validation: required fields, date format (YYYY-MM-DD), numeric fields
  - Holding validation: checks existence, user ownership, tradeable type (stock/etf/crypto only)
  - Returns 201 with created transaction on success
  - Returns 400 with errors object on validation failure
- Files changed:
  - app/api/transactions/route.ts - added POST handler with validation
- **Learnings for future iterations:**
  - Follow holdings API pattern for POST endpoints: try/catch JSON parse, errors object for validation
  - NewTransaction type uses strings for decimal fields (quantity, unitPrice, fees)
  - Tradeable types are stock, etf, crypto - other types (super, cash, debt) use snapshots instead
---

## 2026-02-01 - US-004
- What was implemented:
  - Created `lib/calculations/quantity.ts` with `calculateQuantityHeld(holdingId)` function
  - Handles BUY (adds to quantity), SELL (subtracts), SPLIT (multiplies), DIVIDEND (no effect)
  - Processes transactions chronologically (ordered by date ascending)
  - Only includes non-deleted transactions (filters by deletedAt IS NULL)
- Files changed:
  - lib/calculations/quantity.ts - new file
- **Learnings for future iterations:**
  - `lib/calculations/` directory exists but was empty - meant for calculation helper functions
  - Decimal fields from Drizzle come as strings, need Number() conversion for arithmetic
  - SPLIT ratio stored in quantity field (e.g., 2:1 split = quantity of 2, multiplies holdings)
---

## 2026-02-01 - US-005
- What was implemented:
  - Added SELL quantity validation to POST handler in /api/transactions
  - Imports and uses calculateQuantityHeld helper to get current holdings
  - Validates sell quantity doesn't exceed current holdings for SELL action
  - Returns 400 with errors.quantity = "Sell quantity exceeds holdings" if exceeded
- Files changed:
  - app/api/transactions/route.ts - added SELL validation logic
- **Learnings for future iterations:**
  - Validation for SELL should run after holding validation passes (needs valid holding_id)
  - Also check !errors.quantity to avoid redundant validation if quantity already invalid
  - calculateQuantityHeld is reusable for both API validation and UI display
---

## 2026-02-01 - US-006
- What was implemented:
  - Added PATCH handler to /api/transactions/[id] for updating transactions
  - PATCH allows updating: date, quantity, unit_price, fees, notes
  - PATCH validates SELL quantity against holdings EXCLUDING current transaction
  - Added DELETE handler that performs soft delete (sets deleted_at timestamp)
  - Both endpoints verify transaction exists and belongs to user via holdings join
  - Both return 404 if transaction not found, 401 if not authenticated
- Files changed:
  - app/api/transactions/[id]/route.ts - added PATCH and DELETE handlers
- **Learnings for future iterations:**
  - For PATCH SELL validation, must exclude current transaction from quantity calculation to avoid double-counting
  - Use `ne(transactions.id, id)` from drizzle-orm to exclude a specific record
  - Soft delete should set both deletedAt AND updatedAt timestamps
  - Don't import calculateQuantityHeld if doing inline calculation - avoids lint errors for unused imports
---

## 2026-02-01 - US-007
- What was implemented:
  - Created `lib/calculations/cost-basis.ts` with `calculateCostBasis(holdingId)` function
  - Returns `{ costBasis: number, quantity: number, lots: Lot[] }`
  - FIFO methodology: BUY creates new lots, SELL consumes from oldest lots first
  - SPLIT adjusts all existing lots proportionally (quantity * ratio, price / ratio)
  - DIVIDEND does not affect cost basis
  - Only includes non-deleted transactions (filters by deletedAt IS NULL)
  - Exported `Lot` and `CostBasisResult` interfaces for type safety
- Files changed:
  - lib/calculations/cost-basis.ts - new file
- **Learnings for future iterations:**
  - ESLint no-case-declarations rule requires wrapping case blocks with lexical declarations (`const`, `let`) in braces `{ }`
  - SPLIT affects both lot.quantity AND lot.unitPrice to maintain total value invariant
  - Filter out lots with remainingQuantity <= 0 before returning to only show active lots
  - Cost basis pattern mirrors quantity calculation but tracks individual lots instead of running total
---

## 2026-02-01 - US-008
- What was implemented:
  - Added 'Transactions' link to dashboard navigation in `components/dashboard/nav.tsx`
  - Link navigates to `/transactions` route
  - Active state already handled by existing `isActive` logic comparing pathname to href
- Files changed:
  - components/dashboard/nav.tsx - added Transactions entry to navItems array
- **Learnings for future iterations:**
  - Navigation extension is simple: just add entry to navItems array with { href, label }
  - Active state styling is handled by existing isActive comparison
---

## 2026-02-01 - US-009
- What was implemented:
  - Created transactions list page at `app/(dashboard)/transactions/page.tsx`
  - Table with columns: Date, Holding, Action, Quantity, Unit Price, Fees, Total
  - Total calculation: BUY = (qty * price) + fees, SELL = (qty * price) - fees, SPLIT = 0
  - Color-coded action badges: green (BUY/DIVIDEND), red (SELL), blue (SPLIT)
  - Loading states: auth loading, data fetching, error state, empty state
  - Protected via `useAuthSafe` hook and `enabled: isLoaded && isSignedIn` on query
- Files changed:
  - app/(dashboard)/transactions/page.tsx - new page file
- **Learnings for future iterations:**
  - Follow holdings page pattern: useAuthSafe hook, multiple loading/error/empty states
  - SPLIT transactions display quantity as "X:1" ratio format (e.g., "2:1" for 2-for-1 split)
  - Use `font-mono` class for numeric columns to align digits properly
  - Format dates with toLocaleDateString("en-AU", { day: "numeric", month: "short", year: "numeric" })
  - Transaction API returns `holding` nested object with name, symbol, type, currency, exchange
---

## 2026-02-01 - US-010
- What was implemented:
  - Added holding filter dropdown to transactions page (fetches tradeable holdings: stock, etf, crypto)
  - Added action type filter with options: All, BUY, SELL, DIVIDEND, SPLIT
  - Filters persist in URL search params (?holding_id=&action=)
  - Updated GET /api/transactions to support `?action=` filter parameter
  - Empty state messaging changes based on whether filters are applied
- Files changed:
  - app/api/transactions/route.ts - added action filter support to GET endpoint
  - app/(dashboard)/transactions/page.tsx - added filter controls, URL param persistence
- **Learnings for future iterations:**
  - Use `useSearchParams` and `useRouter` from next/navigation for URL param filtering (same pattern as holdings page)
  - Radix Select requires a non-empty value; use "all" as placeholder value and convert to null for API
  - Fetch holdings with `?include_dormant=true` then filter client-side to get all tradeable types
  - Filter controls should be shown even during loading/error states so users can still adjust them
  - Query key should include filter values to refetch when filters change: `["transactions", { holdingId, action }]`
---

## 2026-02-01 - US-011
- What was implemented:
  - Created `components/transactions/add-transaction-dialog.tsx` with AddTransactionDialog component
  - Modal uses shadcn/ui Dialog with holding selector and action type selector
  - Holding selector fetches tradeable holdings (stock, etf, crypto) via existing API
  - Action type selector uses RadioGroup with 4 options: BUY, SELL, DIVIDEND, SPLIT
  - Cancel button and X close button both close modal and reset state
  - Added "Add Transaction" button to transactions page header (both empty state and table view)
- Files changed:
  - components/transactions/add-transaction-dialog.tsx - new file
  - app/(dashboard)/transactions/page.tsx - added AddTransactionDialog import and button
- **Learnings for future iterations:**
  - Follow add-holding-dialog.tsx pattern for modal structure and state management
  - Use `enabled: open` on useQuery to only fetch when dialog is open
  - RadioGroup with peer-data-[state=checked] creates nice selectable cards like holdings type selector
  - Modal should reset state in handleClose function (called by both cancel and onOpenChange)
  - Export types like TransactionAction for reuse in form components in later stories
---

## 2026-02-01 - US-012
- What was implemented:
  - Added step 2 to AddTransactionDialog for BUY/SELL transaction forms
  - Form fields: Date (date picker), Quantity, Unit Price, Fees (optional), Notes (optional)
  - Currency auto-filled from holding (read-only display)
  - Calculated total displayed: (quantity x unit_price) +/- fees
  - For SELL: shows current quantity held, validates against it, warns when selling all
  - Save calls POST /api/transactions with toast on success/error
  - Created /api/holdings/[id]/quantity endpoint to fetch current holdings for SELL validation
- Files changed:
  - components/transactions/add-transaction-dialog.tsx - added step 2 BUY/SELL form
  - app/api/holdings/[id]/quantity/route.ts - new file for quantity endpoint
- **Learnings for future iterations:**
  - Use `useMemo` for calculated values that depend on form state (e.g., total, isSellingAll, exceedsHoldings)
  - For client-side validation before server submission, check computed values like `exceedsHoldings`
  - Fetch quantity only when SELL is selected and step 2 is shown: `enabled: open && step === 2 && selectedAction === "SELL"`
  - Reset form data when going back to step 1 to prevent stale values
  - Use parseFloat for form values since input type="number" still returns strings
  - Placeholder for DIVIDEND/SPLIT forms makes it clear those are deferred to next story
---

## 2026-02-01 - US-013
- What was implemented:
  - Added DIVIDEND form to AddTransactionDialog with fields: Date, Shares Held, Dividend Per Share, Notes
  - DIVIDEND form shows calculated total dividend (quantity x unit_price) with green color styling
  - DIVIDEND form hides fees field (auto-set to 0 on submission)
  - Added SPLIT form with fields: Date, Split Ratio (X:1 format), Notes
  - SPLIT form includes explanation: "A 2:1 split doubles your shares and halves the price"
  - SPLIT form auto-sets unit_price and fees to 0 on submission
  - Updated handleSubmit validation to handle action-specific field requirements
  - Updated calculatedTotal to include DIVIDEND calculation
- Files changed:
  - components/transactions/add-transaction-dialog.tsx - added DIVIDEND and SPLIT step 2 forms
- **Learnings for future iterations:**
  - Different action types have different required/optional fields - use conditional validation in handleSubmit
  - For SPLIT ratio display, use "X : 1" format with separate input and text label
  - Use colored backgrounds (bg-blue-500/10, border-blue-500/20) for informational callouts
  - Dynamic help text based on form values (e.g., showing what a specific ratio means) improves UX
  - Boolean flags like `isDividend`, `isSplit` make conditional rendering cleaner than nested ternaries
---

## 2026-02-01 - US-014
- What was implemented:
  - Created `components/transactions/edit-transaction-dialog.tsx` with EditTransactionDialog component
  - Form pre-populated with existing transaction data via useEffect when dialog opens
  - Holding and action type displayed read-only (cannot be changed after creation)
  - For SELL edits: calculates "available to sell" as current holdings + original sell quantity
  - SELL validation shows warning when selling all, error when exceeding available
  - Created `components/transactions/delete-transaction-dialog.tsx` with DeleteTransactionDialog component
  - Delete dialog uses AlertDialog (from shadcn/ui) for confirmation
  - Shows transaction details: holding, date, action, quantity, total
  - Includes yellow warning: "Deleting this transaction will affect cost basis calculations"
  - Added Edit/Delete icon buttons to each transaction row in table (SVG icons, ghost buttons)
  - Both dialogs use useMutation with onSuccess invalidation and toast notifications
- Files changed:
  - components/transactions/edit-transaction-dialog.tsx - new file
  - components/transactions/delete-transaction-dialog.tsx - new file
  - app/(dashboard)/transactions/page.tsx - added state, imports, icon buttons, and dialog rendering
- **Learnings for future iterations:**
  - For SELL edit validation: "available quantity" = current holdings + original transaction quantity (to allow reducing but not exceeding)
  - Use useEffect with dependency on `open` and `transaction` to reset form state when dialog opens
  - AlertDialog from shadcn/ui is better for destructive confirmations than Dialog
  - SVG icons inline work well for small action buttons without needing a icon library
  - Conditional dialog rendering pattern: `{editTransaction && <EditTransactionDialog ... />}` ensures dialog only mounts when needed
---

