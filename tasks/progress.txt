## Codebase Patterns
- Project uses Next.js 14+ App Router with TypeScript
- Drizzle ORM is already installed (drizzle-orm, drizzle-kit, @neondatabase/serverless)
- shadcn/ui components available in components/ui
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Tailwind CSS with shadcn/ui CSS variable pattern using HSL format: hsl(var(--variable))
- CSS variables stored without hsl() wrapper e.g. --background: 240 10% 3.9%
- Glow shadows use rgba() since HSL variables can't express box-shadow alpha
- Inter font loaded via next/font/google in app/layout.tsx (applied via inter.className on body)
- Framer Motion components require "use client" directive
- Toast notifications use Sonner - import toast from sonner
- Dashboard navigation uses components/layout/sidebar.tsx and components/layout/mobile-nav.tsx
- Tailwind has semantic tokens: text-positive/bg-positive (green), text-negative/bg-negative (red), shadow-glow-sm/md/lg, shadow-glow-positive, shadow-glow-negative, shadow-card, shadow-card-hover
- Layout & spacing constants live in lib/theme.ts (sidebarWidth, cardRadius, spacing xs→2xl) — use instead of magic numbers
- Animation presets live in lib/animations.ts — import and spread onto motion.div elements (e.g. `<motion.div {...fadeIn}>`)
- Stagger presets (staggerContainer, staggerItem) use Variants type with "hidden"/"visible" keys — use with variants prop
- numberSpring is a Transition object for animating numeric values (e.g. useSpring, useMotionValue)
- Reduced motion: use `useAnimationConfig(preset?)` from hooks/use-animation-config.ts — returns props that disable animations when OS prefers-reduced-motion is on
- Hooks live in hooks/ directory (not lib/) — follow this convention for custom React hooks
- Recharts SVG props (stroke, fill) require raw hex values — CSS variables not supported in SVG rendering
- Category indicator colours (asset types, currencies) use hardcoded Tailwind colours (bg-blue-500 etc.) — these are intentional and distinct from theme tokens
- Card container pattern: `border-border bg-card/50` for bordered cards, `bg-muted` for skeleton placeholders
- Error state pattern: `border-destructive bg-destructive/10` with `text-destructive` for error messages
- Toggle pattern: active=`bg-muted text-foreground`, inactive=`text-muted-foreground hover:text-foreground`
- Form validation pattern: `border-destructive focus-visible:ring-destructive` on inputs, `text-destructive` on error messages
- Delete confirm button: `bg-destructive hover:bg-destructive/90 text-foreground`; cancel: `bg-card border-border text-foreground hover:bg-muted`
- Select dropdowns: `bg-background border-border text-muted-foreground` for trigger, `focus:bg-card focus:text-foreground` for items
- Warning/info colours (yellow-*, blue-*) are semantic and intentionally NOT part of design token migration
- Interactive toggle buttons (show/hide contributions): use `text-primary hover:text-primary/80` pattern
- html2canvas backgroundColor requires raw hex — use `#18181b` to match --card token
- Email templates (components/emails/) use inline hex values — email clients don't support CSS variables
- Only legitimate remaining hardcoded grey: `bg-gray-500` fallback in category indicator functions (asset-allocation, currency-exposure)
- Navigation items defined in lib/navigation.ts — import navItems and NavItem type from there (sidebar, mobile nav, command menu)
- New layout components live in components/layout/ — NavItemLink (nav-item.tsx) uses Framer Motion layoutId='active-nav' for animated active pill
- TooltipProvider with delayDuration={0} wraps collapsed nav items for instant tooltip display
- Sidebar collapse state persists in localStorage ('mjolnir-sidebar-collapsed') — use mounted state pattern to avoid hydration mismatch
- Sidebar is fixed positioned; content area needs dynamic left margin matching sidebar width (240px or 64px)
- AppShell (components/layout/app-shell.tsx) owns sidebar collapsed state — Sidebar receives isCollapsed/onToggleCollapsed as props
- Content area uses CSS custom property --sidebar-width with responsive Tailwind class ml-0 lg:ml-[var(--sidebar-width)] for responsive dynamic margin
- For responsive dynamic values, use CSS custom properties + Tailwind arbitrary value classes (inline styles can't be responsive)
- PageWrapper (components/layout/page-wrapper.tsx) wraps page content with fade transition — placed inside DashboardErrorBoundary in dashboard layout
- Mobile header (components/layout/mobile-nav.tsx) is fixed h-14 z-30 — content area needs pt-14 on mobile
- Sheet drawer (shadcn/ui) handles focus trapping and Escape close via Radix Dialog primitive
- Focus ring pattern: `focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring` matches shadcn/ui conventions
- HoldingsTable hybrid grouping: `typeFilter="all"` shows collapsible grouped sections, specific type shows flat list via `HoldingsFlatSection`
- Shared table rendering: `HoldingsTableContent` component handles row rendering for both grouped and flat views
- GroupHeader (components/holdings/group-header.tsx) shows label, count, total value, portfolio % badge — receives calculated values as props
- `calculateGroupTotal()` in holdings-table.tsx converts holdings to display currency — use for any group-level value aggregation

---

# UX-3 Holdings UI Enhancement Progress Log

Started: 2026-02-06

---

## 2026-02-06 - US-001: Create animated type filter tabs
- Created `components/holdings/filter-tabs.tsx` with All, Crypto, Stocks, ETFs, Super, Cash, Debt tabs
- Active tab uses Framer Motion `layoutId="active-holding-filter"` for smooth sliding bg-accent/20 pill
- Tab state stored in URL `?type=` search param via `router.replace()`
- Updated holdings page to filter by type + currency (combined filtering)
- Removed `GroupBySelector` import and usage from holdings page
- Added `scrollbar-hide` utility class to globals.css for hidden-scrollbar mobile tabs
- Currency filter + dormant toggle + native currency toggle positioned to the right with `ml-auto`
- `HoldingsTable` now always receives `groupBy="type"` (currency grouping removed from page)
- Files changed: `components/holdings/filter-tabs.tsx` (new), `app/(dashboard)/holdings/page.tsx`, `app/globals.css`
- **Learnings for future iterations:**
  - Zsh shell requires quoting paths with parentheses: `"app/(dashboard)/..."` for git commands
  - The `scrollbar-hide` class is not built into Tailwind — must be added as a custom utility
  - `router.replace()` is preferred over `router.push()` for filter changes to avoid polluting browser history
---

## 2026-02-06 - US-002: Implement hybrid grouping — groups on All, flat list on specific type
- Refactored `HoldingsTable` to support two display modes: grouped (collapsible) and flat
- Extracted table row rendering into shared `HoldingsTableContent` component to avoid duplication
- Created `HoldingsFlatSection` for flat list view (no group header) when specific type filter is active
- Added Framer Motion `AnimatePresence` + `motion.div` for collapse/expand animation (height: 0 → auto, 200ms ease-out)
- Added `ChevronRight` icon that rotates 90° → 0° via `motion.span` on collapse
- Group sections expanded by default (`useState(true)`)
- Empty groups already hidden by existing null return logic
- `HoldingsTable` accepts new `typeFilter` prop; page passes it through
- Files changed: `components/holdings/holdings-table.tsx`, `app/(dashboard)/holdings/page.tsx`
- **Learnings for future iterations:**
  - Framer Motion `AnimatePresence` with `initial={false}` prevents animation on first render — useful for sections that start expanded
  - Use `style={{ overflow: "hidden" }}` on motion container to prevent content from showing during height animation
  - Extracting shared table content into a sub-component keeps grouped vs flat views DRY
  - The `collapsible` prop pattern allows reuse of existing section components with optional collapse behavior
---

## 2026-02-06 - US-003: Add group summary stats
- Created `components/holdings/group-header.tsx` with group name, count, total value (in display currency), and portfolio percentage badge
- Added `calculateGroupTotal()` helper to `holdings-table.tsx` — converts each holding's value from native currency to display currency
- `HoldingsTable` now computes `portfolioTotal` via `useMemo` across all type groups (absolute sum for percentage denominator)
- Each `HoldingsTypeSection` computes its group total and derives `portfolioPercent` from the portfolio total
- Debt groups show total with `text-destructive` colour via `isDebt` prop
- Stats are right-aligned in the group header button via `justify-between`
- Uses design tokens throughout: `text-muted-foreground`, `bg-muted`, `text-destructive`, `text-foreground`
- `CurrencyDisplay` component handles loading states and currency formatting
- Files changed: `components/holdings/group-header.tsx` (new), `components/holdings/holdings-table.tsx`
- **Learnings for future iterations:**
  - Portfolio percentage uses absolute values for both numerator and denominator to handle debt groups correctly
  - The `calculateGroupTotal` function converts each holding individually to display currency before summing (handles mixed-currency groups)
  - `useMemo` with `convert` in dependency array recalculates when display currency changes
  - `GroupHeader` is a separate component to keep `HoldingsTypeSection` focused on table rendering
---

