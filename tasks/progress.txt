## Codebase Patterns
- Project uses Next.js 16+ App Router with TypeScript
- Drizzle ORM is already installed (`drizzle-orm`, `drizzle-kit`, `@neondatabase/serverless`)
- shadcn/ui components available in `components/ui`
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Next.js 16 doesn't have `next lint` command - use `eslint .` directly

- Database module uses lazy initialization via Proxy to avoid build-time errors when DATABASE_URL is not set
- Use `sql` template tag from drizzle-orm for raw SQL queries with `db.execute(sql\`...\`)`
- ClerkProvider conditionally renders based on NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY to allow builds without Clerk keys
- Use `export const dynamic = "force-dynamic"` for pages/layouts that use Clerk components
- Dashboard routes at `/dashboard` and `/profile` are protected; landing page `/` is public
- Auth pages use `(auth)` route group; dashboard uses `(dashboard)` route group

- Drizzle migrations are stored in `drizzle/` directory and should be committed to git
- The holdings schema already exists in `lib/db/schema.ts` with all required fields

- TanStack Query provider is in `components/providers/query-provider.tsx` - wrap layouts with QueryProvider
- ClerkProvider wrapper is in `components/providers/clerk-provider.tsx` - handles missing Clerk keys gracefully
- Use `useAuthSafe` hook from `lib/hooks/use-auth-safe.ts` for client-side auth state that works with/without Clerk
- Holdings page is at `/holdings` using `app/(dashboard)/holdings/page.tsx`

- Toast notifications use Sonner - import `toast` from `sonner` and use `toast.success()` / `toast.error()`
- Toaster component is in root layout; for dark mode only, hardcode `theme="dark"` in Sonner component

---

# W-3 Holdings Management Progress Log

## 2026-01-31 - US-001
- What was implemented: Holdings database schema verification and migration generation
- Files changed:
  - lib/db/schema.ts - Added NZX to exchangeEnum
  - drizzle/0000_overconfident_xavin.sql - Initial migration generated
  - drizzle/meta/*.json - Migration metadata
  - eslint.config.mjs - Created ESLint 9 flat config
  - package.json - Fixed lint script to use `eslint .`
  - .gitignore - Removed drizzle/ ignore to track migrations
- **Learnings for future iterations:**
  - The holdings schema was already complete from W-1 scaffolding
  - ESLint 9 requires flat config format (eslint.config.mjs), not .eslintrc.json
  - Next.js 16 doesn't include `next lint` - use `eslint .` directly
  - Drizzle migrations must be committed (removed from .gitignore)
---

## 2026-01-31 - US-002
- What was implemented: Holdings API GET endpoints
- Files changed:
  - app/api/holdings/route.ts - Created with GET handler for listing holdings
  - app/api/holdings/[id]/route.ts - Created with GET handler for single holding
  - lib/db/index.ts - Created database connection module with Proxy-based lazy initialization
  - package.json, package-lock.json - Added @clerk/nextjs package
- **Learnings for future iterations:**
  - Use `auth()` from `@clerk/nextjs/server` for API route authentication
  - Drizzle queries use `and()` to combine multiple conditions
  - In Next.js 16, dynamic route params are passed as Promise and need to be awaited
  - Database connection module uses Proxy pattern for lazy initialization to prevent build-time errors
---

## 2026-01-31 - US-003
- What was implemented: Holdings API POST endpoint for creating new holdings
- Files changed:
  - app/api/holdings/route.ts - Added POST handler with validation
- **Learnings for future iterations:**
  - Validation returns 400 with `{ errors: { field: "message" } }` format for field-level errors
  - Tradeable types (stock, etf, crypto) require a symbol
  - Exchange is only required for stock and etf types (not crypto)
  - Use `NewHolding` type from schema for insert values to get TypeScript safety
  - Use `.returning()` on Drizzle insert to get the created record back
---

## 2026-01-31 - US-004
- What was implemented: Holdings API PATCH and DELETE endpoints
- Files changed:
  - app/api/holdings/[id]/route.ts - Added PATCH and DELETE handlers
- **Learnings for future iterations:**
  - PATCH should update `updatedAt` timestamp along with any modified fields
  - Soft delete sets `deletedAt` timestamp, doesn't actually remove the record
  - Both PATCH and DELETE should verify the holding exists AND belongs to the user before modifying
  - Use `.returning()` on Drizzle update to get the modified record back
  - Avoid defining unused variables - ESLint will catch them
---

## 2026-01-31 - US-005
- What was implemented: Holdings list page structure with TanStack Query
- Files changed:
  - app/(dashboard)/holdings/page.tsx - Created holdings list page with loading, auth, error, and empty states
  - app/layout.tsx - Added ClerkProvider and QueryProvider wrappers
  - components/providers/clerk-provider.tsx - Created conditional ClerkProvider wrapper
  - components/providers/query-provider.tsx - Created TanStack Query provider
  - lib/hooks/use-auth-safe.ts - Created safe auth hook wrapper
  - package.json, package-lock.json - Added @tanstack/react-query
- **Learnings for future iterations:**
  - TanStack Query needs a QueryClientProvider wrapper in the root layout
  - ClerkProvider must wrap the app for useAuth hook to work
  - Use conditional ClerkProvider to allow builds/runs without Clerk keys configured
  - Create useAuthSafe wrapper when you need to handle both configured and unconfigured Clerk states
  - Client-side pages with hooks should use `"use client"` directive
  - TanStack Query's `enabled` option prevents fetching when auth isn't ready
---

## 2026-01-31 - US-006
- What was implemented: Holdings grouped table display
- Files changed:
  - components/holdings/holdings-table.tsx - Created HoldingsTable component with type grouping
  - components/ui/table.tsx - Added shadcn/ui Table component
  - app/(dashboard)/holdings/page.tsx - Updated to use HoldingsTable component
- **Learnings for future iterations:**
  - Use `npx shadcn@latest add <component> -y` to install shadcn/ui components
  - Group components in feature folders (e.g., `components/holdings/`) for organization
  - Define HOLDING_TYPE_ORDER array to control display order of type groups
  - Symbol column only shown for tradeable types (stock, etf, crypto)
  - Browser testing with Playwright requires authenticated session; page redirects to Clerk login for protected routes
---

## 2026-01-31 - US-007
- What was implemented: Add holding modal - base structure
- Files changed:
  - components/holdings/add-holding-dialog.tsx - Created AddHoldingDialog component
  - components/ui/dialog.tsx - Added shadcn/ui Dialog component
  - components/ui/radio-group.tsx - Added shadcn/ui RadioGroup component
  - components/ui/label.tsx - Added shadcn/ui Label component
  - app/(dashboard)/holdings/page.tsx - Added AddHoldingDialog with "Add Holding" button
  - package.json, package-lock.json - Added radix-ui dependencies for dialog/radio-group/label
- **Learnings for future iterations:**
  - shadcn/ui Dialog uses radix-ui primitives and includes accessibility features (focus trap, escape to close)
  - Use `npx shadcn@latest add dialog radio-group label -y` to install multiple components
  - RadioGroup items can be styled as cards using peer selectors: `peer-data-[state=checked]:border-primary`
  - Keep dialog state (selectedType) and reset it when modal closes via `onOpenChange`
  - Export HoldingType from the dialog component for use in future stories
---

## 2026-01-31 - US-008
- What was implemented: Add holding form - tradeable assets
- Files changed:
  - components/holdings/add-holding-dialog.tsx - Extended with step 2 form for tradeable assets
  - components/ui/input.tsx - Added shadcn/ui Input component
  - components/ui/select.tsx - Added shadcn/ui Select component
  - components/ui/sonner.tsx - Added shadcn/ui Sonner (toast) component, simplified for dark-mode only
  - app/layout.tsx - Added Toaster to root layout
  - package.json, package-lock.json - Added sonner, next-themes, @radix-ui/react-select
- **Learnings for future iterations:**
  - Use `useMutation` from TanStack Query for API calls with `onSuccess` and `onError` handlers
  - Toast notifications via Sonner: `toast.success()` and `toast.error()`
  - For dark-mode only apps, simplify Sonner component by hardcoding `theme="dark"` instead of using next-themes
  - Symbol validation for ASX/NZX can be done client-side before submitting
  - Clear validation errors on field change for better UX
  - Multi-step dialogs need separate state (`step`) and reset logic in `handleClose`
---

## 2026-01-31 - US-009
- What was implemented: Add holding form - snapshot assets (super/cash/debt)
- Files changed:
  - components/holdings/add-holding-dialog.tsx - Extended form with snapshot asset support and isDormant checkbox
  - components/ui/checkbox.tsx - Added shadcn/ui Checkbox component
  - package.json, package-lock.json - Added @radix-ui/react-checkbox
- **Learnings for future iterations:**
  - Snapshot types (super, cash, debt) don't need symbol or exchange fields
  - Use `isSuper` / `isTradeable` / `requiresExchange` boolean flags to conditionally render form fields
  - The Checkbox component uses `onCheckedChange` callback where `checked` can be boolean or "indeterminate"
  - Context-specific placeholder text improves UX (e.g., "AustralianSuper" for super, "Home Loan" for debt)
  - API already supports isDormant field on POST - just needed to pass it from frontend
---

## 2026-01-31 - US-010
- What was implemented: Edit holding modal with pre-populated form data
- Files changed:
  - components/holdings/edit-holding-dialog.tsx - Created EditHoldingDialog component
  - components/holdings/holdings-table.tsx - Added edit button with Pencil icon to each row
- **Learnings for future iterations:**
  - Edit dialogs should be controlled (open/onOpenChange props) rather than uncontrolled
  - Use useEffect to populate form data when dialog opens or holding changes
  - Read-only type field styled with `bg-muted text-muted-foreground` classes
  - Only send changed fields to PATCH API - compare form data with original holding
  - State for edited item should be lifted to parent component (HoldingsTable manages editingHolding)
  - Use lucide-react icons (Pencil) for action buttons in tables
  - Add sr-only span for accessibility on icon-only buttons
- Use `useSearchParams` and `useRouter` from `next/navigation` for URL-based state persistence
- TanStack Query key should include filter params to trigger refetch when filters change: `queryKey: ["holdings", { showDormant }]`

---

## 2026-01-31 - US-011
- What was implemented: Delete holding with confirmation dialog
- Files changed:
  - components/holdings/holdings-table.tsx - Added delete button (Trash2 icon) and AlertDialog for confirmation
  - components/ui/alert-dialog.tsx - Added shadcn/ui AlertDialog component
  - package.json, package-lock.json - Added @radix-ui/react-alert-dialog
- **Learnings for future iterations:**
  - AlertDialog is similar to Dialog but designed for destructive actions with Cancel/Action buttons
  - Use red styling for destructive actions: `className="bg-red-600 hover:bg-red-700"`
  - Delete mutations should invalidate queries on success to trigger refetch
  - Keep delete confirmation state (deletingHolding) separate from edit state (editingHolding)
  - Use `&quot;` for quotes in JSX text content to avoid lint warnings
---

## 2026-01-31 - US-012
- What was implemented: Dormant holdings filter with URL-persisted toggle
- Files changed:
  - app/(dashboard)/holdings/page.tsx - Added Switch toggle, URL state persistence, updated API call
  - components/holdings/holdings-table.tsx - Added opacity-60 styling for dormant holdings
  - components/ui/switch.tsx - Added shadcn/ui Switch component
  - package.json, package-lock.json - Added @radix-ui/react-switch
- **Learnings for future iterations:**
  - Use Switch component with Label for better toggle UX than checkbox
  - URL state via `useSearchParams` and `useRouter` enables shareable links with filter state
  - TanStack Query key should include filter state to trigger refetch on filter change
  - Apply `opacity-60` class for muted styling on dormant items
  - API already supports `include_dormant=true` query param - just needed to wire it up
---

## 2026-01-31 - US-013
- What was implemented: Mark holding as dormant toggle in edit modal
- Files changed:
  - components/holdings/edit-holding-dialog.tsx - Added isDormant to FormData, added Checkbox import, added checkbox UI, updated PATCH mutation to include isDormant
- **Learnings for future iterations:**
  - Use TanStack Query mutation's `variables` parameter in `onSuccess` to check what was changed
  - The Checkbox component's `onCheckedChange` callback receives `checked` which can be boolean or "indeterminate" - use `checked === true`
  - EditHoldingDialog already imports Checkbox - just needed to add it to the form
  - Dormant status should show specific toast messages rather than generic "updated" message
---

## 2026-02-01 - US-014
- What was implemented: Holdings navigation from dashboard
- Files changed:
  - components/dashboard/nav.tsx - Created DashboardNav client component with navigation links
  - app/(dashboard)/layout.tsx - Added DashboardNav to header alongside title
- **Learnings for future iterations:**
  - Navigation components should be client-side ("use client") to use usePathname for active state
  - Group navigation items in an array for easy extension (navItems array pattern)
  - Use cn() utility for conditional class merging with active states
  - Dashboard routes share a layout in app/(dashboard)/ - navigation added here is consistent across all dashboard pages
---

