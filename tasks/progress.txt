## Codebase Patterns
- Project uses Next.js 16+ App Router with TypeScript
- Drizzle ORM is already installed (`drizzle-orm`, `drizzle-kit`, `@neondatabase/serverless`)
- shadcn/ui components available in `components/ui`
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Next.js 16 doesn't have `next lint` command - use `eslint .` directly

- Database module uses lazy initialization via Proxy to avoid build-time errors when DATABASE_URL is not set
- Use `sql` template tag from drizzle-orm for raw SQL queries with `db.execute(sql\`...\`)`
- ClerkProvider conditionally renders based on NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY to allow builds without Clerk keys
- Use `export const dynamic = "force-dynamic"` for pages/layouts that use Clerk components
- Dashboard routes at `/dashboard` and `/profile` are protected; landing page `/` is public
- Auth pages use `(auth)` route group; dashboard uses `(dashboard)` route group

- Drizzle migrations are stored in `drizzle/` directory and should be committed to git
- The holdings schema exists in `lib/db/schema.ts` with all required fields
- Transactions schema exists with action enum: BUY, SELL, DIVIDEND, SPLIT

- TanStack Query provider is in `components/providers/query-provider.tsx` - wrap layouts with QueryProvider
- ClerkProvider wrapper is in `components/providers/clerk-provider.tsx` - handles missing Clerk keys gracefully
- Use `useAuthSafe` hook from `lib/hooks/use-auth-safe.ts` for client-side auth state that works with/without Clerk
- Holdings page is at `/holdings` using `app/(dashboard)/holdings/page.tsx`
- Transactions page is at `/transactions` using `app/(dashboard)/transactions/page.tsx`

- Toast notifications use Sonner - import `toast` from `sonner` and use `toast.success()` / `toast.error()`
- Toaster component is in root layout; for dark mode only, hardcode `theme="dark"` in Sonner component

- Dashboard navigation uses `components/dashboard/nav.tsx` with usePathname for active state
- Navigation items defined in array for easy extension
- ESLint no-case-declarations: wrap switch case blocks containing `const`/`let` declarations in braces `{ }`

- API patterns:
  - Use innerJoin with holdings to validate user ownership AND include holding info
  - Return 409 Conflict for duplicate prevention (unique constraint violations)
  - Return 400 with `{ errors: { field: "message" } }` for validation errors
  - Decimal fields from Drizzle come as strings, need Number() conversion for arithmetic

- Calculation helpers in `lib/calculations/`:
  - `quantity.ts` - calculateQuantityHeld for tradeable holdings
  - `cost-basis.ts` - calculateCostBasis with FIFO methodology

- Snapshots and contributions schema: uses `employer_contrib`/`employee_contrib` (not `employer_contribution`) for DB column names to avoid migration renames

- Query helpers in `lib/queries/`:
  - `snapshots.ts` - getLatestSnapshots() and getLatestSnapshotForHolding() for fetching most recent snapshots

- Calculation helpers in `lib/calculations/`:
  - `super-returns.ts` - calculateInvestmentReturns() and calculateMonthlyInvestmentReturns() for super fund performance

- Check-in status API at `/api/check-in/status` returns holdings needing current month snapshots
- Dashboard components in `components/check-in/` for monthly check-in workflow
- Quote paths with parentheses in bash git commands: `git add "app/(dashboard)/..."`

- Edit modals pattern: components/[domain]/edit-[entity]-modal.tsx structure
- For related entity editing (e.g., contributions for super snapshots), fetch existing data with useQuery and handle create/update based on existence

- Neon MCP tools can be used to run migrations when DATABASE_URL is not configured locally
- Migration snapshot chain: each snapshot's prevId must point to the previous migration's id to avoid collision errors

---

# W-6 Live Prices & Caching Progress Log

Started: 2026-02-01

---

## 2026-02-01 - US-001
- What was implemented: Price cache database schema with all required fields
- Files changed:
  - `lib/db/schema.ts` - Added priceCacheSourceEnum and updated priceCache table with change_percent, change_absolute, source, and unique constraint on symbol
  - `drizzle/0003_slim_cyclops.sql` - Migration file for new fields
  - `drizzle/meta/0002_snapshot.json` - Fixed prevId to point to 0001 (was causing collision)
  - `drizzle/meta/0003_snapshot.json` - New snapshot for migration 0003
  - `drizzle/meta/_journal.json` - Updated with new migration entry
- **Learnings for future iterations:**
  - Database was empty - had to apply all migrations (0000, 0001, 0002, 0003) via Neon MCP tools
  - Migration 0002 and 0001 both had same prevId pointing to 0000 - this was a collision error. Fixed by updating 0002's prevId to point to 0001's id
  - Use `mcp__neon__run_sql_transaction` to apply multiple SQL statements in sequence
---

## 2026-02-01 - US-002
- What was implemented: Exchange rate cache database schema for currency conversion
- Files changed:
  - `lib/db/schema.ts` - Added exchangeRates table with id, from_currency, to_currency, rate, fetched_at fields and unique constraint on currency pair
  - `drizzle/0004_lazy_radioactive_man.sql` - Migration file for new table
  - `drizzle/meta/0004_snapshot.json` - Snapshot for migration 0004
  - `drizzle/meta/_journal.json` - Updated with new migration entry
- **Learnings for future iterations:**
  - Drizzle migrations tracking table doesn't exist in this project's Neon database - migrations are applied directly via MCP tools
  - Use `mcp__neon__describe_table_schema` to verify table creation with columns and constraints
---

## 2026-02-01 - US-003
- What was implemented: Yahoo Finance price service for fetching stock/ETF prices
- Files changed:
  - `lib/services/yahoo-finance.ts` - Created new service with fetchStockPrice function, PriceData interface, YahooFinanceError class, and normalizeSymbol helper
  - `package.json` - Added yahoo-finance2 dependency
  - `package-lock.json` - Updated with yahoo-finance2 and transitive dependencies
- **Learnings for future iterations:**
  - yahoo-finance2 `quote()` function returns `regularMarketPrice`, `currency`, `regularMarketChange`, and `regularMarketChangePercent`
  - ASX symbols need .AX suffix, NZX symbols need .NZ suffix - US markets need no suffix
  - The `lib/services/` directory was empty before this - first service created here
---

## 2026-02-01 - US-004
- What was implemented: CoinGecko price service for fetching cryptocurrency prices
- Files changed:
  - `lib/services/coingecko.ts` - Created new service with fetchCryptoPrice function, CoinGeckoError class, getCoinGeckoId helper, and symbol mapping for top 50 cryptocurrencies
- **Learnings for future iterations:**
  - CoinGecko uses slug-style IDs like "bitcoin", "ethereum", not ticker symbols - need mapping
  - Pro API uses different base URL (`pro-api.coingecko.com`) and requires `x-cg-pro-api-key` header
  - Free tier returns 429 status on rate limit - handle gracefully with descriptive error
  - Use `Record<string, string>` instead of `HeadersInit` type to avoid ESLint no-undef errors with DOM types
  - CoinGecko `/simple/price` endpoint returns price in USD and 24h change percent - calculate absolute change from those
---

## 2026-02-01 - US-005
- What was implemented: Exchange rate service for fetching currency conversion rates
- Files changed:
  - `lib/services/exchange-rates.ts` - Created new service with fetchExchangeRate function, ExchangeRateError class, support for USD/AUD, NZD/AUD, USD/NZD pairs and their inverses
- **Learnings for future iterations:**
  - exchangerate-api.com has free tier at `open.er-api.com` (1500 requests/month) and authenticated tier at `v6.exchangerate-api.com`
  - API returns `conversion_rates` object with currency codes as keys (e.g., `{ "AUD": 1.53, "NZD": 1.68 }`)
  - Same currency conversion (AUD to AUD) can short-circuit to return 1 without API call
  - Follow same error handling pattern as CoinGecko service for consistency
---

## 2026-02-01 - US-006
- What was implemented: Price cache service for managing cached prices with TTL
- Files changed:
  - `lib/services/price-cache.ts` - Created new service with getCachedPrice, setCachedPrice, isCacheValid, getAllCachedPrices, deleteCachedPrice functions
- **Learnings for future iterations:**
  - Drizzle decimal fields come as strings from the database - use Number() conversion in toCachedPrice helper
  - Upsert pattern: check if row exists first, then update or insert (Drizzle doesn't have native upsert)
  - Export DEFAULT_PRICE_CACHE_TTL_MINUTES constant (15 minutes) for reuse by other services
  - Include helper types CachedPrice (output) and PriceDataToCache (input) for type safety
---

## 2026-02-01 - US-007
- What was implemented: Exchange rate cache service with 1-hour TTL
- Files changed:
  - `lib/services/exchange-rates.ts` - Added getCachedRate, getExchangeRate (with caching), isExchangeRateCacheValid, getAllCachedRates, and internal setCachedRate functions
- **Learnings for future iterations:**
  - Follow the same caching pattern as price-cache.ts for consistency
  - getExchangeRate is the main public function that consumers should use - handles cache check + fetch + update automatically
  - setCachedRate is internal (not exported) because only getExchangeRate should update the cache
  - Exchange rate cache TTL is 60 minutes (1 hour), exported as DEFAULT_EXCHANGE_RATE_TTL_MINUTES
  - Use `and()` from drizzle-orm to combine multiple eq() conditions for composite key lookups
---

## 2026-02-01 - US-008
- What was implemented: Unified price fetcher service for routing to appropriate providers
- Files changed:
  - `lib/services/price-fetcher.ts` - Created new service with fetchPrice, fetchPricesForHoldings, isTradeableHolding, and helper functions
- **Learnings for future iterations:**
  - The unified fetcher routes based on holding type: crypto → CoinGecko, stock/etf → Yahoo Finance
  - Returns PriceResult with isStale flag for graceful fallback when fetch fails
  - For cache lookup, normalize symbol: crypto uses uppercase, stocks use normalizeSymbol() with exchange
  - HoldingForPriceFetch interface defines minimal fields needed (type, symbol, exchange, currency)
  - fetchPricesForHoldings() handles batch fetching in parallel with Promise.all
---

## 2026-02-01 - US-009
- What was implemented: Prices API refresh endpoint for fetching fresh prices
- Files changed:
  - `app/api/prices/route.ts` - Created new API route with POST handler for price refresh
- **Learnings for future iterations:**
  - POST /api/prices/refresh accepts optional `holding_ids` array in request body
  - Filters to tradeable holdings (stock, etf, crypto) with symbols
  - Uses `forceRefresh: true` option on fetchPrice to bypass cache
  - Returns array with price results including holdingId, symbol, price, currency, changePercent, isStale, error
  - Partial failures handled - each holding returns its own result/error independently
---

## 2026-02-01 - US-010
- What was implemented: Prices API GET endpoint for fetching cached prices
- Files changed:
  - `app/api/prices/route.ts` - Added GET handler for cached prices
- **Learnings for future iterations:**
  - GET /api/prices returns cached prices for all tradeable holdings belonging to the authenticated user
  - Uses normalizeSymbol from yahoo-finance service for consistent cache key lookups
  - Crypto symbols use uppercase for cache lookup, stock/etf use normalizeSymbol with exchange
  - Response includes fetchedAt timestamp and isStale boolean based on 15-minute TTL
  - Returns null values for price/currency/etc if no cached price exists for a holding
---

## 2026-02-01 - US-011
- What was implemented: Exchange rates API endpoint for getting cached exchange rates
- Files changed:
  - `app/api/exchange-rates/route.ts` - Created new API route with GET handler
- **Learnings for future iterations:**
  - GET /api/exchange-rates returns all cached exchange rates in format { rates: { 'USD/AUD': 1.53 }, fetchedAt, isStale }
  - Supports `?refresh=true` query parameter to force refresh USD/AUD and NZD/AUD pairs
  - Uses getExchangeRate from exchange-rates service which handles cache check + fetch + update
  - Returns isStale: true if any cached rate is older than 1 hour (DEFAULT_EXCHANGE_RATE_TTL_MINUTES)
  - fetchedAt returns the oldest timestamp among all cached rates
---

## 2026-02-01 - US-012
- What was implemented: Price display column for tradeable holdings in the holdings list
- Files changed:
  - `app/(dashboard)/holdings/page.tsx` - Added fetchPrices function, useQuery for prices, and pass prices to HoldingsTable
  - `components/holdings/holdings-table.tsx` - Added PriceData interface, PriceCell component, Price column, and helper functions for formatting
- **Learnings for future iterations:**
  - PriceData interface exported from holdings-table.tsx for use by holdings page
  - Price column added after Quantity column for tradeable holdings
  - PriceCell component handles loading, no-data, and error states independently
  - formatTimeAgo helper converts Date to relative time ("5 min ago", "2 hours ago")
  - TrendingUp/TrendingDown icons from lucide-react for change direction
  - Clock icon for fresh prices, AlertTriangle for stale/error prices
  - Browser verification shows 401 when not authenticated - expected behavior
---

## 2026-02-01 - US-013
- What was implemented: Market Value column for tradeable holdings in the holdings list
- Files changed:
  - `components/holdings/holdings-table.tsx` - Added calculateMarketValue and formatMarketValue helpers, MarketValueCell component, Market Value table header and cell
- **Learnings for future iterations:**
  - MarketValueCell follows same pattern as PriceCell for loading/error states
  - Market Value column added after Price column for tradeable holdings
  - calculateMarketValue handles null quantity and null price gracefully by returning null
  - formatMarketValue uses CURRENCY_SYMBOLS mapping for consistent currency display
  - MarketValueCell receives both quantity and price data via props to calculate value on render
---

## 2026-02-01 - US-014
- What was implemented: Unrealized gain/loss column for tradeable holdings in the holdings list
- Files changed:
  - `components/holdings/holdings-table.tsx` - Added calculateGainLoss, formatGainLossAmount, formatGainLossPercent helpers, GainLossCell component, Gain/Loss table header and cell
- **Learnings for future iterations:**
  - GainLossCell follows same pattern as PriceCell and MarketValueCell for loading/error states
  - Gain/Loss column added after Market Value column for tradeable holdings
  - calculateGainLoss returns null if marketValue is null, costBasis is null, or costBasis is 0
  - formatGainLossAmount uses absolute value and adds sign prefix (+/-) for display
  - Green (text-green-400) for gains, red (text-red-400) for losses - consistent color scheme
  - Browser verification shows 401 for API calls when not authenticated - this is expected behavior
---
