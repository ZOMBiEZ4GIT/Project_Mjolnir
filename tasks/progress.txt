## Codebase Patterns
- Project uses Next.js 16+ App Router with TypeScript
- Drizzle ORM is already installed (`drizzle-orm`, `drizzle-kit`, `@neondatabase/serverless`)
- shadcn/ui components available in `components/ui`
- Dark mode only - no light mode support
- Quality checks: `npm run build` and `npm run lint`
- ESLint 9 with flat config format (eslint.config.mjs) - do not use .eslintrc.json
- Next.js 16 doesn't have `next lint` command - use `eslint .` directly

- Database module uses lazy initialization via Proxy to avoid build-time errors when DATABASE_URL is not set
- Use `sql` template tag from drizzle-orm for raw SQL queries with `db.execute(sql\`...\`)`
- ClerkProvider conditionally renders based on NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY to allow builds without Clerk keys
- Use `export const dynamic = "force-dynamic"` for pages/layouts that use Clerk components
- Dashboard routes at `/dashboard` and `/profile` are protected; landing page `/` is public
- Auth pages use `(auth)` route group; dashboard uses `(dashboard)` route group

- Drizzle migrations are stored in `drizzle/` directory and should be committed to git
- The holdings schema exists in `lib/db/schema.ts` with all required fields
- Transactions schema exists with action enum: BUY, SELL, DIVIDEND, SPLIT
- Snapshots and contributions schemas exist for super/cash/debt tracking

- TanStack Query provider is in `components/providers/query-provider.tsx` - wrap layouts with QueryProvider
- ClerkProvider wrapper is in `components/providers/clerk-provider.tsx` - handles missing Clerk keys gracefully
- Use `useAuthSafe` hook from `lib/hooks/use-auth-safe.ts` for client-side auth state that works with/without Clerk

- Toast notifications use Sonner - import `toast` from `sonner` and use `toast.success()` / `toast.error()`
- Toaster component is in root layout; for dark mode only, hardcode `theme="dark"` in Sonner component

- Dashboard navigation uses `components/dashboard/nav.tsx` with usePathname for active state
- Settings page exists at `/settings` for user preferences

- API patterns:
  - Use innerJoin with holdings to validate user ownership AND include holding info
  - Return 409 Conflict for duplicate prevention (unique constraint violations)
  - Return 400 with `{ errors: { field: "message" } }` for validation errors
  - Decimal fields from Drizzle come as strings, need Number() conversion for arithmetic
  - Multipart form data: use request.formData() to get files

- Existing holdings types: stock, etf, crypto, super, cash, debt
- Holdings have: symbol, name, currency (AUD/NZD/USD), exchange, is_dormant flag
- Transactions have: date, action (BUY/SELL/DIVIDEND/SPLIT), quantity, unit_price, fees, currency
- Snapshots have: date, balance, currency (for super/cash/debt)
- Contributions have: date, employer_contrib, employee_contrib (for super only)

- CSV Import format (from CLAUDE.md):
  - Transactions: date,symbol,action,quantity,unit_price,fees,currency,exchange,notes
  - Super Snapshots: date,fund_name,balance,employer_contrib,employee_contrib,currency
  - Import should be idempotent - re-running doesn't create duplicates

---

# W-11 Data Import Progress Log

Started: 2026-02-02

---

